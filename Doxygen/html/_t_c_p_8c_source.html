<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>EthKitTCP: C:/Users/mainuser/Desktop/School/SeniorProject/EthKitTCP/Microchip/TCPIP Stack/TCP.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">EthKitTCP
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_t_c_p_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">TCP.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_t_c_p_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*********************************************************************</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *  Transmission Control Protocol (TCP) Communications Layer</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *  Module for Microchip TCP/IP Stack</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *   -Provides reliable, handshaked transport of application stream </span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *    oriented data with flow control</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *   -Reference: RFC 793</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *********************************************************************</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * FileName:        TCP.c</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * Dependencies:    IP, Tick, Ethernet/WiFi (ENC28J60.c, ETH97J60.c, </span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *                  ENCX24J600.c, or WFMac.c), ARP (optional), </span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *                  DNS (optional)</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * Processor:       PIC18, PIC24F, PIC24H, dsPIC30F, dsPIC33F, PIC32</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * Compiler:        Microchip C32 v1.05 or higher</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *                  Microchip C30 v3.12 or higher</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *                  Microchip C18 v3.30 or higher</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *                  HI-TECH PICC-18 PRO 9.63PL2 or higher</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * Company:         Microchip Technology, Inc.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * Software License Agreement</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * Copyright (C) 2002-2009 Microchip Technology Inc.  All rights</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * reserved.</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * Microchip licenses to you the right to use, modify, copy, and</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * distribute:</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * (i)  the Software when embedded on a Microchip microcontroller or</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> *      digital signal controller product (&quot;Device&quot;) which is</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> *      integrated into Licensee&#39;s product; or</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> * (ii) ONLY the Software driver source files ENC28J60.c, ENC28J60.h,</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> *      ENCX24J600.c and ENCX24J600.h ported to a non-Microchip device</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"> *      used in conjunction with a Microchip ethernet controller for</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> *      the sole purpose of interfacing with the ethernet controller.</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"> * You should refer to the license agreement accompanying this</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> * Software for additional information regarding your rights and</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"> * obligations.</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"> * THE SOFTWARE AND DOCUMENTATION ARE PROVIDED &quot;AS IS&quot; WITHOUT</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"> * WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"> * LIMITATION, ANY WARRANTY OF MERCHANTABILITY, FITNESS FOR A</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"> * PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"> * MICROCHIP BE LIABLE FOR ANY INCIDENTAL, SPECIAL, INDIRECT OR</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"> * CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment"> * PROCUREMENT OF SUBSTITUTE GOODS, TECHNOLOGY OR SERVICES, ANY CLAIMS</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"> * BY THIRD PARTIES (INCLUDING BUT NOT LIMITED TO ANY DEFENSE</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment"> * THEREOF), ANY CLAIMS FOR INDEMNITY OR CONTRIBUTION, OR OTHER</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"> * SIMILAR COSTS, WHETHER ASSERTED ON THE BASIS OF CONTRACT, TORT</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"> * (INCLUDING NEGLIGENCE), BREACH OF WARRANTY, OR OTHERWISE.</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"> * Author               Date        Comment</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment"> *~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"> * Nilesh Rajbharti     5/8/01      Original        (Rev 1.0)</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment"> * Howard Schlunder     12/11/06    Changed almost everything to </span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment"> *                                  better meet RFC 793.</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment"> ********************************************************************/</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#define __TCP_C</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_i_p_8h.html">TCPIP Stack/TCPIP.h</a>&quot;</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#if defined(STACK_USE_TCP)</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">    Configuration Parameters</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">// Starting port for client sockets</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor">#define LOCAL_PORT_START_NUMBER (1024u)</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">// End port for client sockets</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="preprocessor">#define LOCAL_PORT_END_NUMBER   (5000u)</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">// For debugging only.  Normal applications should never enable these</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">//#define DEBUG_GENERATE_TX_LOSS        62257</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">//#define DEBUG_GENERATE_RX_LOSS        64225</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">// A lot of pointer dereference code can be removed if you </span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">// locally copy TCBStubs to an absolute memory location.</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">// If you define TCP_OPTIMIZE_FOR_SIZE, local caching will </span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">// occur and will substantially decrease the entire TCP ROM </span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">// footprint (up to 35%).  If you leave TCP_OPTIMIZE_FOR_SIZE </span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">// undefined, the local caching will be disabled.  On PIC18 </span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">// products, this will improve TCP performance/throughput by </span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment">// approximately 15%.</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="preprocessor">#define TCP_OPTIMIZE_FOR_SIZE</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment">// For smallest size and best throughput, TCP_OPTIMIZE_FOR_SIZE </span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">// should always be enabled on PIC24/dsPIC products.  On PIC32 </span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">// products there is very little difference and depnds on compiler </span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">// optimization level</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#if defined(__C30__) &amp;&amp; !defined(TCP_OPTIMIZE_FOR_SIZE)</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor">    #define TCP_OPTIMIZE_FOR_SIZE</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor">#elif defined(__C32__) &amp;&amp; defined(TCP_OPTIMIZE_FOR_SIZE)</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor">    #undef TCP_OPTIMIZE_FOR_SIZE</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">// TCP Maximum Segment Size for TX.  The TX maximum segment size is actually </span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">// govered by the remote node&#39;s MSS option advirtised during connection </span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">// establishment.  However, if the remote node specifies an unhandlably large </span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">// MSS (ex: &gt; Ethernet MTU), this define sets a hard limit so that we don&#39;t </span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">// cause any TX buffer overflows.  If the remote node does not advirtise a MSS </span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">// option, all TX segments are fixed at 536 bytes maximum.</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor">#define TCP_MAX_SEG_SIZE_TX         (1460u)</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">// TCP Maximum Segment Size for RX.  This value is advirtised during connection </span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">// establishment and the remote node should obey it.  This should be set to 536 </span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">// to avoid IP layer fragmentation from causing packet loss.  However, raising </span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">// its value can enhance performance at the (small) risk of introducing </span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">// incompatibility with certain special remote nodes (ex: ones connected via a </span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">// slow dial up modem).</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor">#define TCP_MAX_SEG_SIZE_RX         (536u)</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">// TCP Timeout and retransmit numbers</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor">#define TCP_START_TIMEOUT_VAL       ((DWORD)TICK_SECOND*1)  // Timeout to retransmit unacked data</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor">#define TCP_DELAYED_ACK_TIMEOUT     ((DWORD)TICK_SECOND/10) // Timeout for delayed-acknowledgement algorithm</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor">#define TCP_FIN_WAIT_2_TIMEOUT      ((DWORD)TICK_SECOND*5)  // Timeout for FIN WAIT 2 state</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor">#define TCP_KEEP_ALIVE_TIMEOUT      ((DWORD)TICK_SECOND*10) // Timeout for keep-alive messages when no traffic is sent</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="preprocessor">#define TCP_CLOSE_WAIT_TIMEOUT      ((DWORD)TICK_SECOND/5)  // Timeout for the CLOSE_WAIT state</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor">#define TCP_MAX_RETRIES             (5u)                    // Maximum number of retransmission attempts</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="preprocessor">#define TCP_MAX_UNACKED_KEEP_ALIVES (6u)                    // Maximum number of keep-alive messages that can be sent without receiving a response before automatically closing the connection</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="preprocessor">#define TCP_MAX_SYN_RETRIES         (2u)    // Smaller than all other retries to reduce SYN flood DoS duration</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor">#define TCP_AUTO_TRANSMIT_TIMEOUT_VAL   (TICK_SECOND/25ull) // Timeout before automatically transmitting unflushed data</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="preprocessor">#define TCP_WINDOW_UPDATE_TIMEOUT_VAL   (TICK_SECOND/5ull)  // Timeout before automatically transmitting a window update due to a TCPGet() or TCPGetArray() function call</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor">#define TCP_SYN_QUEUE_MAX_ENTRIES   (3u)                    // Number of TCP RX SYN packets to save if they cannot be serviced immediately</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="preprocessor">#define TCP_SYN_QUEUE_TIMEOUT       ((DWORD)TICK_SECOND*3)  // Timeout for when SYN queue entries are deleted if unserviceable</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">    TCP Header Data Types</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="preprocessor">#define FIN     (0x01)      // FIN Flag as defined in RFC</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="preprocessor">#define SYN     (0x02)      // SYN Flag as defined in RFC</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="preprocessor">#define RST     (0x04)      // Reset Flag as defined in RFC</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="preprocessor">#define PSH     (0x08)      // Push Flag as defined in RFC</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="preprocessor">#define ACK     (0x10)      // Acknowledge Flag as defined in RFC</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="preprocessor">#define URG     (0x20)      // Urgent Flag as defined in RFC</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">// TCP Header Data Structure</span></div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html">  144</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;{</div>
<div class="line"><a name="l00146"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">  146</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>    <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>;     <span class="comment">// Local port number</span></div>
<div class="line"><a name="l00147"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">  147</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>    <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>;       <span class="comment">// Remote port number</span></div>
<div class="line"><a name="l00148"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">  148</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>   <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">SeqNumber</a>;      <span class="comment">// Local sequence number</span></div>
<div class="line"><a name="l00149"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">  149</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>   <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">AckNumber</a>;      <span class="comment">// Acknowledging remote sequence number</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keyword">struct</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    {</div>
<div class="line"><a name="l00153"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a34c940d4eee891fd1a8ac0c77091d1cb">  153</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> Reserved3      : 4;</div>
<div class="line"><a name="l00154"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a5822b7000f077dc1e2f88a31a6b89a39">  154</a></span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_d_n_s_8c.html#a5ab8c2bf45b20b5f7aa3a4f083896cec">Val</a>            : 4;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    } DataOffset;           <span class="comment">// Data offset flags nibble</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keyword">union</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    {</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keyword">struct</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        {</div>
<div class="line"><a name="l00161"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a4c0716aec722475fec048a867446a066">  161</a></span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> flagFIN    : 1;</div>
<div class="line"><a name="l00162"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#ac97905e3cf7df764a184c7a69f7405aa">  162</a></span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> flagSYN    : 1;</div>
<div class="line"><a name="l00163"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a6bf85194e4e5b09cbdc6d6bfbd13de22">  163</a></span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> flagRST    : 1;</div>
<div class="line"><a name="l00164"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a5bc041bb51c7750ea2f2ac47b28bc81a">  164</a></span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> flagPSH    : 1;</div>
<div class="line"><a name="l00165"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a716ec7c86e4125e52da82ce99ab86b27">  165</a></span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> flagACK    : 1;</div>
<div class="line"><a name="l00166"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#ab708dd73bbe11d04ffa9f0d592c0a640">  166</a></span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> flagURG    : 1;</div>
<div class="line"><a name="l00167"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a3aa493a5900fd498852367362218363a">  167</a></span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> Reserved2  : 2;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        } <a class="code" href="_h_w_p___d_a210___b_r_d__16_p_m_p___a_r1020___v_g_av1_8h.html#a60e68f55ca3981fd4a8bfc3f0b6b444e">bits</a>;</div>
<div class="line"><a name="l00169"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a4ec262e8432e722273b67cea923f72a6">  169</a></span>&#160;        <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a4ec262e8432e722273b67cea923f72a6">byte</a>;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    } Flags;                <span class="comment">// TCP Flags as defined in RFC</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">  172</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>    <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a>;         <span class="comment">// Local free RX buffer window</span></div>
<div class="line"><a name="l00173"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a85011e0b7801556de62f34a465135806">  173</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>    <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a85011e0b7801556de62f34a465135806">Checksum</a>;       <span class="comment">// Data payload checksum</span></div>
<div class="line"><a name="l00174"></a><span class="lineno"><a class="line" href="struct_t_c_p___h_e_a_d_e_r.html#a17e1de1a82c0beee37397a59a7d8c812">  174</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>    <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a17e1de1a82c0beee37397a59a7d8c812">UrgentPointer</a>;  <span class="comment">// Urgent pointer</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;} <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="preprocessor">#define TCP_OPTIONS_END_OF_LIST     (0x00u)     // End of List TCP Option Flag</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="preprocessor">#define TCP_OPTIONS_NO_OP           (0x01u)     // No Op TCP Option</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="preprocessor">#define TCP_OPTIONS_MAX_SEG_SIZE    (0x02u)     // Maximum segment size TCP flag</span></div>
<div class="line"><a name="l00180"></a><span class="lineno"><a class="line" href="struct_t_c_p___o_p_t_i_o_n_s.html">  180</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;{</div>
<div class="line"><a name="l00182"></a><span class="lineno"><a class="line" href="struct_t_c_p___o_p_t_i_o_n_s.html#a7c46116cbd9a8db99e5d33283345e524">  182</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>        <a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html#a7c46116cbd9a8db99e5d33283345e524">Kind</a>;                           <span class="comment">// Type of option</span></div>
<div class="line"><a name="l00183"></a><span class="lineno"><a class="line" href="struct_t_c_p___o_p_t_i_o_n_s.html#ae875c7698e130ba8324b8746c3ef7a11">  183</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>        <a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html#ae875c7698e130ba8324b8746c3ef7a11">Length</a>;                         <span class="comment">// Length</span></div>
<div class="line"><a name="l00184"></a><span class="lineno"><a class="line" href="struct_t_c_p___o_p_t_i_o_n_s.html#a4414eab3a6c9ce2fa592d8917a143515">  184</a></span>&#160;    <a class="code" href="union_w_o_r_d___v_a_l.html">WORD_VAL</a>    <a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html#a4414eab3a6c9ce2fa592d8917a143515">MaxSegSize</a>;                     <span class="comment">// Maximum segment size</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;} <a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html">TCP_OPTIONS</a>;                                  <span class="comment">// TCP Options data structure                           </span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">// Structure containing all the important elements of an incomming </span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">// SYN packet in order to establish a connection at a future time </span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">// if all sockets on the listening port are already connected to </span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">// someone</span></div>
<div class="line"><a name="l00191"></a><span class="lineno"><a class="line" href="struct_t_c_p___s_y_n___q_u_e_u_e.html">  191</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;{</div>
<div class="line"><a name="l00193"></a><span class="lineno"><a class="line" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a86fb1c2f41cbd3136de2afa6497925f2">  193</a></span>&#160;    <a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>   <a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a86fb1c2f41cbd3136de2afa6497925f2">niSourceAddress</a>;<span class="comment">// Remote IP address and MAC address</span></div>
<div class="line"><a name="l00194"></a><span class="lineno"><a class="line" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ad129842efc936a38e329384496850daf">  194</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>        <a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ad129842efc936a38e329384496850daf">wSourcePort</a>;    <span class="comment">// Remote TCP port number that the response SYN needs to be sent to</span></div>
<div class="line"><a name="l00195"></a><span class="lineno"><a class="line" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ab040df9bb3ca4da90ebc0b1b59a6a618">  195</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>       <a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ab040df9bb3ca4da90ebc0b1b59a6a618">dwSourceSEQ</a>;    <span class="comment">// Remote TCP SEQuence number that must be ACKnowledged when we send our response SYN</span></div>
<div class="line"><a name="l00196"></a><span class="lineno"><a class="line" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a4a73e1502cba148db181af196cdf145a">  196</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>        <a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a4a73e1502cba148db181af196cdf145a">wDestPort</a>;      <span class="comment">// Local TCP port which the original SYN was destined for</span></div>
<div class="line"><a name="l00197"></a><span class="lineno"><a class="line" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a0aa09af9f70a0f4959f9d8949c04df35">  197</a></span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>        <a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a0aa09af9f70a0f4959f9d8949c04df35">wTimestamp</a>;     <span class="comment">// Timer to expire old SYN packets that can&#39;t be serviced at all</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;} <a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html">TCP_SYN_QUEUE</a>;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="preprocessor">#if defined(STACK_CLIENT_MODE)</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keyword">static</span> <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> NextPort <a class="code" href="_primitive_8h.html#a1c10ed14df5c73a75600b57743a24f38">__attribute__</a>((persistent));   <span class="comment">// Tracking variable for next local client port number</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">    TCB Definitions</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">// Determines the number of defined TCP sockets</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="preprocessor">#define TCP_SOCKET_COUNT    (sizeof(TCPSocketInitializer)/sizeof(TCPSocketInitializer[0]))</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="preprocessor">#if defined(HI_TECH_C)</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="comment">// The initializer forces this large array out of the bss section </span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="comment">// so we can link correctly.</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="preprocessor">    #pragma psect bigdata=TCB_uRAM_BIG</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor">    #pragma psect data=TCB_uRAM</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keyword">static</span> <a class="code" href="struct_t_c_b___s_t_u_b.html">TCB_STUB</a> TCBStubs[TCP_SOCKET_COUNT] = {<span class="charliteral">&#39;\0&#39;</span>};    </div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor">    #pragma psect data=ordinary_data_sect</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="preprocessor">    #pragma psect bigdata=ordinary_data_sect_big</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="comment">// The TCB array is very large.  With the C18 compiler, one must </span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">// modify the linker script to make an array that spans more than </span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="comment">// one memory bank.  To do this, make the necessary changes to your </span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="comment">// processor&#39;s linker script (.lkr).  Here is an example showing </span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="comment">// gpr11 and 128 bytes of gpr12 being combined into one 384 byte </span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment">// block used exclusively by the TCB_uRAM data section:</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="comment">// ...</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="comment">// //DATABANK   NAME=gpr11      START=0xB00          END=0xBFF</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="comment">// //DATABANK   NAME=gpr12      START=0xC00          END=0xCFF</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="comment">// DATABANK   NAME=gpr11b     START=0xB00          END=0xC7F           PROTECTED</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="comment">// DATABANK   NAME=gpr12      START=0xC80          END=0xCFF</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="comment">// ...</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="comment">// SECTION    NAME=TCB_uRAM    RAM=gpr11b</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="comment">// ...</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="preprocessor">    #if defined(__18CXX) &amp;&amp; !defined(HI_TECH_C) </span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="preprocessor">        #pragma udata TCB_uRAM</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keyword">static</span> <a class="code" href="struct_t_c_b___s_t_u_b.html">TCB_STUB</a> TCBStubs[TCP_SOCKET_COUNT];</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="preprocessor">    #if defined(__18CXX) &amp;&amp; !defined(HI_TECH_C) </span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="preprocessor">        #pragma udata                   // Return to any other RAM section</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="keyword">static</span> <a class="code" href="struct_t_c_b.html">TCB</a> MyTCB;                                   <span class="comment">// Currently loaded TCB</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="keyword">static</span> <a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hCurrentTCP = INVALID_SOCKET;     <span class="comment">// Current TCP socket</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="preprocessor">#if TCP_SYN_QUEUE_MAX_ENTRIES</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="preprocessor">    #if defined(__18CXX) &amp;&amp; !defined(HI_TECH_C) </span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="preprocessor">        #pragma udata SYN_QUEUE_RAM_SECT</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keyword">static</span> <a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html">TCP_SYN_QUEUE</a> SYNQueue[TCP_SYN_QUEUE_MAX_ENTRIES];   <span class="comment">// Array of saved incoming SYN requests that need to be serviced later</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="preprocessor">    #if defined(__18CXX) &amp;&amp; !defined(HI_TECH_C) </span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor">        #pragma udata</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">    Function Prototypes</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> TCPRAMCopy(PTR_BASE wDest, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vDestType, PTR_BASE wSource, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vSourceType, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLength);</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor">#if defined(__18CXX)</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span> TCPRAMCopyROM(PTR_BASE wDest, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> wDestType, ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* wSource, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLength);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="preprocessor">    #define TCPRAMCopyROM(a,b,c,d)  TCPRAMCopy(a,b,c,TCP_PIC_RAM,d)</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> SendTCP(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vTCPFlags, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vSendFlags);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> HandleTCPSeg(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>* h, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="keyword">static</span> <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> FindMatchingSocket(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>* h, <a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>* remote);</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> SwapTCPHeader(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>* header);</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> CloseSocket(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> SyncTCB(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">#if defined(WF_CS_TRIS)</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<a class="code" href="_generic_type_defs_8h.html#acfa284fa8026c4aace2728f7f15d6c13">UINT16</a> <a class="code" href="_t_c_p_8c.html#a33d9392f2c2945d2abd90efcf0327a9a">WFGetTCBSize</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">// Indicates if this packet is a retransmission (no reset) or a new packet (reset required)</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="preprocessor">#define SENDTCP_RESET_TIMERS    0x01</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">// Instead of transmitting normal data, a garbage octet is transmitted according to RFC 1122 section 4.2.3.6</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="preprocessor">#define SENDTCP_KEEP_ALIVE      0x02</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">    TCB Optimization Configuration</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor">#if defined(TCP_OPTIMIZE_FOR_SIZE)</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keyword">static</span> <a class="code" href="struct_t_c_b___s_t_u_b.html">TCB_STUB</a> MyTCBStub;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="comment">// Flushes MyTCBStub cache and loads up the specified TCB_STUB.</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="comment">// Does nothing on cache hit.</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span> SyncTCBStub(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    {</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">if</span>(hCurrentTCP == hTCP)</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <span class="keywordflow">if</span>(hCurrentTCP != INVALID_SOCKET)</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        {</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            <span class="comment">// Save the current TCB stub</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            memcpy((<span class="keywordtype">void</span>*)&amp;TCBStubs[hCurrentTCP], (<span class="keywordtype">void</span>*)&amp;MyTCBStub, <span class="keyword">sizeof</span>(MyTCBStub));</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    </div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        hCurrentTCP = hTCP;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    </div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <span class="keywordflow">if</span>(hTCP == INVALID_SOCKET)</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    </div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="comment">// Load up the new TCB stub</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        memcpy((<span class="keywordtype">void</span>*)&amp;MyTCBStub, (<span class="keywordtype">void</span>*)&amp;TCBStubs[hTCP], <span class="keyword">sizeof</span>(MyTCBStub));</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    }</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="comment">// Flushes MyTCBStub cache and loads up the specified TCB_STUB.</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="comment">// Does nothing on cache hit.</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="preprocessor">    #define SyncTCBStub(a)  hCurrentTCP = (a)</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="comment">// Alias to current TCP stub.</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="preprocessor">    #define MyTCBStub       TCBStubs[hCurrentTCP]</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">// Flushes MyTCB cache and loads up the specified TCB.</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">// Does nothing on cache hit.</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> SyncTCB(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;{</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <span class="keyword">static</span> <a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hLastTCB = INVALID_SOCKET;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    </div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="keywordflow">if</span>(hLastTCB == hCurrentTCP)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">if</span>(hLastTCB != INVALID_SOCKET)</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    {</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="comment">// Save the current TCB</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        TCPRAMCopy(TCBStubs[hLastTCB].bufferTxStart - <span class="keyword">sizeof</span>(MyTCB), TCBStubs[hLastTCB].<a class="code" href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)&amp;MyTCB, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, <span class="keyword">sizeof</span>(MyTCB));</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    }</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="comment">// Load up the new TCB</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    hLastTCB = hCurrentTCP;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    TCPRAMCopy((PTR_BASE)&amp;MyTCB, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> - <span class="keyword">sizeof</span>(MyTCB), MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, <span class="keyword">sizeof</span>(MyTCB));</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;}</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">    void TCPInit(void)</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">    Initializes the TCP module.</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">    Initializes the TCP module.  This function sets up the TCP buffers</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">    in memory and initializes each socket to the CLOSED state.  If</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">    insufficient memory was allocated for the TCP sockets, the function</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">    will hang here to be captured by the debugger.</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">    This function is called only one during lifetime of the application.</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00373"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#aa14ab130bfd7824b97f571fe55139fc4">  373</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#aa14ab130bfd7824b97f571fe55139fc4">TCPInit</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;{</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vSocketsAllocated;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wTXSize, wRXSize;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    PTR_BASE ptrBaseAddress;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vMedium;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="preprocessor">    #if TCP_ETH_RAM_SIZE &gt; 0</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wCurrentETHAddress = <a class="code" href="_t_c_p_i_p_8h.html#a210df6a3fb94c11b62f4b9ee7e6e72a9">TCP_ETH_RAM_BASE_ADDRESS</a>;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="preprocessor">    #if TCP_PIC_RAM_SIZE &gt; 0</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    PTR_BASE ptrCurrentPICAddress = <a class="code" href="_t_c_p_i_p_8h.html#a14d76c6ef5cd97ad5de2b01c9cc7b3f4">TCP_PIC_RAM_BASE_ADDRESS</a>;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="preprocessor">    #if TCP_SPI_RAM_SIZE &gt; 0</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wCurrentSPIAddress = <a class="code" href="_t_c_p_i_p_01_e_n_c28_01_d_a210___b_r_d_8h.html#a841035370aaee6b505191c8c2a1da56c">TCP_SPI_RAM_BASE_ADDRESS</a>;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="preprocessor">    #if defined(STACK_CLIENT_MODE)</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="comment">// Initialize NextPort to a random value if it is zero (such as after </span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        <span class="comment">// reset on a PIC32 or PIC18 when the static memory initializer is </span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        <span class="comment">// used).  By starting with a random number, we decrease the risk of </span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <span class="comment">// reusing a port number that was previously used if the user power </span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="comment">// cycles the device.</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        <span class="keywordflow">if</span>(NextPort == 0u)</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            NextPort = (((<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_helpers_8h.html#ab9a87e9fa459e39748e35e7b700077ed">GenerateRandomDWORD</a>()) &amp; 0x07FFu) + LOCAL_PORT_START_NUMBER;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="comment">// Mark all SYN Queue entries as invalid by zeroing the memory</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="preprocessor">    #if TCP_SYN_QUEUE_MAX_ENTRIES</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        memset((<span class="keywordtype">void</span>*)SYNQueue, 0x00, <span class="keyword">sizeof</span>(SYNQueue));</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    </div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="comment">// Allocate all socket FIFO addresses</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    vSocketsAllocated = 0;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; TCP_SOCKET_COUNT; i++)</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    {</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        <span class="comment">// Generate all needed sockets of each type (TCP_PURPOSE_*)</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        SyncTCBStub(i);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        vMedium = <a class="code" href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a8e5ea682fe826546a050c00665a5061a">TCPSocketInitializer</a>[i].vMemoryMedium;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        wTXSize = <a class="code" href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a8e5ea682fe826546a050c00665a5061a">TCPSocketInitializer</a>[i].wTXBufferSize;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        wRXSize = <a class="code" href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a8e5ea682fe826546a050c00665a5061a">TCPSocketInitializer</a>[i].wRXBufferSize;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    </div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="keywordflow">switch</span>(vMedium)</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        {</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="preprocessor">            #if TCP_ETH_RAM_SIZE &gt; 0</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>:</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                ptrBaseAddress = wCurrentETHAddress;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                wCurrentETHAddress += <span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_b.html">TCB</a>) + wTXSize+1 + wRXSize+1;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                <span class="comment">// Do a sanity check to ensure that we aren&#39;t going to use memory that hasn&#39;t been allocated to us.</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                <span class="comment">// If your code locks up right here, it means you&#39;ve incorrectly allocated your TCP socket buffers in TCPIPConfig.h.  See the TCP memory allocation section.  More RAM needs to be allocated to the base memory mediums, or the individual sockets TX and RX FIFOS and socket quantiy needs to be shrunken.</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="preprocessor">#if defined(WF_CS_TRIS)</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                <span class="keywordflow">while</span>(wCurrentETHAddress &gt; <a class="code" href="_t_c_p_i_p_8h.html#a210df6a3fb94c11b62f4b9ee7e6e72a9">TCP_ETH_RAM_BASE_ADDRESS</a> + <a class="code" href="_t_c_p_8c.html#a33d9392f2c2945d2abd90efcf0327a9a">WFGetTCBSize</a>()<span class="comment">/*TCP_ETH_RAM_SIZE*/</span>);</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                <span class="keywordflow">while</span>(wCurrentETHAddress &gt; <a class="code" href="_t_c_p_i_p_8h.html#a210df6a3fb94c11b62f4b9ee7e6e72a9">TCP_ETH_RAM_BASE_ADDRESS</a> + <a class="code" href="_t_c_p_i_p_8h.html#a4f92c3804a4603ec0778b98834764851">TCP_ETH_RAM_SIZE</a>);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                </div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="preprocessor">            #if TCP_PIC_RAM_SIZE &gt; 0</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>:</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                ptrBaseAddress = ptrCurrentPICAddress;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                ptrCurrentPICAddress += <span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_b.html">TCB</a>) + wTXSize+1 + wRXSize+1;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                <span class="comment">// Do a sanity check to ensure that we aren&#39;t going to use memory that hasn&#39;t been allocated to us.</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                <span class="comment">// If your code locks up right here, it means you&#39;ve incorrectly allocated your TCP socket buffers in TCPIPConfig.h.  See the TCP memory allocation section.  More RAM needs to be allocated to the base memory mediums, or the individual sockets TX and RX FIFOS and socket quantiy needs to be shrunken.</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                <span class="keywordflow">while</span>(ptrCurrentPICAddress &gt; <a class="code" href="_t_c_p_i_p_8h.html#a14d76c6ef5cd97ad5de2b01c9cc7b3f4">TCP_PIC_RAM_BASE_ADDRESS</a> + <a class="code" href="_t_c_p_i_p_8h.html#ac286b416939941cfc8ae4212a92e16e4">TCP_PIC_RAM_SIZE</a>);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                </div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="preprocessor">            #if TCP_SPI_RAM_SIZE &gt; 0</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#aba628f222575a1aeed0f684edb39351b">TCP_SPI_RAM</a>:</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                ptrBaseAddress = wCurrentSPIAddress;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                wCurrentSPIAddress += <span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_b.html">TCB</a>) + wTXSize+1 + wRXSize+1;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                <span class="comment">// Do a sanity check to ensure that we aren&#39;t going to use memory that hasn&#39;t been allocated to us.</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                <span class="comment">// If your code locks up right here, it means you&#39;ve incorrectly allocated your TCP socket buffers in TCPIPConfig.h.  See the TCP memory allocation section.  More RAM needs to be allocated to the base memory mediums, or the individual sockets TX and RX FIFOS and socket quantiy needs to be shrunken.</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                <span class="keywordflow">while</span>(wCurrentSPIAddress &gt; <a class="code" href="_t_c_p_i_p_01_e_n_c28_01_d_a210___b_r_d_8h.html#a841035370aaee6b505191c8c2a1da56c">TCP_SPI_RAM_BASE_ADDRESS</a> + <a class="code" href="_t_c_p_i_p_8h.html#a75b511078d49e6f61adc139aec3e6a74">TCP_SPI_RAM_SIZE</a>);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                <span class="keywordflow">while</span>(1); <span class="comment">// Undefined allocation medium.  Go fix your TCPIPConfig.h TCP memory allocations.</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        }</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    </div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a> = vMedium;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> = ptrBaseAddress + <span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_b.html">TCB</a>);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> + wTXSize + 1;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>     = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + wRXSize;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a>       = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a680a81a7e7676aef8d747d1e06610633">TCP_CLOSED</a>;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">bServer</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="preprocessor">        #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> = SSL_INVALID_ID;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="preprocessor">        #endif      </span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        SyncTCB();</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        MyTCB.<a class="code" href="struct_t_c_b.html#a2c590b42dac0ddfc5ec2e193261815c5">vSocketPurpose</a> = <a class="code" href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a8e5ea682fe826546a050c00665a5061a">TCPSocketInitializer</a>[i].vSocketPurpose;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        CloseSocket();</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    }</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;}</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="comment">    Connection Management Functions</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">    TCP_SOCKET TCPOpen(DWORD dwRemoteHost, BYTE vRemoteHostType, WORD wPort, BYTE vSocketPurpose)</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="comment">    Opens a TCP socket for listening or as a client.</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="comment">    Provides a unified method for opening TCP sockets. This function can</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;<span class="comment">    open both client and server sockets. For client sockets, it can accept</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="comment">    a host name string to query in DNS, an IP address as a string, an IP</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="comment">    address in binary form, or a previously resolved NODE_INFO structure</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment">    containing the remote IP address and associated MAC address. When a</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="comment">    host name or IP address only is provided, the TCP module will</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment">    internally perform the necessary DNS and/or ARP resolution steps before</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">    reporting that the TCP socket is connected (via a call to</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">    TCPISConnected returning TRUE). Server sockets ignore this destination</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">    parameter and listen only on the indicated port.</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">    The vSocketPurpose field allows sockets to be opened with varying</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">    buffer size parameters and memory storage mediums. This field</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">    corresponds to pre-defined sockets allocated in the</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">    TCPSocketInitializer[] array in TCPIPConfig.h. The TCPIPConfig.h file</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="comment">    can be edited using the TCP/IP Configuration Wizard.</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">    Sockets are statically allocated on boot, but can be claimed with this</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">    \function and freed using TCPDisconnect or TCPClose (for client</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">    sockets). Server sockets can be freed using TCPClose only (calls to</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="comment">    TCPDisconnect will return server sockets to the listening state,</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="comment">    allowing reuse).</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">  Conditions:</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">  Input:</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">    dwRemoteHost -     For client sockets only. Provide a pointer to a</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">                       null\-terminated string of the remote host name (ex\:</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">                       &quot;www.microchip.com&quot; or &quot;192.168.1.123&quot;), a literal</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">                       destination IP address (ex\: 0x7B01A8C0 or an IP_ADDR</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">                       data type), or a pointer to a NODE_INFO structure</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">                       with the remote IP address and remote node or gateway</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment">                       MAC address specified. If a string is provided, note</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">                       that it must be statically allocated in memory and</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment">                       cannot be modified or deallocated until</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="comment">                       TCPIsConnected returns TRUE.&lt;p /&gt;This parameter is</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment">                       ignored for server sockets.</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">    vRemoteHostType -  Any one of the following flags to identify the</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">                       meaning of the dwRemoteHost parameter\:</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment">                       * TCP_OPEN_SERVER &amp;#45; Open a server socket and</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">                         ignore the dwRemoteHost parameter.</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">                       * TCP_OPEN_RAM_HOST &amp;#45; Open a client socket and</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">                         connect it to a remote host who&#39;s name is stored as a</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">                         null terminated string in a RAM array. Ex\:</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment">                         &quot;www.microchip.com&quot; or &quot;192.168.0.123&quot; (BYTE&amp;#42;</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">                         type)</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment">                       * TCP_OPEN_ROM_HOST &amp;#45; Open a client socket and</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="comment">                         connect it to a remote host who&#39;s name is stored as a</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="comment">                         null terminated string in a literal string or ROM</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="comment">                         array. Ex\: &quot;www.microchip.com&quot; or &quot;192.168.0.123&quot;</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="comment">                         (ROM BYTE&amp;#42; type)</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment">                       * TCP_OPEN_IP_ADDRESS &amp;#45; Open a client socket and</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment">                         connect it to a remote IP address. Ex\: 0x7B01A8C0</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment">                         for 192.168.1.123 (DWORD type). Note that the byte</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">                         ordering is big endian.</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment">                       * TCP_OPEN_NODE_INFO &amp;#45; Open a client socket and</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">                         connect it to a remote IP and MAC addresses pair</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">                         stored in a NODE_INFO structure. dwRemoteHost must be</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">                         a pointer to the NODE_INFO structure. This option is</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">                         provided for backwards compatibility with</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">                         applications built against prior stack versions that</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">                         only implemented the TCPConnect() function. It can</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">                         also be used to skip DNS and ARP resolution steps if</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment">                         connecting to a remote node which you&#39;ve already</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">                         connected to and have cached addresses for.</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">    wPort -            TCP port to listen on or connect to\:</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">                       * Client sockets &amp;#45; the remote TCP port to which a</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">                         connection should be made. The local port for client</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment">                         sockets will be automatically picked by the TCP</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">                         module.</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment">                       * Server sockets &amp;#45; the local TCP port on which to</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">                         listen for connections.</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">    vSocketPurpose -   Any of the TCP_PURPOSE_* constants defined in</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment">                       TCPIPConfig.h or the TCPIPConfig utility (see</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">                       TCPSocketInitializer[] array).</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="comment">    INVALID_SOCKET -  No sockets of the specified type were available to be</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment">                      opened.</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="comment">    Otherwise -       A TCP_SOCKET handle. Save this handle and use it when</span></div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="comment">                      calling all other TCP APIs.</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;<span class="comment">    This function replaces the old TCPConnect and TCPListen functions.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;<span class="comment">    If TCP_OPEN_RAM_HOST or TCP_OPEN_ROM_HOST are used for the destination</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="comment">    type, the DNS client module must also be enabled (STACK_USE_DNS must be</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="comment">    defined in TCPIPConfig.h).</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="comment">  Example:</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="comment">    \ \ </span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="comment">    &lt;code&gt;</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="comment">    // Open a server socket</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="comment">    skt = TCPOpen(NULL, TCP_OPEN_SERVER, HTTP_PORT, TCP_PURPOSE_HTTP_SERVER);</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment">    // Open a client socket to www.microchip.com</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">    // The double cast here prevents compiler warnings</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">    skt = TCPOpen((DWORD)(PTR_BASE)&quot;www.microchip.com&quot;,</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment">                    TCP_OPEN_ROM_HOST, 80, TCP_PURPOSE_DEFAULT);</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="comment">    // Reopen a client socket without repeating DNS or ARP</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="comment">    SOCKET_INFO cache = TCPGetSocketInfo(skt);  // Call with the old socket</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">    skt = TCPOpen((DWORD)(PTR_BASE)&amp;amp;cache.remote, TCP_OPEN_NODE_INFO,</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment">                    cache.remotePort.Val, TCP_PURPOSE_DEFAULT);</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">    &lt;/code&gt;                                                    </span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">  *****************************************************************************/</span></div>
<div class="line"><a name="l00594"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a7b763068bda0dba69136cc2f9ed88aa9">  594</a></span>&#160;<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> <a class="code" href="_t_c_p_8c.html#a7b763068bda0dba69136cc2f9ed88aa9">TCPOpen</a>(<a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a> dwRemoteHost, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vRemoteHostType, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wPort, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a2c590b42dac0ddfc5ec2e193261815c5">vSocketPurpose</a>)</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;{</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="comment">// Find an available socket that matches the specified socket type</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="keywordflow">for</span>(hTCP = 0; hTCP &lt; TCP_SOCKET_COUNT; hTCP++)</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    {</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        SyncTCBStub(hTCP);</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="comment">// Sockets that are in use will be in a non-closed state</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> != <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a680a81a7e7676aef8d747d1e06610633">TCP_CLOSED</a>)</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        SyncTCB();</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <span class="comment">// See if this socket matches the desired type</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a2c590b42dac0ddfc5ec2e193261815c5">vSocketPurpose</a> != vSocketPurpose)</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        <span class="comment">// Start out assuming worst case Maximum Segment Size (changes when MSS </span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        <span class="comment">// option is received from remote node)</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a> = 536;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        <span class="comment">// See if this is a server socket</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="keywordflow">if</span>(vRemoteHostType == TCP_OPEN_SERVER)</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        {</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = wPort;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">bServer</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b">TCP_LISTEN</a>;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = wPort;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="preprocessor">            #if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = 0;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        }</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <span class="comment">// Handle all the client mode socket types</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        {</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="preprocessor">            #if defined(STACK_CLIENT_MODE)</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            {</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                <span class="comment">// Each new socket that is opened by this node, gets the </span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                <span class="comment">// next sequential local port number.</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                <span class="keywordflow">if</span>(NextPort &lt; LOCAL_PORT_START_NUMBER || NextPort &gt; LOCAL_PORT_END_NUMBER)</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                    NextPort = LOCAL_PORT_START_NUMBER;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                </div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                <span class="comment">// Set the non-zero TCB fields</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = NextPort++;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = wPort;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    </div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                <span class="comment">// Flag to start the DNS, ARP, SYN processes</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>();</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a> = 1;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    </div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                <span class="keywordflow">switch</span>(vRemoteHostType)</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                {</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="preprocessor">                    #if defined(STACK_USE_DNS)</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                    <span class="keywordflow">case</span> TCP_OPEN_RAM_HOST:</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                    <span class="keywordflow">case</span> TCP_OPEN_ROM_HOST:</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a3f09cd8c9167b802029195c759770966">dwRemoteHost</a> = dwRemoteHost;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a85e50d5129c9eaec6e4729cb5aacf312">bRemoteHostIsROM</a> = (vRemoteHostType == TCP_OPEN_ROM_HOST);</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a576f183bc25360e18be55ca92f4b18bb">TCP_GET_DNS_MODULE</a>;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="preprocessor">                    #endif</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        </div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                    <span class="keywordflow">case</span> TCP_OPEN_IP_ADDRESS:</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                        <span class="comment">// dwRemoteHost is a literal IP address.  This </span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                        <span class="comment">// doesn&#39;t need DNS and can skip directly to the </span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                        <span class="comment">// Gateway ARPing step.</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = (((<a class="code" href="union_d_w_o_r_d___v_a_l.html">DWORD_VAL</a>*)&amp;dwRemoteHost)-&gt;w[1]+((<a class="code" href="union_d_w_o_r_d___v_a_l.html">DWORD_VAL</a>*)&amp;dwRemoteHost)-&gt;w[0] + wPort) ^ MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr.Val = dwRemoteHost;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> = 0;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a> = (TICK_SECOND/4)/256;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a18cd650b4f424753ccb3c7a5d3e317c6">TCP_GATEWAY_SEND_ARP</a>;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        </div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                    <span class="keywordflow">case</span> TCP_OPEN_NODE_INFO:</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = (((<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>*)(PTR_BASE)dwRemoteHost)-&gt;IPAddr.w[1]+((<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>*)(PTR_BASE)dwRemoteHost)-&gt;IPAddr.w[0] + wPort) ^ MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                        memcpy((<span class="keywordtype">void</span>*)(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>, (<span class="keywordtype">void</span>*)(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)(PTR_BASE)dwRemoteHost, <span class="keyword">sizeof</span>(<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>));</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a8d61cf0dd6dacc41f87a1ed05766365c">TCP_SYN_SENT</a>;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                        SendTCP(SYN, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                }</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;            }       </div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="preprocessor">            #else</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;            {</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                <span class="keywordflow">return</span> INVALID_SOCKET;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;            }   </div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        }</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        </div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        <span class="keywordflow">return</span> hTCP;        </div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    }</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="comment">// If there is no socket available, return error.</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keywordflow">return</span> INVALID_SOCKET;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;}</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment">    BOOL TCPWasReset(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="comment">    Self-clearing semaphore inidicating socket reset.</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="comment">    This function is a self-clearing semaphore indicating whether or not</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="comment">    a socket has been disconnected since the previous call.  This function</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="comment">    works for all possible disconnections: a call to TCPDisconnect, a FIN </span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="comment">    from the remote node, or an acknowledgement timeout caused by the loss</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="comment">    of a network link.  It also returns TRUE after the first call to TCPInit.</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment">    Applications should use this function to reset their state machines.</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="comment">    This function was added due to the possibility of an error when relying</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="comment">    on TCPIsConnected returing FALSE to check for a condition requiring a</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="comment">    state machine reset.  If a socket is closed (due to a FIN ACK) and then</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="comment">    immediately reopened (due to a the arrival of a new SYN) in the same</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="comment">    cycle of the stack, calls to TCPIsConnected by the application will </span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="comment">    never return FALSE even though the socket has been disconnected.  This </span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">    can cause errors for protocols such as HTTP in which a client will </span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="comment">    immediately open a new connection upon closing of a prior one.  Relying</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment">    on this function instead allows applications to trap those conditions </span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="comment">    and properly reset their internal state for the new connection.</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="comment">    hTCP - The socket to check.</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment">    TRUE - The socket has been disconnected since the previous call.</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="comment">    FALSE - The socket has not been disconnected since the previous call.</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00727"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ad66bc7b8521da8dc7e4d7768a8544705">  727</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#ad66bc7b8521da8dc7e4d7768a8544705">TCPWasReset</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;{</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    {</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    }</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    </div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    </div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a02643e9de8ceb55dd2a4669b53af4ba8">bSocketReset</a>)</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    {</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a02643e9de8ceb55dd2a4669b53af4ba8">bSocketReset</a> = 0;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    }   </div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;}</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment">    BOOL TCPIsConnected(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="comment">    Determines if a socket has an established connection.</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="comment">    This function determines if a socket has an established connection to </span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment">    a remote node.  Call this function after calling TCPOpen to determine </span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">    when the connection is set up and ready for use.  This function was </span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="comment">    historically used to check for disconnections, but TCPWasReset is now a</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="comment">    more appropriate solution. </span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="comment">    hTCP - The socket to check.</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="comment">    TRUE - The socket has an established connection to a remote node.</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="comment">    FALSE - The socket is not currently connected.</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment">    A socket is said to be connected only if it is in the TCP_ESTABLISHED</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="comment">    state.  Sockets in the process of opening or closing will return FALSE.</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00774"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#afd4cf67bce7972d9e528bc05bcabc226">  774</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#afd4cf67bce7972d9e528bc05bcabc226">TCPIsConnected</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;{</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    {</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    }</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    </div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keywordflow">return</span> (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>);</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;}</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="comment">    void TCPDisconnect(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="comment">    Disconnects an open socket.</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="comment">    This function closes a connection to a remote node by sending a FIN (if </span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="comment">    currently connected).</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="comment">    The function can be called a second time to force a socket closed by </span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="comment">    sending a RST packet.  This is useful when the application knows that </span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="comment">    the remote node will not send an ACK (if it has crashed or lost its link),</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="comment">    or when the application needs to reuse the socket immediately regardless</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="comment">    of whether or not the remote node would like to transmit more data before</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;<span class="comment">    closing.</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="comment">    For client mode sockets, upon return, the hTCP handle is relinquished to </span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="comment">    the TCP/IP stack and must no longer be used by the application (except for </span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="comment">    an immediate subsequent call to TCPDisconnect() to force a RST </span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="comment">    transmission, if needed).  </span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment">    For server mode sockets, upon return, the hTCP handle is NOT relinquished </span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment">    to the TCP/IP stack.  After closing, the socket returns to the listening </span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="comment">    state allowing future connection requests to be serviced.  This leaves the </span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="comment">    hTCP handle in a valid state and must be retained for future operations on </span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="comment">    the socket.  If you want to close the server and relinquish the socket back </span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="comment">    to the TCP/IP stack, call the TCPClose() API instead of TCPDisconnect().</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="comment">    hTCP - Handle of the socket to disconnect.</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="comment">    If the socket is using SSL, a CLOSE_NOTIFY record will be transmitted</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="comment">    first to allow the SSL session to be resumed at a later time.</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00829"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#aacb150778e6f5cf748b05b0e0568f30e">  829</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#aacb150778e6f5cf748b05b0e0568f30e">TCPDisconnect</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;{</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    {</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    }</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="comment">// Delete all data in the RX FIFO</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="comment">// In this stack&#39;s API, the application TCP handle is </span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="comment">// immediately invalid after calling this function, so there </span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="comment">// is no longer any way to receive data from the TCP RX FIFO, </span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="comment">// even though the data is still there.  Leaving the data there </span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="comment">// could interfere with the remote node sending us a FIN if our</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="comment">// RX window is zero</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="keywordflow">switch</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a>)</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    {</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="preprocessor">        #if defined(STACK_CLIENT_MODE) &amp;&amp; defined(STACK_USE_DNS)</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a979649935757125e531ffac76be1200c">TCP_DNS_RESOLVE</a>:</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            <a class="code" href="_d_n_s_8h.html#a27e8ba4b66a0d78061be23911cd3a426">DNSEndUsage</a>();  <span class="comment">// Release the DNS module, since the user is aborting</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;            CloseSocket();</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a576f183bc25360e18be55ca92f4b18bb">TCP_GET_DNS_MODULE</a>:</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a18cd650b4f424753ccb3c7a5d3e317c6">TCP_GATEWAY_SEND_ARP</a>:</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a246f53628bdda1bc5bd5bda6eaf30f8f">TCP_GATEWAY_GET_ARP</a>:</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a8d61cf0dd6dacc41f87a1ed05766365c">TCP_SYN_SENT</a>:</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;            CloseSocket();</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a>:</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>:</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="preprocessor">            #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;            <span class="comment">// When disconnecting SSL sockets, send a close_notify so we can resume later</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;            {</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                <span class="comment">// Flush pending data and send close_notify</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                <a class="code" href="_s_s_l_8h.html#a1cef416e587e77f9aeda9fbe53edf3ed">SSLTxRecord</a>(hTCP, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a>, SSL_APPLICATION);</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                <a class="code" href="_s_s_l_8h.html#ae047f0c0ce6b7f6cdc5fe8098bfef8ee">SSLTxMessage</a>(hTCP, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a>, <a class="code" href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3ca1d5e4083969a5ab893f0405a6a51770d">SSL_ALERT_CLOSE_NOTIFY</a>);</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            }</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;            <span class="comment">// Send the FIN.  This is done in a loop to ensure that if we have </span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;            <span class="comment">// more data wating in the TX FIFO than can be sent in a single </span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;            <span class="comment">// packet (due to the remote Max Segment Size packet size limit), </span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;            <span class="comment">// we will keep generating more packets until either all data gets </span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            <span class="comment">// transmitted or the remote node&#39;s receive window fills up.</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;            <span class="keywordflow">do</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;            {</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                SendTCP(FIN | ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> == 0u)</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;            } <span class="keywordflow">while</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> != MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>);</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;            </div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a>;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a>:</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            <span class="comment">// Send the FIN.  This is done in a loop to ensure that if we have </span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;            <span class="comment">// more data wating in the TX FIFO than can be sent in a single </span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            <span class="comment">// packet (due to the remote Max Segment Size packet size limit), </span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            <span class="comment">// we will keep generating more packets until either all data gets </span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;            <span class="comment">// transmitted or the remote node&#39;s receive window fills up.</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;            <span class="keywordflow">do</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            {</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                SendTCP(FIN | ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> == 0u)</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;            } <span class="keywordflow">while</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> != MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>);</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a>;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;            </div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <span class="comment">// These states are all already closed or don&#39;t need explicit disconnecting -- they will disconnect by themselves after a while</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        <span class="comment">//case TCP_CLOSED:</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="comment">//case TCP_LISTEN:</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        <span class="comment">//case TCP_CLOSING:</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        <span class="comment">//case TCP_TIME_WAIT:</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        <span class="comment">//  return;</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47af36788cc35b87e60aad61c78a8af296e">TCP_CLOSED_BUT_RESERVED</a>:</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a680a81a7e7676aef8d747d1e06610633">TCP_CLOSED</a>;</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        <span class="comment">// These states will close themselves after some delay, however, </span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        <span class="comment">// this is handled so that the user can call TCPDisconnect() </span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        <span class="comment">// twice to immediately close a socket (using an RST) without </span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <span class="comment">// having to get an ACK back from the remote node.  This is </span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        <span class="comment">// great for instance when the application determines that </span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <span class="comment">// the remote node has been physically disconnected and </span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        <span class="comment">// already knows that no ACK will be returned.  Alternatively, </span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        <span class="comment">// if the application needs to immediately reuse the socket </span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        <span class="comment">// regardless of what the other node&#39;s state is in (half open).</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a>:</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c">TCP_FIN_WAIT_2</a>:</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a>:</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;            SendTCP(RST | ACK, 0);</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;            CloseSocket();</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    }</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;}</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="comment">    void TCPClose(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">    Disconnects an open socket and destroys the socket handle, including server </span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="comment">    mode socket handles.</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="comment">    Disconnects an open socket and destroys the socket handle, including server </span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="comment">    mode socket handles.  This function performs identically to the </span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;<span class="comment">    TCPDisconnect() function, except that both client and server mode socket </span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="comment">    handles are relinquished to the TCP/IP stack upon return.</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="comment">    hTCP - Handle to the socket to disconnect and close.</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00960"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a503025d07797068adaf6e8032f6bda5e">  960</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#a503025d07797068adaf6e8032f6bda5e">TCPClose</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;{</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    {</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    }</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    </div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">bServer</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <a class="code" href="_t_c_p_8c.html#aacb150778e6f5cf748b05b0e0568f30e">TCPDisconnect</a>(hTCP);</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;}</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="comment">    SOCKET_INFO* TCPGetRemoteInfo(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="comment">    Obtains information about a currently open socket.</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="comment">    Returns the SOCKET_INFO structure associated with this socket.  This </span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="comment">    contains the NODE_INFO structure with IP and MAC address (or gateway</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="comment">    MAC) and the remote port.</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="comment">    TCP is initialized and the socket is connected.</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">    hTCP - The socket to check.</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="comment">    The SOCKET_INFO structure associated with this socket.  This structure is </span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">    allocated statically by the function and is valid only until the next </span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="comment">    time TCPGetRemoteInfo() is called.</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l00996"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a4b71a76cf1da559ef10b5f3f4cc87794">  996</a></span>&#160;<a class="code" href="struct_s_o_c_k_e_t___i_n_f_o.html">SOCKET_INFO</a>* <a class="code" href="_t_c_p_8c.html#a4b71a76cf1da559ef10b5f3f4cc87794">TCPGetRemoteInfo</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;{</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="keyword">static</span> <a class="code" href="struct_s_o_c_k_e_t___i_n_f_o.html">SOCKET_INFO</a>  RemoteInfo;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    }</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    </div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    SyncTCB();</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    memcpy((<span class="keywordtype">void</span>*)&amp;RemoteInfo.<a class="code" href="struct_s_o_c_k_e_t___i_n_f_o.html#aa1e86fd8c2b12224dd8ccaeb34555171">remote</a>, (<span class="keywordtype">void</span>*)&amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>, <span class="keyword">sizeof</span>(<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>));</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    RemoteInfo.<a class="code" href="struct_s_o_c_k_e_t___i_n_f_o.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="keywordflow">return</span> &amp;RemoteInfo;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;}</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;<span class="comment">    Transmit Functions</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="comment">    void TCPFlush(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="comment">    Immediately transmits all pending TX data.</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;<span class="comment">    This function immediately transmits all pending TX data with a PSH </span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;<span class="comment">    flag.  If this function is not called, data will automatically be sent</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;<span class="comment">    when either a) the TX buffer is half full or b) the </span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="comment">    TCP_AUTO_TRANSMIT_TIMEOUT_VAL (default: 40ms) has elapsed.</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="comment">    TCP is initialized and the socket is connected.</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="comment">    hTCP - The socket whose data is to be transmitted.</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">    SSL application data is automatically flushed, so this function has </span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment">    no effect for SSL sockets.</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b"> 1046</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;{</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    {</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    }</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    </div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;    SyncTCB();</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    <span class="comment">// NOTE: Pending SSL data will NOT be transferred here</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> != MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>)</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    {</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        <span class="comment">// Send the TCP segment with all unacked bytes</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;        SendTCP(ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;    }</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;}</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="comment">    WORD TCPIsPutReady(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="comment">    Determines how much free space is available in the TCP TX buffer.</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;<span class="comment">    Call this function to determine how many bytes can be written to the </span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="comment">    TCP TX buffer.  If this function returns zero, the application must </span></div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="comment">    return to the main stack loop before continuing in order to transmit</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="comment">    more data.</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="comment">    hTCP - The socket to check.</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment">    The number of bytes available to be written in the TCP TX buffer.</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a10e1123d9bd8d1d94a6b9e10c2e8176c"> 1088</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#a10e1123d9bd8d1d94a6b9e10c2e8176c">TCPIsPutReady</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;{</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    {</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    }</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    </div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    i = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a>;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="comment">// Unconnected sockets shouldn&#39;t be transmitting anything.</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;    <span class="keywordflow">if</span>(!( (i == (<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>)<a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>) || (i == (<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>)<a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a>) ))</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <span class="comment">// Calculate the free space in this socket&#39;s TX FIFO</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    {<span class="comment">// Use sslTxHead as the head pointer when SSL is active</span></div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> rem;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        </div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;        <span class="comment">// Find out raw free space</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>)</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;            rem = (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> - 1) - (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>);</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;            rem = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> - 1;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;            </div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        <span class="comment">// Reserve space for a new MAC and header</span></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        <span class="keywordflow">if</span>(rem &gt; 22u)</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            <span class="keywordflow">return</span> rem - 22;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    }</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    </div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>)</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        <span class="keywordflow">return</span> (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> - 1) - (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>);</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="keywordflow">return</span> MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> - 1;</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;}</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="comment">    BOOL TCPPut(TCP_SOCKET hTCP, BYTE byte)</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="comment">    Writes a single byte to a TCP socket.</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;<span class="comment">    hTCP - The socket to which data is to be written.</span></div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="comment">    byte - The byte to write.</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;<span class="comment">    TRUE - The byte was written to the transmit buffer.</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="comment">    FALSE - The transmit buffer was full, or the socket is not connected.</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a154886bc2d25d87f4ea5446ffd54d858"> 1150</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#a154886bc2d25d87f4ea5446ffd54d858">TCPPut</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> byte)</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;{</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wFreeTXSpace;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    {</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    }</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    </div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    wFreeTXSpace = <a class="code" href="_t_c_p_8c.html#a10e1123d9bd8d1d94a6b9e10c2e8176c">TCPIsPutReady</a>(hTCP);</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace == 0u)</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(wFreeTXSpace == 1u) <span class="comment">// About to run out of space, lets transmit so the remote node might send an ACK back faster</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP); </div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    <span class="comment">// Send all current bytes if we are crossing half full</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    <span class="comment">// This is required to improve performance with the delayed </span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    <span class="comment">// acknowledgement algorithm</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    <span class="keywordflow">if</span>((!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a>) &amp;&amp; (wFreeTXSpace &lt;= ((MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>)&gt;&gt;1)))</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    {</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP); </div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    }</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    {</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)&amp;byte, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, <span class="keyword">sizeof</span>(byte));</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    }</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    {</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)&amp;byte, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, <span class="keyword">sizeof</span>(byte));</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    }</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="preprocessor">    #else</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)&amp;byte, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, <span class="keyword">sizeof</span>(byte));</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    </div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    <span class="comment">// Send the last byte as a separate packet (likely will make the remote node send back ACK faster)</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace == 1u)</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    {</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP);</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    }</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    <span class="comment">// If not already enabled, start a timer so this data will </span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="comment">// eventually get sent even if the application doens&#39;t call</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    <span class="comment">// TCPFlush()</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a>)</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    {</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() + TCP_AUTO_TRANSMIT_TIMEOUT_VAL/256ull;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    }</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;}</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;<span class="comment">    WORD TCPPutArray(TCP_SOCKET hTCP, BYTE* data, WORD len)</span></div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="comment">    Writes an array from RAM to a TCP socket.</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="comment">    hTCP - The socket to which data is to be written.</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="comment">    data - Pointer to the array to be written.</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="comment">    len  - Number of bytes to be written.</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="comment">    The number of bytes written to the socket.  If less than len, the</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;<span class="comment">    buffer became full or the socket is not conected.</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#af1873020d1122b2f2c79e8c2f590fe19"> 1232</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#af1873020d1122b2f2c79e8c2f590fe19">TCPPutArray</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* data, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len)</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;{</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wActualLen;</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wFreeTXSpace;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wRightLen = 0;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    {</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    }</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    </div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    wFreeTXSpace = <a class="code" href="_t_c_p_8c.html#a10e1123d9bd8d1d94a6b9e10c2e8176c">TCPIsPutReady</a>(hTCP);</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace == 0u)</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    {</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP);</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    }</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    wActualLen = wFreeTXSpace;</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace &gt; len)</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        wActualLen = len;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <span class="comment">// Send all current bytes if we are crossing half full</span></div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="comment">// This is required to improve performance with the delayed </span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    <span class="comment">// acknowledgement algorithm</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <span class="keywordflow">if</span>((!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a>) &amp;&amp; (wFreeTXSpace &lt;= ((MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>)&gt;&gt;1)))</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    {</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP); </div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    }</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    </div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    {</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;        <span class="comment">// See if we need a two part put</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> + wActualLen &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;        {</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;            wRightLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;            TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)data, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wRightLen);</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;            data += wRightLen;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;            wActualLen -= wRightLen;</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;        }</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    </div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;        TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)data, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wActualLen);</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> += wActualLen;</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    }</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    {</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <span class="comment">// See if we need a two part put</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> + wActualLen &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        {</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;            wRightLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;            TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)data, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wRightLen);</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;            data += wRightLen;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;            wActualLen -= wRightLen;</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        }</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    </div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)data, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wActualLen);</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> += wActualLen;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    }</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<span class="preprocessor">    #else</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    <span class="comment">// See if we need a two part put</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> + wActualLen &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    {</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        wRightLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)data, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wRightLen);</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        data += wRightLen;</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;        wActualLen -= wRightLen;</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    }</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)data, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wActualLen);</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> += wActualLen;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    <span class="comment">// Send these bytes right now if we are out of TX buffer space</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace &lt;= len)</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;    {</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP);</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    }</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    <span class="comment">// If not already enabled, start a timer so this data will </span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;    <span class="comment">// eventually get sent even if the application doens&#39;t call</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;    <span class="comment">// TCPFlush()</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a>)</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    {</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() + TCP_AUTO_TRANSMIT_TIMEOUT_VAL/256ull;</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    }</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keywordflow">return</span> wActualLen + wRightLen;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;}</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;<span class="comment">    WORD TCPPutROMArray(TCP_SOCKET hTCP, ROM BYTE* data, WORD len)</span></div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;<span class="comment">    Writes an array from ROM to a TCP socket.</span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="comment">    hTCP - The socket to which data is to be written.</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;<span class="comment">    data - Pointer to the array to be written.</span></div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;<span class="comment">    len  - Number of bytes to be written.</span></div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;<span class="comment">    The number of bytes written to the socket.  If less than len, the</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;<span class="comment">    buffer became full or the socket is not conected.</span></div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;<span class="comment">    This function is aliased to TCPPutArray on non-PIC18 platforms.</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;<span class="preprocessor">#if defined(__18CXX)</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a78d22c72df366276a2ed1908e2337093"> 1351</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#a78d22c72df366276a2ed1908e2337093">TCPPutROMArray</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* data, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len)</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;{</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wActualLen;</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wFreeTXSpace;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wRightLen = 0;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    {</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;    }</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    </div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    wFreeTXSpace = <a class="code" href="_t_c_p_8c.html#a10e1123d9bd8d1d94a6b9e10c2e8176c">TCPIsPutReady</a>(hTCP);</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace == 0u)</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    {</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP);</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    }</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    <span class="comment">// Send all current bytes if we are crossing half full</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    <span class="comment">// This is required to improve performance with the delayed </span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="comment">// acknowledgement algorithm</span></div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    <span class="keywordflow">if</span>((!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a>) &amp;&amp; (wFreeTXSpace &lt;= ((MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>)&gt;&gt;1)))</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    {</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP); </div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    }</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    </div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    wActualLen = wFreeTXSpace;</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace &gt; len)</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;        wActualLen = len;</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    </div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    {</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <span class="comment">// See if we need a two part put</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> + wActualLen &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        {</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;            wRightLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>;</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            TCPRAMCopyROM(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, data, wRightLen);</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            data += wRightLen;</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;            wActualLen -= wRightLen;</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        }</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    </div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        TCPRAMCopyROM(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, data, wActualLen);</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> += wActualLen;</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    }</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    {</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        <span class="comment">// See if we need a two part put</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> + wActualLen &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        {</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;            wRightLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;            TCPRAMCopyROM(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, data, wRightLen);</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;            data += wRightLen;</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;            wActualLen -= wRightLen;</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        }</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    </div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        TCPRAMCopyROM(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, data, wActualLen);</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> += wActualLen;</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    }</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;<span class="preprocessor">    #else</span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <span class="comment">// See if we need a two part put</span></div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> + wActualLen &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;    {</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        wRightLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        TCPRAMCopyROM(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, data, wRightLen);</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        data += wRightLen;</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        wActualLen -= wRightLen;</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    }</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    TCPRAMCopyROM(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, data, wActualLen);</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> += wActualLen;</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    <span class="comment">// Send these bytes right now if we are out of TX buffer space</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    <span class="keywordflow">if</span>(wFreeTXSpace &lt;= len)</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    {</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP);</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    }</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    <span class="comment">// If not already enabled, start a timer so this data will </span></div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    <span class="comment">// eventually get sent even if the application doens&#39;t call</span></div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    <span class="comment">// TCPFlush()</span></div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a>)</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    {</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() + TCP_AUTO_TRANSMIT_TIMEOUT_VAL/256ull;</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    }</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    <span class="keywordflow">return</span> wActualLen + wRightLen;</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;}</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;<span class="comment">    BYTE* TCPPutString(TCP_SOCKET hTCP, BYTE* data)</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="comment">    Writes a null-terminated string from RAM to a TCP socket.  The </span></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;<span class="comment">    null-terminator is not copied to the socket.</span></div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="comment">    hTCP - The socket to which data is to be written.</span></div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;<span class="comment">    data - Pointer to the string to be written.</span></div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;<span class="comment">    Pointer to the byte following the last byte written to the socket.  If</span></div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;<span class="comment">    this pointer does not dereference to a NUL byte, the buffer became full</span></div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;<span class="comment">    or the socket is not connected.</span></div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="comment">    The return value of this function differs from that of TCPPutArray.  To</span></div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="comment">    write long strings in a single state, initialize the *data pointer to the</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;<span class="comment">    first byte, then call this function repeatedly (breaking to the main </span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;<span class="comment">    stack loop after each call) until the return value dereferences to a NUL</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="comment">    byte.  Save the return value as the new starting *data pointer otherwise.</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ae351c895eff77bbc9b231ee39dfdebe3"> 1475</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* <a class="code" href="_t_c_p_8c.html#ae351c895eff77bbc9b231ee39dfdebe3">TCPPutString</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* data)</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;{</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;    <span class="keywordflow">return</span> data + <a class="code" href="_t_c_p_8c.html#af1873020d1122b2f2c79e8c2f590fe19">TCPPutArray</a>(hTCP, data, strlen((<span class="keywordtype">char</span>*)data));</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;}</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="comment">    BYTE* TCPPutROMString(TCP_SOCKET hTCP, ROM BYTE* data)</span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;<span class="comment">    Writes a null-terminated string from ROM to a TCP socket.  The </span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;<span class="comment">    null-terminator is not copied to the socket.</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;<span class="comment">    hTCP - The socket to which data is to be written.</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;<span class="comment">    data - Pointer to the string to be written.</span></div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="comment">    Pointer to the byte following the last byte written to the socket.  If</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="comment">    this pointer does not dereference to a NUL byte, the buffer became full</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;<span class="comment">    or the socket is not connected.</span></div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;<span class="comment">    The return value of this function differs from that of TCPPutArray.  To</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;<span class="comment">    write long strings in a single state, initialize the *data pointer to the</span></div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;<span class="comment">    first byte, then call this function repeatedly (breaking to the main </span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="comment">    stack loop after each call) until the return value dereferences to a NUL</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="comment">    byte.  Save the return value as the new starting *data pointer otherwise.</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;<span class="comment">    This function is aliased to TCPPutString on non-PIC18 platforms.</span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;<span class="preprocessor">#if defined(__18CXX)</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#aa7f87c3d5228b0da55681f228c67df44"> 1510</a></span>&#160;ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* <a class="code" href="_t_c_p_8c.html#aa7f87c3d5228b0da55681f228c67df44">TCPPutROMString</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* data)</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;{</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    <span class="keywordflow">return</span> data + <a class="code" href="_t_c_p_8c.html#a78d22c72df366276a2ed1908e2337093">TCPPutROMArray</a>(hTCP, data, strlenpgm((ROM <span class="keywordtype">char</span>*)data));</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;}</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;<span class="comment">    WORD TCPGetTxFIFOFull(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;<span class="comment">    Determines how many bytes are pending in the TCP TX FIFO.</span></div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="comment">    hTCP - The socket to check.</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="comment">    Number of bytes pending to be flushed in the TCP TX FIFO.</span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a33b561c9a2dc4a01aaba1a3cb7004bcc"> 1532</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#a33b561c9a2dc4a01aaba1a3cb7004bcc">TCPGetTxFIFOFull</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;{</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wDataLen;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wFIFOSize;</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    {</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;    }</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    </div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;    <span class="comment">// Calculate total usable FIFO size</span></div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;    wFIFOSize = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> - 1;</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;    <span class="comment">// Find out how many data bytes are free in the TX FIFO</span></div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;    wDataLen = <a class="code" href="_t_c_p_8c.html#a10e1123d9bd8d1d94a6b9e10c2e8176c">TCPIsPutReady</a>(hTCP);</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    <span class="keywordflow">return</span> wFIFOSize - wDataLen;</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;}</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;<span class="comment">    Receive Functions</span></div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;<span class="comment">    void TCPDiscard(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;<span class="comment">    Discards any pending data in the TCP RX FIFO.</span></div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;<span class="comment">    hTCP - The socket whose RX FIFO is to be cleared.</span></div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01576"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a3aab79449aba751f5d05914000b1839d"> 1576</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#a3aab79449aba751f5d05914000b1839d">TCPDiscard</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;{</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP))</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    {</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;        SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    </div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;        <span class="comment">// Delete all data in the RX buffer</span></div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    </div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;        <span class="comment">// Send a Window update message to the remote node</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;        SendTCP(ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    }</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;}</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;<span class="comment">    void WORD TCPIsGetReady(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;<span class="comment">    Determines how many bytes can be read from the TCP RX buffer.</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;<span class="comment">    Call this function to determine how many bytes can be read from the </span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="comment">    TCP RX buffer.  If this function returns zero, the application must </span></div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;<span class="comment">    return to the main stack loop before continuing in order to wait for</span></div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="comment">    more data to arrive.</span></div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;<span class="comment">    hTCP - The socket to check.</span></div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="comment">    The number of bytes available to be read from the TCP RX buffer.</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85"> 1613</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;{</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;    {</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    }</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;    </div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;        </div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>)</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;        <span class="keywordflow">return</span> MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>;</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;        <span class="keywordflow">return</span> (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> + 1) + (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>);</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;}</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="comment">    BOOL TCPGet(TCP_SOCKET hTCP, BYTE* byte)</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="comment">    Retrieves a single byte to a TCP socket.</span></div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="comment">    hTCP - The socket from which to read.</span></div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="comment">    byte - Pointer to location in which the read byte should be stored.</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;<span class="comment">    TRUE - A byte was read from the buffer.</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="comment">    FALSE - The buffer was empty, or the socket is not connected.</span></div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01647"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a6a2c177c65bf1d1a9df118ba3c927088"> 1647</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#a6a2c177c65bf1d1a9df118ba3c927088">TCPGet</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* byte)</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;{</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wGetReadyCount;</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;    <span class="comment">// See if there is any data which can be read</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;    wGetReadyCount = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    <span class="keywordflow">if</span>(wGetReadyCount == 0u)</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    </div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;    <span class="keywordflow">if</span>(byte)</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;        TCPRAMCopy((PTR_BASE)byte, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, 1);</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    <span class="comment">// Send a window update if we&#39;ve run out of data</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <span class="keywordflow">if</span>(wGetReadyCount == 1u)</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;    {</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a> = 1;</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;    }</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;    <span class="comment">// If not already enabled, start a timer so a window </span></div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;    <span class="comment">// update will get sent to the remote node at some point</span></div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a>)</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    {</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() + TCP_WINDOW_UPDATE_TIMEOUT_VAL/256ull;</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;    }</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;}</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="comment">    WORD TCPGetArray(TCP_SOCKET hTCP, BYTE* buffer, WORD len)</span></div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;<span class="comment">    Reads an array of data bytes from a TCP socket&#39;s receive FIFO.  The data </span></div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;<span class="comment">    is removed from the FIFO in the process.</span></div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="comment">    hTCP - The socket from which data is to be read.</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="comment">    buffer - Pointer to the array to store data that was read.</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;<span class="comment">    len  - Number of bytes to be read.</span></div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;<span class="comment">    The number of bytes read from the socket.  If less than len, the</span></div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="comment">    RX FIFO buffer became empty or the socket is not conected.</span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01701"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a35804e9713650251b6e4cb75909e2480"> 1701</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#a35804e9713650251b6e4cb75909e2480">TCPGetArray</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* buffer, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len)</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;{</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wGetReadyCount;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> RightLen = 0;</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;    <span class="comment">// See if there is any data which can be read</span></div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;    wGetReadyCount = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;    <span class="keywordflow">if</span>(wGetReadyCount == 0u)</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;        <span class="keywordflow">return</span> 0x0000u;</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    <span class="comment">// Make sure we don&#39;t try to read more data than is available</span></div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    <span class="keywordflow">if</span>(len &gt; wGetReadyCount)</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;        len = wGetReadyCount;</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;    <span class="comment">// See if we need a two part get</span></div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> + len &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    {</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        RightLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> + 1;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        <span class="keywordflow">if</span>(buffer)</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        {</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;            TCPRAMCopy((PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, RightLen);</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;            buffer += RightLen;</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        }</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;        len -= RightLen;</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    }</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    <span class="keywordflow">if</span>(buffer)</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;        TCPRAMCopy((PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, len);</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> += len;</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;    len += RightLen;</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    <span class="comment">// Send a window update if we&#39;ve run low on data</span></div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;    <span class="keywordflow">if</span>(wGetReadyCount - len &lt;= len)</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    {</div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a> = 1;</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;    }</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a>)</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;    <span class="comment">// If not already enabled, start a timer so a window </span></div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;    <span class="comment">// update will get sent to the remote node at some point</span></div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    {</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() + TCP_WINDOW_UPDATE_TIMEOUT_VAL/256ull;</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;    }</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    <span class="keywordflow">return</span> len;</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;}</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;<span class="comment">    WORD TCPGetRxFIFOFree(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;<span class="comment">    Determines how many bytes are free in the RX FIFO.</span></div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="comment">    hTCP - The socket to check.</span></div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;<span class="comment">    The number of bytes free in the TCP RX FIFO.  If zero, no additional </span></div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;<span class="comment">    data can be received until the application removes some data using one</span></div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="comment">    of the TCPGet family functions.</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01770"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#acf33433ffb49f799001e2c1ccd9494c6"> 1770</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#acf33433ffb49f799001e2c1ccd9494c6">TCPGetRxFIFOFree</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;{</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wDataLen;</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wFIFOSize;</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;    </div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    {</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;    }</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;    </div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    </div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;    <span class="comment">// Calculate total usable FIFO size</span></div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    wFIFOSize = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;    {</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;        PTR_BASE SSLtemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;</div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;        <span class="comment">// Move SSL pointer to determine full buffer size</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a>;</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;        <span class="comment">// Find out how many data bytes are actually in the RX FIFO</span></div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;        wDataLen = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;        </div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;        <span class="comment">// Move SSL pointer back to proper location (if we changed it)</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = SSLtemp;</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;    }</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="preprocessor">    #else</span></div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    {</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;        <span class="comment">// Find out how many data bytes are actually in the RX FIFO</span></div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;        wDataLen = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    }</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    </div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    <span class="comment">// Perform the calculation  </span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;    <span class="keywordflow">return</span> wFIFOSize - wDataLen;</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;}</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="comment">    WORD TCPPeekArray(TCP_SOCKET hTCP, BYTE *vBuffer, WORD wLen, WORD wStart)</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="comment">    Reads a specified number of data bytes from the TCP RX FIFO without </span></div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;<span class="comment">    removing them from the buffer.</span></div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;<span class="comment">    Reads a specified number of data bytes from the TCP RX FIFO without </span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="comment">    removing them from the buffer.  No TCP control actions are taken as a </span></div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;<span class="comment">    result of this function (ex: no window update is sent to the remote node).</span></div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;<span class="comment">    hTCP - The socket to peak from (read without removing from stream).</span></div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="comment">    vBuffer - Destination to write the peeked data bytes.</span></div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;<span class="comment">    wLen - Length of bytes to peak from the RX FIFO and copy to vBuffer.</span></div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;<span class="comment">    wStart - Zero-indexed starting position within the FIFO to start peeking </span></div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;<span class="comment">        from.</span></div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="comment">    Number of bytes actually peeked from the stream and copied to vBuffer.  </span></div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="comment">    This value can be less than wLen if wStart + wLen is greater than the </span></div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="comment">    deepest possible character in the RX FIFO.</span></div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ac2c356648731743c25b7588ac42f1216"> 1841</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#ac2c356648731743c25b7588ac42f1216">TCPPeekArray</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *vBuffer, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLen, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wStart)</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;{</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;    PTR_BASE ptrRead;</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> w;</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wBytesUntilWrap;</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT || wLen == 0)</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    {</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    }</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    </div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    <span class="comment">// Find out how many bytes are in the RX FIFO and decrease read length </span></div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="comment">// if the start offset + read length is beyond the end of the FIFO</span></div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;    w = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    <span class="keywordflow">if</span>(wStart + wLen &gt; w)</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;        wLen = w - wStart;</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;    <span class="comment">// Find the read start location</span></div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    ptrRead = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> + wStart;</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;    <span class="keywordflow">if</span>(ptrRead &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;        ptrRead -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    <span class="comment">// Calculate how many bytes can be read in a single go</span></div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;    wBytesUntilWrap = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - ptrRead + 1;</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;    <span class="keywordflow">if</span>(wLen &lt;= wBytesUntilWrap)</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    {</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;        <span class="comment">// Read all at once</span></div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;        TCPRAMCopy((PTR_BASE)vBuffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, ptrRead, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wLen);</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    }</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    {</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;        <span class="comment">// Read all bytes up to the wrap position and then read remaining bytes </span></div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;        <span class="comment">// at the start of the buffer</span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;        TCPRAMCopy((PTR_BASE)vBuffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, ptrRead, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wBytesUntilWrap);</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;        TCPRAMCopy((PTR_BASE)vBuffer+wBytesUntilWrap, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wLen - wBytesUntilWrap);</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    }</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    </div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    <span class="keywordflow">return</span> wLen;</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;}</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;<span class="comment">    BYTE TCPPeek(TCP_SOCKET hTCP, WORD wStart)</span></div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;<span class="comment">    Peaks at one byte in the TCP RX FIFO without removing it from the buffer.</span></div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;<span class="comment">    Peaks at one byte in the TCP RX FIFO without removing it from the buffer.</span></div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="comment">    hTCP - The socket to peak from (read without removing from stream).</span></div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="comment">    wStart - Zero-indexed starting position within the FIFO to peek from.</span></div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="comment">    Byte peeked from the RX FIFO.  If there is no data in the buffer or an </span></div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;<span class="comment">    illegal wStart starting offset is given, then an indeterminate value is </span></div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;<span class="comment">    returned.  The caller must ensure that valid parameters are passed to avoid </span></div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;<span class="comment">    (i.e ensure that TCPIsGetReady() returns a number that is less than wStart </span></div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;<span class="comment">    before calling TCPPeek()).</span></div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;<span class="comment">    Use the TCPPeekArray() function to read more than one byte.  It will </span></div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;<span class="comment">    perform better than calling TCPPeek() in a loop.</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01911"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ace70c5eb1360822faadaab5d0431ec13"> 1911</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="_t_c_p_8c.html#ace70c5eb1360822faadaab5d0431ec13">TCPPeek</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wStart)</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;{</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    </div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    <a class="code" href="_t_c_p_8c.html#ac2c356648731743c25b7588ac42f1216">TCPPeekArray</a>(hTCP, &amp;i, 1, wStart);</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    <span class="keywordflow">return</span> i;</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;}</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;<span class="comment">    Search Functions</span></div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="comment">    WORD TCPFindArrayEx(TCP_SOCKET hTCP, BYTE* cFindArray, WORD wLen, </span></div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;<span class="comment">                        WORD wStart, WORD wSearchLen, BOOL bTextCompare)</span></div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;<span class="comment">    Searches for a string in the TCP RX buffer.</span></div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="comment">    This function finds the first occurrance of an array of bytes in the</span></div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;<span class="comment">    TCP RX buffer.  It can be used by an application to abstract searches </span></div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;<span class="comment">    out of their own application code.  For increased efficiency, the </span></div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;<span class="comment">    function is capable of limiting the scope of search to a specific</span></div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;<span class="comment">    range of bytes.  It can also perform a case-insensitive search if</span></div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;<span class="comment">    required.</span></div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;<span class="comment">    For example, if the buffer contains &quot;I love PIC MCUs!&quot; and the search</span></div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;<span class="comment">    array is &quot;love&quot; with a length of 4, a value of 2 will be returned.</span></div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="comment">    hTCP - The socket to search within.</span></div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="comment">    cFindArray - The array of bytes to find in the buffer.</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="comment">    wLen - Length of cFindArray.</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="comment">    wStart - Zero-indexed starting position within the buffer.</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment">    wSearchLen - Length from wStart to search in the buffer.</span></div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="comment">    bTextCompare - TRUE for case-insensitive text search, FALSE for binary search</span></div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;<span class="comment">    0xFFFF - Search array not found</span></div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="comment">    Otherwise - Zero-indexed position of the first occurrance</span></div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;<span class="comment">    Since this function usually must transfer data from external storage</span></div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="comment">    to internal RAM for comparison, its performance degrades significantly</span></div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;<span class="comment">    when the buffer is full and the array is not found.  For better </span></div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;<span class="comment">    performance, try to search for characters that are expected to exist or</span></div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;<span class="comment">    limit the scope of the search as much as possible.  The HTTP2 module, </span></div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;<span class="comment">    for example, uses this function to parse headers.  However, it searches </span></div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;<span class="comment">    for newlines, then the separating colon, then reads the header name to </span></div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;<span class="comment">    RAM for final comparison.  This has proven to be significantly faster  </span></div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="comment">    than searching for full header name strings outright.</span></div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l01970"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a35d3a823f8212fdb4ee305fb6dfe16f8"> 1970</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#a35d3a823f8212fdb4ee305fb6dfe16f8">TCPFindArrayEx</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* cFindArray, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLen, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wStart, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wSearchLen, <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> bTextCompare)</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;{</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;    PTR_BASE ptrRead;</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wDataLen;</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wBytesUntilWrap;</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;    PTR_BASE ptrLocation;</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLenStart;</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *cFindArrayStart;</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i, j, k;</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> isFinding;</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> buffer[32];</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT || wLen == 0)</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;    {</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;    }</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;    </div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;    <span class="comment">// Find out how many bytes are in the RX FIFO and return </span></div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;    <span class="comment">// immediately if we won&#39;t possibly find a match</span></div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    wDataLen = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP) - wStart;</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;    <span class="keywordflow">if</span>(wDataLen &lt; wLen)</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;        <span class="keywordflow">return</span> 0xFFFFu;</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;    <span class="keywordflow">if</span>(wSearchLen &amp;&amp; (wDataLen &gt; wSearchLen))</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;        wDataLen = wSearchLen;</div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;    ptrLocation = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> + wStart;</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;    <span class="keywordflow">if</span>(ptrLocation &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;        ptrLocation -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;    ptrRead = ptrLocation;</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;    wBytesUntilWrap = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - ptrLocation + 1;</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;    ptrLocation = wStart;</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    wLenStart = wLen;</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;    cFindArrayStart = cFindArray;</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    j = *cFindArray++;</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;    isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;    <span class="keywordflow">if</span>(bTextCompare)</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;    {</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;        <span class="keywordflow">if</span>(j &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; j &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;            j += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;    }</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;    <span class="comment">// Search for the array</span></div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    <span class="keywordflow">while</span>(1)</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;    {</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;        <span class="comment">// Figure out how big of a chunk to read</span></div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;        k = <span class="keyword">sizeof</span>(buffer);</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;        <span class="keywordflow">if</span>(k &gt; wBytesUntilWrap)</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;            k = wBytesUntilWrap;</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;        <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)k &gt; wDataLen)</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;            k = wDataLen;</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;        <span class="comment">// Read a chunk of data into the buffer</span></div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        TCPRAMCopy((PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, ptrRead, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)k);</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;        ptrRead += k;</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;        wBytesUntilWrap -= k;</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;        <span class="keywordflow">if</span>(wBytesUntilWrap == 0u)</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;        {</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;            ptrRead = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;            wBytesUntilWrap = 0xFFFFu;</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;        }</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;        <span class="comment">// Convert everything to uppercase</span></div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;        <span class="keywordflow">if</span>(bTextCompare)</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;        {</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;            <span class="keywordflow">for</span>(i = 0; i &lt; k; i++)</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;            {</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;                <span class="keywordflow">if</span>(buffer[i] &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; buffer[i] &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;                    buffer[i] += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;                <span class="keywordflow">if</span>(j == buffer[i])</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;                {</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;                    <span class="keywordflow">if</span>(--wLen == 0u)</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;                        <span class="keywordflow">return</span> ptrLocation-wLenStart + i + 1;</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;                    j = *cFindArray++;</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;                    isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                    <span class="keywordflow">if</span>(j &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; j &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                        j += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;                }</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                {</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;                    wLen = wLenStart;</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;                    <span class="keywordflow">if</span>(isFinding)</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;                    {</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;                        cFindArray = cFindArrayStart;</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;                        j = *cFindArray++;</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;                        <span class="keywordflow">if</span>(j &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; j &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;                            j += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;                        isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;                    }</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;                }</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;            }</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;        }</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;        <span class="keywordflow">else</span>    <span class="comment">// Compare as is</span></div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;        {</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;            <span class="keywordflow">for</span>(i = 0; i &lt; k; i++)</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;            {</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;                <span class="keywordflow">if</span>(j == buffer[i])</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;                {</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                    <span class="keywordflow">if</span>(--wLen == 0u)</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;                        <span class="keywordflow">return</span> ptrLocation-wLenStart + i + 1;</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                    j = *cFindArray++;</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;                    isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;                }</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;                {</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;                    wLen = wLenStart;</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;                    <span class="keywordflow">if</span>(isFinding)</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;                    {</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;                        cFindArray = cFindArrayStart;</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;                        j = *cFindArray++;</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;                        isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;                    }</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;                }</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;            }</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;        }</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;        <span class="comment">// Check to see if it is impossible to find a match</span></div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        wDataLen -= k;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        <span class="keywordflow">if</span>(wDataLen &lt; wLen)</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;            <span class="keywordflow">return</span> 0xFFFFu;</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;        ptrLocation += k;</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;    }</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;}</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;<span class="comment">    WORD TCPFindROMArrayEx(TCP_SOCKET hTCP, BYTE* cFindArray, WORD wLen, </span></div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;<span class="comment">                        WORD wStart, WORD wSearchLen, BOOL bTextCompare)</span></div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;<span class="comment">    Searches for a ROM string in the TCP RX buffer.</span></div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="comment">    This function finds the first occurrance of an array of bytes in the</span></div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;<span class="comment">    TCP RX buffer.  It can be used by an application to abstract searches </span></div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;<span class="comment">    out of their own application code.  For increased efficiency, the </span></div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="comment">    function is capable of limiting the scope of search to a specific</span></div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;<span class="comment">    range of bytes.  It can also perform a case-insensitive search if</span></div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;<span class="comment">    required.</span></div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;<span class="comment">    For example, if the buffer contains &quot;I love PIC MCUs!&quot; and the search</span></div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;<span class="comment">    array is &quot;love&quot; with a length of 4, a value of 2 will be returned.</span></div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;<span class="comment">    hTCP - The socket to search within.</span></div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;<span class="comment">    cFindArray - The array of bytes to find in the buffer.</span></div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;<span class="comment">    wLen - Length of cFindArray.</span></div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;<span class="comment">    wStart - Zero-indexed starting position within the buffer.</span></div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;<span class="comment">    wSearchLen - Length from wStart to search in the buffer.</span></div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;<span class="comment">    bTextCompare - TRUE for case-insensitive text search, FALSE for binary search</span></div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<span class="comment">    0xFFFF - Search array not found</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;<span class="comment">    Otherwise - Zero-indexed position of the first occurrance</span></div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;<span class="comment">    Since this function usually must transfer data from external storage</span></div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;<span class="comment">    to internal RAM for comparison, its performance degrades significantly</span></div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;<span class="comment">    when the buffer is full and the array is not found.  For better </span></div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;<span class="comment">    performance, try to search for characters that are expected to exist or</span></div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;<span class="comment">    limit the scope of the search as much as possible.  The HTTP2 module, </span></div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;<span class="comment">    for example, uses this function to parse headers.  However, it searches </span></div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;<span class="comment">    for newlines, then the separating colon, then reads the header name to </span></div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;<span class="comment">    RAM for final comparison.  This has proven to be significantly faster  </span></div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;<span class="comment">    than searching for full header name strings outright.</span></div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;<span class="comment">    This function is aliased to TCPFindArrayEx on non-PIC18 platforms.</span></div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;<span class="preprocessor">#if defined(__18CXX)</span></div>
<div class="line"><a name="l02146"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#aee8c85c7e0542f41d000d4f6f59f4641"> 2146</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#aee8c85c7e0542f41d000d4f6f59f4641">TCPFindROMArrayEx</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* cFindArray, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLen, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wStart, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wSearchLen, <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> bTextCompare)</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;{</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    PTR_BASE ptrRead;</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wDataLen;</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wBytesUntilWrap;</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;    PTR_BASE ptrLocation;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLenStart;</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *cFindArrayStart;</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i, j, k;</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> isFinding;</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> buffer[32];</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT || wLen == 0)</div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;    {</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;    }</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;    </div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;    <span class="comment">// Find out how many bytes are in the RX FIFO and return </span></div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;    <span class="comment">// immediately if we won&#39;t possibly find a match</span></div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;    wDataLen = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP) - wStart;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;    <span class="keywordflow">if</span>(wDataLen &lt; wLen)</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        <span class="keywordflow">return</span> 0xFFFFu;</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;    <span class="keywordflow">if</span>(wSearchLen &amp;&amp; (wDataLen &gt; wSearchLen))</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;        wDataLen = wSearchLen;</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;    ptrLocation = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> + wStart;</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;    <span class="keywordflow">if</span>(ptrLocation &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;        ptrLocation -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;    ptrRead = ptrLocation;</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;    wBytesUntilWrap = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - ptrLocation + 1;</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;    ptrLocation = wStart;</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;    wLenStart = wLen;</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;    cFindArrayStart = cFindArray;</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;    j = *cFindArray++;</div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;    isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;    <span class="keywordflow">if</span>(bTextCompare)</div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;    {</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;        <span class="keywordflow">if</span>(j &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; j &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;            j += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    }</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;    <span class="comment">// Search for the array</span></div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;    <span class="keywordflow">while</span>(1)</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;    {</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;        <span class="comment">// Figure out how big of a chunk to read</span></div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;        k = <span class="keyword">sizeof</span>(buffer);</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;        <span class="keywordflow">if</span>(k &gt; wBytesUntilWrap)</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;            k = wBytesUntilWrap;</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;        <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)k &gt; wDataLen)</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;            k = wDataLen;</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;        <span class="comment">// Read a chunk of data into the buffer</span></div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;        TCPRAMCopy((PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, ptrRead, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)k);</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;        ptrRead += k;</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;        wBytesUntilWrap -= k;</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;        <span class="keywordflow">if</span>(wBytesUntilWrap == 0u)</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        {</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;            ptrRead = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;            wBytesUntilWrap = 0xFFFFu;</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;        }</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;        <span class="comment">// Convert everything to uppercase</span></div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;        <span class="keywordflow">if</span>(bTextCompare)</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;        {</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;            <span class="keywordflow">for</span>(i = 0; i &lt; k; i++)</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;            {</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;                <span class="keywordflow">if</span>(buffer[i] &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; buffer[i] &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;                    buffer[i] += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;                <span class="keywordflow">if</span>(j == buffer[i])</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;                {</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;                    <span class="keywordflow">if</span>(--wLen == 0u)</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;                        <span class="keywordflow">return</span> ptrLocation-wLenStart + i + 1;</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;                    j = *cFindArray++;</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;                    isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;                    <span class="keywordflow">if</span>(j &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; j &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;                        j += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;                }</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;                {</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;                    wLen = wLenStart;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;                    <span class="keywordflow">if</span>(isFinding)</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;                    {</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;                        cFindArray = cFindArrayStart;</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;                        j = *cFindArray++;</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;                        <span class="keywordflow">if</span>(j &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; j &lt;= <span class="charliteral">&#39;z&#39;</span>)</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;                            j += <span class="charliteral">&#39;A&#39;</span>-<span class="charliteral">&#39;a&#39;</span>;</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;                        isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;                    }</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;                }</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;            }</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;        }</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;        <span class="keywordflow">else</span>    <span class="comment">// Compare as is</span></div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;        {</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;            <span class="keywordflow">for</span>(i = 0; i &lt; k; i++)</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;            {</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;                <span class="keywordflow">if</span>(j == buffer[i])</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;                {</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;                    <span class="keywordflow">if</span>(--wLen == 0u)</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;                        <span class="keywordflow">return</span> ptrLocation-wLenStart + i + 1;</div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;                    j = *cFindArray++;</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;                    isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;                }</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;                {</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;                    wLen = wLenStart;</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;                    <span class="keywordflow">if</span>(isFinding)</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;                    {</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;                        cFindArray = cFindArrayStart;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;                        j = *cFindArray++;</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;                        isFinding = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;                    }</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;                }</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;            }</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;        }</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;        <span class="comment">// Check to see if it is impossible to find a match</span></div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;        wDataLen -= k;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        <span class="keywordflow">if</span>(wDataLen &lt; wLen)</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;            <span class="keywordflow">return</span> 0xFFFFu;</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;        ptrLocation += k;</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;    }</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;}</div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;<span class="comment">    WORD TCPFindEx(TCP_SOCKET hTCP, BYTE cFind,</span></div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;<span class="comment">                        WORD wStart, WORD wSearchLen, BOOL bTextCompare)</span></div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="comment">    Searches for a byte in the TCP RX buffer.</span></div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;<span class="comment">    This function finds the first occurrance of a byte in the TCP RX</span></div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<span class="comment">    buffer.  It can be used by an application to abstract searches </span></div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;<span class="comment">    out of their own application code.  For increased efficiency, the </span></div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="comment">    function is capable of limiting the scope of search to a specific</span></div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="comment">    range of bytes.  It can also perform a case-insensitive search if</span></div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;<span class="comment">    required.</span></div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;<span class="comment">    For example, if the buffer contains &quot;I love PIC MCUs!&quot; and the cFind</span></div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;<span class="comment">    byte is &#39; &#39;, a value of 1 will be returned.</span></div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="comment">    hTCP - The socket to search within.</span></div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="comment">    cFind - The byte to find in the buffer.</span></div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="comment">    wStart - Zero-indexed starting position within the buffer.</span></div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<span class="comment">    wSearchLen - Length from wStart to search in the buffer.</span></div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="comment">    bTextCompare - TRUE for case-insensitive text search, FALSE for binary search</span></div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="comment">    0xFFFF - Search array not found</span></div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="comment">    Otherwise - Zero-indexed position of the first occurrance</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;<span class="comment">    Since this function usually must transfer data from external storage</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;<span class="comment">    to internal RAM for comparison, its performance degrades significantly</span></div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;<span class="comment">    when the buffer is full and the array is not found.  For better </span></div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;<span class="comment">    performance, try to search for characters that are expected to exist or</span></div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;<span class="comment">    limit the scope of the search as much as possible.  The HTTP2 module, </span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;<span class="comment">    for example, uses this function to parse headers.  However, it searches </span></div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;<span class="comment">    for newlines, then the separating colon, then reads the header name to </span></div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;<span class="comment">    RAM for final comparison.  This has proven to be significantly faster  </span></div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;<span class="comment">    than searching for full header name strings outright.</span></div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l02320"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ac84010ab6fad0a3b379eb2c9c668f9b7"> 2320</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#ac84010ab6fad0a3b379eb2c9c668f9b7">TCPFindEx</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> cFind, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wStart, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wSearchLen, <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> bTextCompare)</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;{</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_t_c_p_8c.html#a35d3a823f8212fdb4ee305fb6dfe16f8">TCPFindArrayEx</a>(hTCP, &amp;cFind, <span class="keyword">sizeof</span>(cFind), wStart, wSearchLen, bTextCompare);</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;}</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="comment">    Data Processing Functions</span></div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;</div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;<span class="comment">    void TCPTick(void)</span></div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;<span class="comment">    Performs periodic TCP tasks.</span></div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;<span class="comment">    This function performs any required periodic TCP tasks.  Each </span></div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;<span class="comment">    socket&#39;s state machine is checked, and any elapsed timeout periods</span></div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;<span class="comment">    are handled.</span></div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l02353"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a364093914f3c43521ca04d9b0e5b6a3c"> 2353</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#a364093914f3c43521ca04d9b0e5b6a3c">TCPTick</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;{</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;    <a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP;</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> bRetransmit;</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> bCloseSocket;</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vFlags;</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> w;</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    <span class="comment">// Periodically all &quot;not closed&quot; sockets must perform timed operations</span></div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;    <span class="keywordflow">for</span>(hTCP = 0; hTCP &lt; TCP_SOCKET_COUNT; hTCP++)</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;    {</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;        SyncTCBStub(hTCP);</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;        </div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;        <span class="comment">// Handle any SSL Processing and Message Transmission</span></div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="preprocessor">        #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;        {</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;            <span class="comment">// Handle any periodic tasks, such as RSA operations</span></div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;            <a class="code" href="_s_s_l_8h.html#a5ffcb7882b02ce0e97dedd9261ca74e0">SSLPeriodic</a>(hTCP, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a>);</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;            </div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;            <span class="comment">// If unsent data is waiting, transmit it as an application record</span></div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> != MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> &amp;&amp; <a class="code" href="_t_c_p_8c.html#af62b584e06310e5a763cd87ff3c5c7ae">TCPSSLGetPendingTxSize</a>(hTCP) != 0u)</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;                <a class="code" href="_s_s_l_8h.html#a1cef416e587e77f9aeda9fbe53edf3ed">SSLTxRecord</a>(hTCP, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a>, SSL_APPLICATION);</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;            </div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;            <span class="comment">// If an SSL message is requested, send it now</span></div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">sslReqMessage</a> != <a class="code" href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3ca8a70b1ac06fee60fd90c439252ff229d">SSL_NO_MESSAGE</a>)</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;                <a class="code" href="_s_s_l_8h.html#ae047f0c0ce6b7f6cdc5fe8098bfef8ee">SSLTxMessage</a>(hTCP, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">sslReqMessage</a>);</div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;        }</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;        </div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;        vFlags = 0x00;</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;        bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;        bCloseSocket = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;        <span class="comment">// Transmit ASAP data if the medium is available</span></div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#abf1b4439c5f152ddb383859e5a0f3bd3">bTXASAP</a> || MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a>)</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;        {</div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="_m_a_c_8h.html#a99937ac52db1a95f86ca59779640bcbe">MACIsTxReady</a>())</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;            {</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;                vFlags = ACK;</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;                bRetransmit = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a>;</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;            }</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        }</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;        <span class="comment">// Perform any needed window updates and data transmissions</span></div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a>)</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;        {</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;            <span class="comment">// See if the timeout has occured, and we need to send a new window update and pending data</span></div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;            <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> - (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>()) &lt;= (<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)0)</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;                vFlags = ACK;</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;        }</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;        <span class="comment">// Process Delayed ACKnowledgement timer</span></div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a97e8fa1695ed948d0a715a3b96bb6d8d">bDelayedACKTimerEnabled</a>)</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;        {</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;            <span class="comment">// See if the timeout has occured and delayed ACK needs to be sent</span></div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;            <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ad7a32728d33041b932eab132ddec9a6f">OverlappedTimers</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ac42d764ddec4dd25aab3d65a9a415753">delayedACKTime</a> - (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>()) &lt;= (<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)0)</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;                vFlags = ACK;</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;        }</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;        </div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;        <span class="comment">// Process TCP_CLOSE_WAIT timer</span></div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a>)</div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;        {</div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;            <span class="comment">// Automatically close the socket on our end if the application </span></div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;            <span class="comment">// fails to call TCPDisconnect() is a reasonable amount of time.</span></div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;            <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ad7a32728d33041b932eab132ddec9a6f">OverlappedTimers</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#adbf3a5a42e98b90ba8a87652e0b9099e">closeWaitTime</a> - (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>()) &lt;= (<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)0)</div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;            {</div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;                vFlags = FIN | ACK;</div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a>;</div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;            }</div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;        }</div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;        <span class="comment">// Process listening server sockets that might have a SYN waiting in the SYNQueue[]</span></div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;<span class="preprocessor">        #if TCP_SYN_QUEUE_MAX_ENTRIES</span></div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b">TCP_LISTEN</a>)</div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;            {</div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;                <span class="keywordflow">for</span>(w = 0; w &lt; TCP_SYN_QUEUE_MAX_ENTRIES; w++)</div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;                {</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;                    <span class="comment">// Abort search if there are no more valid records</span></div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;                    <span class="keywordflow">if</span>(SYNQueue[w].wDestPort == 0u)</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;                    </div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;                    <span class="comment">// Stop searching if this SYN queue entry can be used by this socket</span></div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;<span class="preprocessor">                    #if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;                    <span class="keywordflow">if</span>(SYNQueue[w].wDestPort == MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> || SYNQueue[w].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a4a73e1502cba148db181af196cdf145a">wDestPort</a> == MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>)</div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;<span class="preprocessor">                    #else</span></div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;                    <span class="keywordflow">if</span>(SYNQueue[w].wDestPort == MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>)</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="preprocessor">                    #endif</span></div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;                    {</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;                        <span class="comment">// Set up our socket and generate a reponse SYN+ACK packet</span></div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;                        SyncTCB();</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;                        </div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;<span class="preprocessor">                        #if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;                        <span class="comment">// If this matches the SSL port, make sure that can be configured</span></div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;                        <span class="comment">// before continuing.  If not, break and leave this in the queue</span></div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;                        <span class="keywordflow">if</span>(SYNQueue[w].wDestPort == MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &amp;&amp; !<a class="code" href="_t_c_p_8c.html#a9be64cc028f6aef8bc603abb10073639">TCPStartSSLServer</a>(hTCP))</div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;<span class="preprocessor">                        #endif</span></div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;                        </div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;                        memcpy((<span class="keywordtype">void</span>*)&amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>, (<span class="keywordtype">void</span>*)&amp;SYNQueue[w].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a86fb1c2f41cbd3136de2afa6497925f2">niSourceAddress</a>, <span class="keyword">sizeof</span>(<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>));</div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = SYNQueue[w].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ad129842efc936a38e329384496850daf">wSourcePort</a>;</div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a> = SYNQueue[w].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ab040df9bb3ca4da90ebc0b1b59a6a618">dwSourceSEQ</a> + 1;</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = (MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr.w[1] + MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr.w[0] + MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>) ^ MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;                        vFlags = SYN | ACK;</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a>;</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;                        </div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;                        <span class="comment">// Delete this SYN from the SYNQueue and compact the SYNQueue[] array</span></div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;                        TCPRAMCopy((PTR_BASE)&amp;SYNQueue[w], <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, (PTR_BASE)&amp;SYNQueue[w+1], TCP_PIC_RAM, (TCP_SYN_QUEUE_MAX_ENTRIES-1u-w)*<span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html">TCP_SYN_QUEUE</a>));</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;                        SYNQueue[TCP_SYN_QUEUE_MAX_ENTRIES-1].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a4a73e1502cba148db181af196cdf145a">wDestPort</a> = 0u;</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;    </div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;                    }</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;                }</div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;            }</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;</div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;        <span class="keywordflow">if</span>(vFlags)</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;            SendTCP(vFlags, bRetransmit ? 0 : SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;</div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;        <span class="comment">// The TCP_CLOSED, TCP_LISTEN, and sometimes the TCP_ESTABLISHED </span></div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;        <span class="comment">// state don&#39;t need any timeout events, so see if the timer is enabled</span></div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;        <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a>)</div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;        {</div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;<span class="preprocessor">            #if defined(TCP_KEEP_ALIVE_TIMEOUT)</span></div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;                <span class="comment">// Only the established state has any use for keep-alives</span></div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;                <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>)</div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;                {</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;                    <span class="comment">// If timeout has not occured, do not do anything.</span></div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;                    <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)(<a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a>) &lt; (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)0)</div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;        </div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;                    <span class="comment">// If timeout has occured and the connection appears to be dead (no </span></div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;                    <span class="comment">// responses from remote node at all), close the connection so the </span></div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;                    <span class="comment">// application doesn&#39;t sit around indefinitely with a useless socket </span></div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;                    <span class="comment">// that it thinks is still open</span></div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;                    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa2eabcef6e3f7cb140ddc43f3b0f01f2">vUnackedKeepalives</a> == TCP_MAX_UNACKED_KEEP_ALIVES)</div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;                    {</div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;                        vFlags = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">bServer</a>;</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;                        <span class="comment">// Force an immediate FIN and RST transmission</span></div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;                        <span class="comment">// Double calling TCPDisconnect() will also place us </span></div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;                        <span class="comment">// back in the listening state immediately if a server socket.</span></div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;                        <a class="code" href="_t_c_p_8c.html#aacb150778e6f5cf748b05b0e0568f30e">TCPDisconnect</a>(hTCP);</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;                        <a class="code" href="_t_c_p_8c.html#aacb150778e6f5cf748b05b0e0568f30e">TCPDisconnect</a>(hTCP);</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;                        </div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;                        <span class="comment">// Prevent client mode sockets from getting reused by other applications.  </span></div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;                        <span class="comment">// The application must call TCPDisconnect() with the handle to free this </span></div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;                        <span class="comment">// socket (and the handle associated with it)</span></div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;                        <span class="keywordflow">if</span>(!vFlags)</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;                            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47af36788cc35b87e60aad61c78a8af296e">TCP_CLOSED_BUT_RESERVED</a>;</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;                        </div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;                    }</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;                    </div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;                    <span class="comment">// Otherwise, if a timeout occured, simply send a keep-alive packet</span></div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;                    SyncTCB();</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;                    SendTCP(ACK, SENDTCP_KEEP_ALIVE);</div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + TCP_KEEP_ALIVE_TIMEOUT;</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;                }</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;        }</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;        <span class="comment">// If timeout has not occured, do not do anything.</span></div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;        <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)(<a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a>) &lt; (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)0)</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;        <span class="comment">// Load up extended TCB information</span></div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;        SyncTCB();</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;        <span class="comment">// A timeout has occured.  Respond to this timeout condition</span></div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;        <span class="comment">// depending on what state this socket is in.</span></div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;        <span class="keywordflow">switch</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a>)</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;        {</div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;<span class="preprocessor">            #if defined(STACK_CLIENT_MODE)</span></div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;<span class="preprocessor">            #if defined(STACK_USE_DNS)</span></div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a576f183bc25360e18be55ca92f4b18bb">TCP_GET_DNS_MODULE</a>:</div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="_d_n_s_8h.html#a6d90f550f52f1e548b4db225a844e7e3">DNSBeginUsage</a>())</div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;                {</div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a979649935757125e531ffac76be1200c">TCP_DNS_RESOLVE</a>;</div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;                    <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a85e50d5129c9eaec6e4729cb5aacf312">bRemoteHostIsROM</a>)</div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;                        <a class="code" href="_d_n_s_8h.html#af437c76bc5d24f46a06064cfaef1c84a">DNSResolveROM</a>((ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)(ROM_PTR_BASE)MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a3f09cd8c9167b802029195c759770966">dwRemoteHost</a>, DNS_TYPE_A);</div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;                        <a class="code" href="_d_n_s_8h.html#a86421bea342691fd5a4451ba0e114ac1">DNSResolve</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)(PTR_BASE)MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a3f09cd8c9167b802029195c759770966">dwRemoteHost</a>, DNS_TYPE_A);</div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;                }</div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;                </div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a979649935757125e531ffac76be1200c">TCP_DNS_RESOLVE</a>:</div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;            {</div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;                IP_ADDR ipResolvedDNSIP;</div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;                <span class="comment">// See if DNS resolution has finished.  Note that if the DNS </span></div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;                <span class="comment">// fails, the &amp;ipResolvedDNSIP will be written with 0x00000000. </span></div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;                <span class="comment">// MyTCB.remote.dwRemoteHost is unioned with </span></div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;                <span class="comment">// MyTCB.remote.niRemoteMACIP.IPAddr, so we can&#39;t directly write </span></div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;                <span class="comment">// the DNS result into MyTCB.remote.niRemoteMACIP.IPAddr.  We </span></div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;                <span class="comment">// must copy it over only if the DNS is resolution step was </span></div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;                <span class="comment">// successful.</span></div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="_d_n_s_8h.html#a7568a1a127a88a9b1aa4d34abbd19b53">DNSIsResolved</a>(&amp;ipResolvedDNSIP))</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;                {</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="_d_n_s_8h.html#a27e8ba4b66a0d78061be23911cd3a426">DNSEndUsage</a>())</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;                    {</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr.Val = ipResolvedDNSIP.Val;</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a18cd650b4f424753ccb3c7a5d3e317c6">TCP_GATEWAY_SEND_ARP</a>;</div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = (MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr.w[1]+MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr.w[0] + MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>) ^ MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> = 0;</div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a> = (TICK_SECOND/4)/256;</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;                    }</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;                    {</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + 10*TICK_SECOND;</div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a576f183bc25360e18be55ca92f4b18bb">TCP_GET_DNS_MODULE</a>;</div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;                    }</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;                }</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;            }</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;<span class="preprocessor">            #endif // #if defined(STACK_USE_DNS)</span></div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;                </div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a18cd650b4f424753ccb3c7a5d3e317c6">TCP_GATEWAY_SEND_ARP</a>:</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;                <span class="comment">// Obtain the MAC address associated with the server&#39;s IP address (either direct MAC address on same subnet, or the MAC address of the Gateway machine)</span></div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>();</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;                <a class="code" href="_a_r_p_8h.html#aa58da534afc0a0b8d9c87d7ec6a7c599">ARPResolve</a>(&amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr);</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a246f53628bdda1bc5bd5bda6eaf30f8f">TCP_GATEWAY_GET_ARP</a>;</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a246f53628bdda1bc5bd5bda6eaf30f8f">TCP_GATEWAY_GET_ARP</a>:</div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;                <span class="comment">// Wait for the MAC address to finish being obtained</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;                <span class="keywordflow">if</span>(!<a class="code" href="_a_r_p_8h.html#ab6db95d6f77786a0e13c0bda086c958a">ARPIsResolved</a>(&amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr, &amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.MACAddr))</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;                {</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;                    <span class="comment">// Time out if too much time is spent in this state</span></div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;                    <span class="comment">// Note that this will continuously send out ARP </span></div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;                    <span class="comment">// requests for an infinite time if the Gateway </span></div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;                    <span class="comment">// never responds</span></div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;                    <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">eventTime2</a> &gt; (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a>)</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;                    {</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;                        <span class="comment">// Exponentially increase timeout until we reach 6 attempts then stay constant</span></div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;                        <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> &lt; 6u)</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;                        {</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;                            MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a>++;</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;                            MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a> &lt;&lt;= 1;</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;                        }</div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;                        <span class="comment">// Retransmit ARP request</span></div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a18cd650b4f424753ccb3c7a5d3e317c6">TCP_GATEWAY_SEND_ARP</a>;</div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;                    }</div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;                }</div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;                </div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;                <span class="comment">// Send out SYN connection request to remote node</span></div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;                <span class="comment">// This automatically disables the Timer from </span></div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;                <span class="comment">// continuously firing for this socket</span></div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;                vFlags = SYN;</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;                bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a8d61cf0dd6dacc41f87a1ed05766365c">TCP_SYN_SENT</a>;</div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;<span class="preprocessor">            #endif // #if defined(STACK_CLIENT_MODE)</span></div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;            </div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a8d61cf0dd6dacc41f87a1ed05766365c">TCP_SYN_SENT</a>:</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;                <span class="comment">// Keep sending SYN until we hear from remote node.</span></div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;                <span class="comment">// This may be for infinite time, in that case</span></div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;                <span class="comment">// caller must detect it and do something.</span></div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;                vFlags = SYN;</div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;                bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;                <span class="comment">// Exponentially increase timeout until we reach TCP_MAX_RETRIES attempts then stay constant</span></div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> &gt;= (TCP_MAX_RETRIES - 1))</div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;                {</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> = TCP_MAX_RETRIES - 1;</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a> = TCP_START_TIMEOUT_VAL&lt;&lt;(TCP_MAX_RETRIES-1);</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;                }</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    </div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a>:</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;                <span class="comment">// We must receive ACK before timeout expires.</span></div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;                <span class="comment">// If not, resend SYN+ACK.</span></div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;                <span class="comment">// Abort, if maximum attempts counts are reached.</span></div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> &lt; TCP_MAX_SYN_RETRIES)</div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;                {</div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;                    vFlags = SYN | ACK;</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;                    bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;                }</div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;                {</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;                    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">bServer</a>)</div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;                    {</div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;                        vFlags = RST | ACK;</div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;                        bCloseSocket = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;                    }</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;                    {</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;                        vFlags = SYN;</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;                    }</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;                }</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    </div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>:</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a>:</div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;                <span class="comment">// Retransmit any unacknowledged data</span></div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> &lt; TCP_MAX_RETRIES)</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;                {</div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;                    vFlags = ACK;</div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;                    bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;                }</div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;                {</div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;                    <span class="comment">// No response back for too long, close connection</span></div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;                    <span class="comment">// This could happen, for instance, if the communication </span></div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;                    <span class="comment">// medium was lost</span></div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a>;</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;                    vFlags = FIN | ACK;</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;                }</div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;    </div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a>:</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> &lt; TCP_MAX_RETRIES)</div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;                {</div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;                    <span class="comment">// Send another FIN</span></div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;                    vFlags = FIN | ACK;</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;                    bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;                }</div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;                {</div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;                    <span class="comment">// Close on our own, we can&#39;t seem to communicate </span></div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;                    <span class="comment">// with the remote node anymore</span></div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;                    vFlags = RST | ACK;</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;                    bCloseSocket = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;                }</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;    </div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c">TCP_FIN_WAIT_2</a>:</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;                <span class="comment">// Close on our own, we can&#39;t seem to communicate </span></div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;                <span class="comment">// with the remote node anymore</span></div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;                vFlags = RST | ACK;</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;                bCloseSocket = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a62d0ebf32025a28195c2d8e87e68f3af">TCP_CLOSING</a>:</div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> &lt; TCP_MAX_RETRIES)</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;                {</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;                    <span class="comment">// Send another ACK+FIN (the FIN is retransmitted </span></div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;                    <span class="comment">// automatically since it hasn&#39;t been acknowledged by </span></div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;                    <span class="comment">// the remote node yet)</span></div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;                    vFlags = ACK;</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;                    bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;                }</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;                {</div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;                    <span class="comment">// Close on our own, we can&#39;t seem to communicate </span></div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;                    <span class="comment">// with the remote node anymore</span></div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;                    vFlags = RST | ACK;</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;                    bCloseSocket = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;                }</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;    </div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;<span class="comment">//          case TCP_TIME_WAIT:</span></div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;<span class="comment">//              // Wait around for a while (2MSL) and then goto closed state</span></div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;<span class="comment">//              bCloseSocket = TRUE;</span></div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;<span class="comment">//              break;</span></div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;<span class="comment">//          </span></div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;</div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a>:</div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;                <span class="comment">// Send some more FINs or close anyway</span></div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> &lt; TCP_MAX_RETRIES)</div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;                {</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;                    vFlags = FIN | ACK;</div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;                    bRetransmit = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;                }</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;                {</div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;                    vFlags = RST | ACK;</div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;                    bCloseSocket = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;                }</div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;            </div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;            <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;        }</div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;</div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;        <span class="keywordflow">if</span>(vFlags)</div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;        {</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;            <span class="comment">// Transmit all unacknowledged data over again</span></div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;            <span class="keywordflow">if</span>(bRetransmit)</div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;            {</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;                <span class="comment">// Set the appropriate retry time</span></div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a>++;</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a> &lt;&lt;= 1;</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;        </div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;                <span class="comment">// Calculate how many bytes we have to roll back and retransmit</span></div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;                w = MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>;</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>)</div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;                    w += MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;                </div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;                <span class="comment">// Perform roll back of local SEQuence counter, remote window </span></div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;                <span class="comment">// adjustment, and cause all unacknowledged data to be </span></div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;                <span class="comment">// retransmitted by moving the unacked tail pointer.</span></div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> -= w;</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> += w;</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>;     </div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;                SendTCP(vFlags, 0);</div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;            }</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;                SendTCP(vFlags, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;        }</div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;        </div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;        <span class="keywordflow">if</span>(bCloseSocket)</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;            CloseSocket();</div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;    }</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;    </div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;    </div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;<span class="preprocessor">    #if TCP_SYN_QUEUE_MAX_ENTRIES</span></div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;        <span class="comment">// Process SYN Queue entry timeouts</span></div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;        <span class="keywordflow">for</span>(w = 0; w &lt; TCP_SYN_QUEUE_MAX_ENTRIES; w++)</div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;        {</div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;            <span class="comment">// Abort search if there are no more valid records</span></div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;            <span class="keywordflow">if</span>(SYNQueue[w].wDestPort == 0u)</div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;            </div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;            <span class="comment">// See if this SYN has timed out</span></div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;            <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() - SYNQueue[w].wTimestamp &gt; (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)(TCP_SYN_QUEUE_TIMEOUT/256ull))</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;            {</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;                <span class="comment">// Delete this SYN from the SYNQueue and compact the SYNQueue[] array</span></div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;                TCPRAMCopy((PTR_BASE)&amp;SYNQueue[w], <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, (PTR_BASE)&amp;SYNQueue[w+1], <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, (TCP_SYN_QUEUE_MAX_ENTRIES-1u-w)*<span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html">TCP_SYN_QUEUE</a>));</div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;                SYNQueue[TCP_SYN_QUEUE_MAX_ENTRIES-1].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a4a73e1502cba148db181af196cdf145a">wDestPort</a> = 0u;</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    </div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;                <span class="comment">// Since we deleted an entry, we need to roll back one </span></div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;                <span class="comment">// index so next loop will process the correct record</span></div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;                w--;    </div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;            }</div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;        }</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;}</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;<span class="comment">    BOOL TCPProcess(NODE_INFO* remote, IP_ADDR* localIP, WORD len)</span></div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;<span class="comment">    Handles incoming TCP segments.</span></div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;<span class="comment">    This function handles incoming TCP segments.  When a segment arrives, it</span></div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;<span class="comment">    is compared to open sockets using a hash of the remote port and IP.  </span></div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;<span class="comment">    On a match, the data is passed to HandleTCPSeg for further processing.</span></div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;<span class="comment">    TCP is initialized and a TCP segment is ready in the MAC buffer.</span></div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;<span class="comment">    remote - Remote NODE_INFO structure</span></div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;<span class="comment">    localIP - This stack&#39;s IP address (for header checking)</span></div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;<span class="comment">    len - Total length of the waiting TCP segment</span></div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;<span class="comment">    TRUE - the segment was properly handled.</span></div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;<span class="comment">    FALSE - otherwise</span></div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l02811"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a1fa693b8370b2bb1f10823881a95612c"> 2811</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#a1fa693b8370b2bb1f10823881a95612c">TCPProcess</a>(<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>* remote, IP_ADDR* localIP, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len)</div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;{</div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;    <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>      TCPHeader;</div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;    <a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html">PSEUDO_HEADER</a>   pseudoHeader;</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;    <a class="code" href="union_w_o_r_d___v_a_l.html">WORD_VAL</a>        checksum1;</div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;    <a class="code" href="union_w_o_r_d___v_a_l.html">WORD_VAL</a>        checksum2;</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>            optionsSize;</div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;</div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;    <span class="comment">// Calculate IP pseudoheader checksum.</span></div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a89fa95e930f178cad3eae53104b93622">SourceAddress</a>      = remote-&gt;IPAddr;</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a3116a419f3c363294726255181ca77c7">DestAddress</a>        = *localIP;</div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#aa6d4c439169ac792940a0ba329d64e25">Zero</a>               = 0x0;</div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a4e3381dd4fcd372f6f4fb0b2577e541a">Protocol</a>           = IP_PROT_TCP;</div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a>             = len;</div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;</div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;    SwapPseudoHeader(pseudoHeader);</div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;    checksum1.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = ~<a class="code" href="_helpers_8h.html#a9274752ec58a3cc6b2a9518a6e417fc3">CalcIPChecksum</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;pseudoHeader,</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;        <span class="keyword">sizeof</span>(pseudoHeader));</div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;</div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;    <span class="comment">// Now calculate TCP packet checksum in NIC RAM - should match</span></div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;    <span class="comment">// pesudo header checksum</span></div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;    checksum2.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = <a class="code" href="_m_a_c_8h.html#af14a0a88eef0ca101814acf1157f42a3">CalcIPBufferChecksum</a>(len);</div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;    <span class="comment">// Compare checksums.</span></div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;    <span class="keywordflow">if</span>(checksum1.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> != checksum2.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>)</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;    {</div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;        <a class="code" href="_m_a_c_8h.html#a6f0a2614cde1253e6edcc78d1a069b79">MACDiscardRx</a>();</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;    }</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;</div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;<span class="preprocessor">#if defined(DEBUG_GENERATE_RX_LOSS)</span></div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;    <span class="comment">// Throw RX packets away randomly</span></div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="_helpers_8h.html#aa96b3af9ccf2d7d2a4558708b90981cd">LFSRRand</a>() &gt; DEBUG_GENERATE_RX_LOSS)</div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;    {</div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;        <a class="code" href="_m_a_c_8h.html#a6f0a2614cde1253e6edcc78d1a069b79">MACDiscardRx</a>();</div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;    }</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;</div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;    <span class="comment">// Retrieve TCP header.</span></div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;    <a class="code" href="_i_p_8h.html#a33cd719865ee57f9591c92a63e74d59f">IPSetRxBuffer</a>(0);</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    <a class="code" href="_m_a_c_8h.html#a89d13e85195c0d00f308194305845016">MACGetArray</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;TCPHeader, <span class="keyword">sizeof</span>(TCPHeader));</div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;    SwapTCPHeader(&amp;TCPHeader);</div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;</div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;    <span class="comment">// Skip over options to retrieve data bytes</span></div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;    optionsSize = (<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>)((TCPHeader.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a57bf620571057a239c31978ce012adfa">DataOffset</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a5822b7000f077dc1e2f88a31a6b89a39">Val</a> &lt;&lt; 2)-</div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;        <span class="keyword">sizeof</span>(TCPHeader));</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;    len = len - optionsSize - <span class="keyword">sizeof</span>(TCPHeader);</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;</div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;    <span class="comment">// Find matching socket.</span></div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;    <span class="keywordflow">if</span>(FindMatchingSocket(&amp;TCPHeader, remote))</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;    {</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;<span class="preprocessor">        #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;        PTR_BASE prevRxHead;</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;        <span class="comment">// For SSL connections, show HandleTCPSeg() the full data buffer</span></div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;        prevRxHead = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a>;</div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;        </div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;        HandleTCPSeg(&amp;TCPHeader, len);</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;        </div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;<span class="preprocessor">        #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;        {</div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;            <span class="comment">// Restore the buffer state</span></div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = prevRxHead;</div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;            <span class="comment">// Process the new SSL data, using the currently loaded stub</span></div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;            <a class="code" href="_t_c_p_8c.html#ad03097c0020aa6abe8446835dde60c9a">TCPSSLHandleIncoming</a>(hCurrentTCP);</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;        }</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;    }</div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;<span class="comment">//  else</span></div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;<span class="comment">//  {</span></div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;<span class="comment">//      // NOTE: RFC 793 specifies that if the socket is closed and a segment </span></div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;<span class="comment">//      // arrives, we should send back a RST if the RST bit in the incoming </span></div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;<span class="comment">//      // packet is not set.  Instead, we will just silently ignore such a </span></div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;<span class="comment">//      // packet since this is what firewalls do on purpose to enhance </span></div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;<span class="comment">//      // security.</span></div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;<span class="comment">//      //if(!TCPHeader.Flags.bits.flagRST)</span></div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;<span class="comment">//      //  SendTCP(RST, SENDTCP_RESET_TIMERS);</span></div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;<span class="comment">//  }</span></div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;    <span class="comment">// Finished with this packet, discard it and free the Ethernet RAM for new packets</span></div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;    <a class="code" href="_m_a_c_8h.html#a6f0a2614cde1253e6edcc78d1a069b79">MACDiscardRx</a>();</div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;</div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;}</div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;</div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;</div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;<span class="comment">    static void SendTCP(BYTE vTCPFlags, BYTE vSendFlags)</span></div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;<span class="comment">    Transmits a TPC segment.</span></div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;<span class="comment">    This function assembles and transmits a TCP segment, including any </span></div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;<span class="comment">    pending data.  It also supports retransmissions, keep-alives, and </span></div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;<span class="comment">    other packet types.</span></div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;<span class="comment">    vTCPFlags - Additional TCP flags to include</span></div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;<span class="comment">    vSendFlags - Any combinations of SENDTCP_* constants to modify the</span></div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;<span class="comment">                 transmit behavior or contents.</span></div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> SendTCP(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vTCPFlags, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vSendFlags)</div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;{</div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;    <a class="code" href="union_w_o_r_d___v_a_l.html">WORD_VAL</a>        wVal;</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;    <a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>      header;</div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;    <a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html">TCP_OPTIONS</a>     options;</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;    <a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html">PSEUDO_HEADER</a>   pseudoHeader;</div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>            len;</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;    </div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;    SyncTCB();</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;</div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;    <span class="comment">// FINs must be handled specially</span></div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;    <span class="keywordflow">if</span>(vTCPFlags &amp; FIN)</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;    {</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2b4e5624c7ff0110540b0b87b484c636">bTXFIN</a> = 1;</div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;        vTCPFlags &amp;= ~FIN;</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;    }</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;    <span class="comment">// Status will now be synched, disable automatic future </span></div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;    <span class="comment">// status transmissions</span></div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a> = 0;</div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a97e8fa1695ed948d0a715a3b96bb6d8d">bDelayedACKTimerEnabled</a> = 0;</div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a64467e967affbc7f3bd04af24a62255f">bOneSegmentReceived</a> = 0;</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#abf1b4439c5f152ddb383859e5a0f3bd3">bTXASAP</a> = 0;</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a> = 0;</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a> = 0;</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;</div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;    <span class="comment">//  Make sure that we can write to the MAC transmit area</span></div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;    <span class="keywordflow">while</span>(!IPIsTxReady());</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;</div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;    <span class="comment">// Put all socket application data in the TX space</span></div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;    <span class="keywordflow">if</span>(vTCPFlags &amp; (SYN | RST))</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;    {</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;        <span class="comment">// Don&#39;t put any data in SYN and RST messages</span></div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;        len = 0;</div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;    }</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;    {</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;        <span class="comment">// Begin copying any application data over to the TX space</span></div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> == MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>)</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;        {</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;            <span class="comment">// All caught up on data TX, no real data for this packet</span></div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;            len = 0;</div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;        }</div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> &gt; MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>)</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;        {</div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;            len = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> - MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>;</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;            <span class="keywordflow">if</span>(len &gt; MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a>)</div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;                len = MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a>;</div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;            <span class="keywordflow">if</span>(len &gt; MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a>)</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;            {</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;                len = MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a>;</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a> = 1;</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;            }</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;</div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;            <span class="comment">// Copy application data into the raw TX buffer</span></div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;            TCPRAMCopy(BASE_TX_ADDR+<span class="keyword">sizeof</span>(<a class="code" href="_m_a_c_8h.html#a0b66f1eb742dfdf0080a00214dce87e6">ETHER_HEADER</a>)+<span class="keyword">sizeof</span>(<a class="code" href="struct___i_p___h_e_a_d_e_r.html">IP_HEADER</a>)+<span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>), <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, len);</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> += len;</div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;        }</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;        {</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;            pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>;</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;            len = pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a> + MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;</div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;            <span class="keywordflow">if</span>(len &gt; MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a>)</div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;                len = MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a>;</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;</div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;            <span class="keywordflow">if</span>(len &gt; MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a>)</div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;            {</div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;                len = MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a>;</div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a> = 1;</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;            }</div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;            <span class="keywordflow">if</span>(pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a> &gt; len)</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;                pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a> = len;</div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;            <span class="comment">// Copy application data into the raw TX buffer</span></div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;            TCPRAMCopy(BASE_TX_ADDR+<span class="keyword">sizeof</span>(<a class="code" href="_m_a_c_8h.html#a0b66f1eb742dfdf0080a00214dce87e6">ETHER_HEADER</a>)+<span class="keyword">sizeof</span>(<a class="code" href="struct___i_p___h_e_a_d_e_r.html">IP_HEADER</a>)+<span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>), <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a>);</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;            pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a> = len - pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a>;</div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;    </div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;            <span class="comment">// Copy any left over chunks of application data over</span></div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;            <span class="keywordflow">if</span>(pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a>)</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;            {</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;                TCPRAMCopy(BASE_TX_ADDR+<span class="keyword">sizeof</span>(<a class="code" href="_m_a_c_8h.html#a0b66f1eb742dfdf0080a00214dce87e6">ETHER_HEADER</a>)+<span class="keyword">sizeof</span>(<a class="code" href="struct___i_p___h_e_a_d_e_r.html">IP_HEADER</a>)+<span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>)+(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>), <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a>);</div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;            }</div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;</div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> += len;</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;        }</div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;</div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;        <span class="comment">// If we are to transmit a FIN, make sure we can put one in this packet</span></div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2b4e5624c7ff0110540b0b87b484c636">bTXFIN</a>)</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;        {</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;            <span class="keywordflow">if</span>((len != MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a>) &amp;&amp; (len != MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a>))</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;                vTCPFlags |= FIN;</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;        }</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;    }</div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;    <span class="comment">// Ensure that all packets with data of some kind are </span></div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;    <span class="comment">// retransmitted by TCPTick() until acknowledged</span></div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;    <span class="comment">// Pure ACK packets with no data are not ACKed back in TCP</span></div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;    <span class="keywordflow">if</span>(len || (vTCPFlags &amp; (SYN | FIN)))</div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;    {</div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;        <span class="comment">// Transmitting data, update remote window variable to reflect smaller </span></div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;        <span class="comment">// window.</span></div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;        MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> -= len;</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;</div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;        <span class="comment">// Push (PSH) all data for enhanced responsiveness on </span></div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;        <span class="comment">// the remote end, especially with GUIs</span></div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;        <span class="keywordflow">if</span>(len)</div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;            vTCPFlags |= PSH;</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;</div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;        <span class="keywordflow">if</span>(vSendFlags &amp; SENDTCP_RESET_TIMERS)</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;        {</div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a> = 0;</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a> = TCP_START_TIMEOUT_VAL;</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;        }   </div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a>;</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a> = 1;</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;    }</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(vSendFlags &amp; SENDTCP_KEEP_ALIVE)</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;    {</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;        <span class="comment">// Increment Keep Alive TX counter to handle disconnection if not response is returned</span></div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa2eabcef6e3f7cb140ddc43f3b0f01f2">vUnackedKeepalives</a>++;</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;        </div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;        <span class="comment">// Generate a dummy byte</span></div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;        MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> -= 1;</div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;        len = 1;</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;    }</div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a>) </div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;    {</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;        <span class="comment">// If we have data to transmit, but the remote RX window is zero, </span></div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;        <span class="comment">// so we aren&#39;t transmitting any right now then make sure to not </span></div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;        <span class="comment">// extend the retry counter or timer.  This will stall our TX </span></div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;        <span class="comment">// with a periodic ACK sent to the remote node.</span></div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;        <span class="keywordflow">if</span>(!(vSendFlags &amp; SENDTCP_RESET_TIMERS))</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;        {</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;            <span class="comment">// Roll back retry counters since we can&#39;t send anything, </span></div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;            <span class="comment">// but only if we incremented it in the first place</span></div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a>)</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;            {</div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">retryCount</a>--;</div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a> &gt;&gt;= 1;</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;            }</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;        }</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;    </div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + MyTCB.<a class="code" href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">retryInterval</a>;</div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;    }</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;    </div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>           = MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>             = MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">SeqNumber</a>            = MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>;</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">AckNumber</a>            = MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a>;</div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a246b502fed0f04ba167ba7b4e998e1a7">Flags</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a3ed294cd22f01bf2937a879fe3e73bfc">bits</a>.Reserved2 = 0;</div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a57bf620571057a239c31978ce012adfa">DataOffset</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a34c940d4eee891fd1a8ac0c77091d1cb">Reserved3</a> = 0;</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a246b502fed0f04ba167ba7b4e998e1a7">Flags</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a4ec262e8432e722273b67cea923f72a6">byte</a>           = vTCPFlags;</div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a17e1de1a82c0beee37397a59a7d8c812">UrgentPointer</a>        = 0;</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;    <span class="comment">// Update our send sequence number and ensure retransmissions </span></div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;    <span class="comment">// of SYNs and FINs use the right sequence number</span></div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> += (<a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>)len;</div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;    <span class="keywordflow">if</span>(vTCPFlags &amp; SYN)</div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;    {</div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;        <span class="comment">// SEG.ACK needs to be zero for the first SYN packet for compatibility </span></div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;        <span class="comment">// with certain paranoid TCP/IP stacks, even though the ACK flag isn&#39;t </span></div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;        <span class="comment">// set (indicating that the AckNumber field is unused).</span></div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;        <span class="keywordflow">if</span>(!(vTCPFlags &amp; ACK))</div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;            header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">AckNumber</a> = 0x00000000;</div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;</div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;        <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a5d60ed0da9975f201bdb5832564f24a2">bSYNSent</a>)</div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;            header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">SeqNumber</a>--;</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;        {</div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>++;</div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a5d60ed0da9975f201bdb5832564f24a2">bSYNSent</a> = 1;</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;        }</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;    }</div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;    <span class="keywordflow">if</span>(vTCPFlags &amp; FIN)</div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;    {</div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;        MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#ae7e84a3fa64de6e94ad093b762400e10">bFINSent</a> = 1;   <span class="comment">// do not advance the seq no for FIN!</span></div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;    }</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;    <span class="comment">// Calculate the amount of free space in the RX buffer area of this socket</span></div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>)</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;        header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a> = (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>) - (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>);</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;        header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> - 1;</div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;    <span class="comment">// Calculate the amount of free space in the MAC RX buffer area and adjust window if needed</span></div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;    wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = <a class="code" href="_m_a_c_8h.html#a853f9bc96814d6d6ff8ef7a19f84d973">MACGetFreeRxSize</a>();</div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;    <span class="keywordflow">if</span>(wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> &lt; 64)</div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;    {</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;        wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = 0;</div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;    }</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;    {</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;        wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> -= 64;</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;    }</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;    <span class="comment">// Force the remote node to throttle back if we are running low on general RX buffer space</span></div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;    <span class="keywordflow">if</span>(header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a> &gt; wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>)</div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;        header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a> = wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;</div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;    SwapTCPHeader(&amp;header);</div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;</div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;</div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;    len += <span class="keyword">sizeof</span>(header);</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a57bf620571057a239c31978ce012adfa">DataOffset</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a5822b7000f077dc1e2f88a31a6b89a39">Val</a>   = <span class="keyword">sizeof</span>(header) &gt;&gt; 2;</div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;</div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;    <span class="comment">// Insert the MSS (Maximum Segment Size) TCP option if this is SYN packet</span></div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;    <span class="keywordflow">if</span>(vTCPFlags &amp; SYN)</div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;    {</div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;        len += <span class="keyword">sizeof</span>(options);</div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;        options.<a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html#a7c46116cbd9a8db99e5d33283345e524">Kind</a> = TCP_OPTIONS_MAX_SEG_SIZE;</div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;        options.<a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html#ae875c7698e130ba8324b8746c3ef7a11">Length</a> = 0x04;</div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;</div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;        <span class="comment">// Load MSS and swap to big endian</span></div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;        options.<a class="code" href="struct_t_c_p___o_p_t_i_o_n_s.html#a4414eab3a6c9ce2fa592d8917a143515">MaxSegSize</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = (((TCP_MAX_SEG_SIZE_RX)&amp;0x00FF)&lt;&lt;8) | (((TCP_MAX_SEG_SIZE_RX)&amp;0xFF00)&gt;&gt;8);</div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;</div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;        header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a57bf620571057a239c31978ce012adfa">DataOffset</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a5822b7000f077dc1e2f88a31a6b89a39">Val</a>   += <span class="keyword">sizeof</span>(options) &gt;&gt; 2;</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;    }</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;    <span class="comment">// Calculate IP pseudoheader checksum.</span></div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a89fa95e930f178cad3eae53104b93622">SourceAddress</a>  = <a class="code" href="_stack_tsk_8h.html#a67540808395519081be1333c4e9aa1f8">AppConfig</a>.MyIPAddr;</div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a3116a419f3c363294726255181ca77c7">DestAddress</a>    = MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr;</div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#aa6d4c439169ac792940a0ba329d64e25">Zero</a>           = 0x0;</div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a4e3381dd4fcd372f6f4fb0b2577e541a">Protocol</a>       = IP_PROT_TCP;</div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;    pseudoHeader.<a class="code" href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">Length</a>         = len;</div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;    SwapPseudoHeader(pseudoHeader);</div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;    header.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a85011e0b7801556de62f34a465135806">Checksum</a> = ~<a class="code" href="_helpers_8h.html#a9274752ec58a3cc6b2a9518a6e417fc3">CalcIPChecksum</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;pseudoHeader, <span class="keyword">sizeof</span>(pseudoHeader));</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;</div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;    <span class="comment">// Write IP header</span></div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;    <a class="code" href="_m_a_c_8h.html#a76abcd85736be75ac9dee35b573bb90d">MACSetWritePtr</a>(BASE_TX_ADDR + <span class="keyword">sizeof</span>(<a class="code" href="_m_a_c_8h.html#a0b66f1eb742dfdf0080a00214dce87e6">ETHER_HEADER</a>));</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;    <a class="code" href="_i_p_8h.html#ad3bcc7a7c328bc6435c97646a25d21f0">IPPutHeader</a>(&amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>, IP_PROT_TCP, len);</div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;    <a class="code" href="_m_a_c_8h.html#a87a779bb5e5f2c7ffc444f52d696efa2">MACPutArray</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;header, <span class="keyword">sizeof</span>(header));</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;    <span class="keywordflow">if</span>(vTCPFlags &amp; SYN)</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;        <a class="code" href="_m_a_c_8h.html#a87a779bb5e5f2c7ffc444f52d696efa2">MACPutArray</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;options, <span class="keyword">sizeof</span>(options));</div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;</div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;    <span class="comment">// Update the TCP checksum</span></div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;    <a class="code" href="_m_a_c_8h.html#aad63644420d87642a890d2f41abb7454">MACSetReadPtr</a>(BASE_TX_ADDR + <span class="keyword">sizeof</span>(<a class="code" href="_m_a_c_8h.html#a0b66f1eb742dfdf0080a00214dce87e6">ETHER_HEADER</a>) + <span class="keyword">sizeof</span>(<a class="code" href="struct___i_p___h_e_a_d_e_r.html">IP_HEADER</a>));</div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;    wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = <a class="code" href="_m_a_c_8h.html#af14a0a88eef0ca101814acf1157f42a3">CalcIPBufferChecksum</a>(len);</div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;<span class="preprocessor">#if defined(DEBUG_GENERATE_TX_LOSS)</span></div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;    <span class="comment">// Damage TCP checksums on TX packets randomly</span></div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="_helpers_8h.html#aa96b3af9ccf2d7d2a4558708b90981cd">LFSRRand</a>() &gt; DEBUG_GENERATE_TX_LOSS)</div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;    {</div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;        wVal.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>++;</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;    }</div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;    <a class="code" href="_m_a_c_8h.html#a76abcd85736be75ac9dee35b573bb90d">MACSetWritePtr</a>(BASE_TX_ADDR + <span class="keyword">sizeof</span>(<a class="code" href="_m_a_c_8h.html#a0b66f1eb742dfdf0080a00214dce87e6">ETHER_HEADER</a>) + <span class="keyword">sizeof</span>(<a class="code" href="struct___i_p___h_e_a_d_e_r.html">IP_HEADER</a>) + 16);</div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;    <a class="code" href="_m_a_c_8h.html#a87a779bb5e5f2c7ffc444f52d696efa2">MACPutArray</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;wVal, <span class="keyword">sizeof</span>(<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>));</div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;</div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;    <span class="comment">// Physically start the packet transmission over the network</span></div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;    <a class="code" href="_m_a_c_8h.html#a38dc2cc8c71b2f6bfe51ea8db2acc67c">MACFlush</a>();</div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;}</div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;<span class="comment">    static BOOL FindMatchingSocket(TCP_HEADER* h, NODE_INFO* remote)</span></div>
<div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;<span class="comment">    Finds a suitable socket for a TCP segment.</span></div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;<span class="comment">    This function searches through the sockets and attempts to match one with</span></div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;<span class="comment">    a given TCP header and NODE_INFO structure.  If a socket is found, its </span></div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;<span class="comment">    index is saved in hCurrentTCP and the associated MyTCBStub and MyTCB are</span></div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;<span class="comment">    loaded. Otherwise, INVALID_SOCKET is placed in hCurrentTCP.</span></div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;<span class="comment">    h - TCP header to be matched against</span></div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;<span class="comment">    remote - The remote node who sent this header</span></div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;<span class="comment">    TRUE - A match was found and is loaded in hCurrentTCP</span></div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;<span class="comment">    FALSE - No suitable socket was found and hCurrentTCP is INVALID_SOCKET</span></div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;<span class="keyword">static</span> <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> FindMatchingSocket(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>* h, <a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>* remote)</div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;{</div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;    <a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP;</div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;    <a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> partialMatch;</div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> hash;</div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;</div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;    <span class="comment">// Prevent connections on invalid port 0</span></div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;    <span class="keywordflow">if</span>(h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a> == 0u)</div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;</div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;    partialMatch = INVALID_SOCKET;</div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;    hash = (remote-&gt;IPAddr.w[1]+remote-&gt;IPAddr.w[0] + h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>) ^ h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>;</div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;</div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;    <span class="comment">// Loop through all sockets looking for a socket that is expecting this </span></div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;    <span class="comment">// packet or can handle it.</span></div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;    <span class="keywordflow">for</span>(hTCP = 0; hTCP &lt; TCP_SOCKET_COUNT; hTCP++ )</div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;    {</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;        SyncTCBStub(hTCP);</div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a680a81a7e7676aef8d747d1e06610633">TCP_CLOSED</a>)</div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;        {</div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;        }</div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b">TCP_LISTEN</a>)</div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;        {<span class="comment">// For listening ports, check if this is the correct port</span></div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> == h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>)</div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;                partialMatch = hTCP;</div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;            </div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;<span class="preprocessor">            #if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;            <span class="comment">// Check the SSL port as well for SSL Servers</span></div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;            <span class="comment">// 0 is defined as an invalid port number</span></div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> == h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>)</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;                partialMatch = hTCP;</div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;            </div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;        }</div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> != hash)</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;        {<span class="comment">// Ignore if the hash doesn&#39;t match</span></div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;        }</div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;        SyncTCB();</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;        <span class="keywordflow">if</span>( h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a> == MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> &amp;&amp;</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;            h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a> == MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> &amp;&amp;</div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;            remote-&gt;IPAddr.Val == MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>.<a class="code" href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">niRemoteMACIP</a>.IPAddr.Val)</div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;        {</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;        }</div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;    }</div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;</div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;</div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;    <span class="comment">// If there is a partial match, then a listening socket is currently </span></div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;    <span class="comment">// available.  Set up the extended TCB with the info needed </span></div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;    <span class="comment">// to establish a connection and return this socket to the </span></div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;    <span class="comment">// caller.</span></div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;    <span class="keywordflow">if</span>(partialMatch != INVALID_SOCKET)</div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;    {</div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;        SyncTCBStub(partialMatch);</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;        SyncTCB();</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;    </div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;        <span class="comment">// For SSL ports, begin the SSL Handshake</span></div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;<span class="preprocessor">        #if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> == h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>)</div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;        {</div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;            <span class="comment">// Try to start an SSL session.  If no stubs are available,</span></div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;            <span class="comment">// we can&#39;t service this request right now, so ignore it.</span></div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;            <span class="keywordflow">if</span>(!<a class="code" href="_t_c_p_8c.html#a9be64cc028f6aef8bc603abb10073639">TCPStartSSLServer</a>(partialMatch))</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;                partialMatch = INVALID_SOCKET;</div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;        }</div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;    </div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;        <span class="comment">// Make sure the above check didn&#39;t fail (this is unfortunately </span></div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;        <span class="comment">// redundant for non-SSL sockets).  Otherwise, fall out to below</span></div>
<div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;        <span class="comment">// and add to the SYN queue.</span></div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;        <span class="keywordflow">if</span>(partialMatch != INVALID_SOCKET)</div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;        {</div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = hash;</div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;        </div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;            memcpy((<span class="keywordtype">void</span>*)&amp;MyTCB.<a class="code" href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">remote</a>, (<span class="keywordtype">void</span>*)remote, <span class="keyword">sizeof</span>(<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>));</div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">remotePort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>;</div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>;</div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;        </div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;            <span class="comment">// All done, and we have a match</span></div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;        }</div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;    }</div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;</div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;    <span class="comment">// No available sockets are listening on this port.  (Or, for</span></div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;    <span class="comment">// SSL requests, perhaps no SSL sessions were available.  However,</span></div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;    <span class="comment">// there may be a server socket which is currently busy but </span></div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;    <span class="comment">// could handle this packet, so we should check.</span></div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;<span class="preprocessor">    #if TCP_SYN_QUEUE_MAX_ENTRIES</span></div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;    {</div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;        <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wQueueInsertPos;</div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;        </div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;        <span class="comment">// See if this is a SYN packet</span></div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;        <span class="keywordflow">if</span>(!h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a246b502fed0f04ba167ba7b4e998e1a7">Flags</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a3ed294cd22f01bf2937a879fe3e73bfc">bits</a>.flagSYN)</div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;</div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;        <span class="comment">// See if there is space in our SYN queue</span></div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;        <span class="keywordflow">if</span>(SYNQueue[TCP_SYN_QUEUE_MAX_ENTRIES-1].wDestPort)</div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;        </div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;        <span class="comment">// See if we have this SYN already in our SYN queue.</span></div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;        <span class="comment">// If not already in the queue, find out where we </span></div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;        <span class="comment">// should insert this SYN to the queue</span></div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;        <span class="keywordflow">for</span>(wQueueInsertPos = 0; wQueueInsertPos &lt; TCP_SYN_QUEUE_MAX_ENTRIES; wQueueInsertPos++)</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;        {</div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;            <span class="comment">// Exit loop if we found a free record</span></div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;            <span class="keywordflow">if</span>(SYNQueue[wQueueInsertPos].wDestPort == 0u)</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;</div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;            <span class="comment">// Check if this SYN packet is already in the SYN queue</span></div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;            <span class="keywordflow">if</span>(SYNQueue[wQueueInsertPos].wDestPort != h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>)</div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;            <span class="keywordflow">if</span>(SYNQueue[wQueueInsertPos].wSourcePort != h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>)</div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;            <span class="keywordflow">if</span>(SYNQueue[wQueueInsertPos].niSourceAddress.IPAddr.Val != remote-&gt;IPAddr.Val)</div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;</div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;            <span class="comment">// SYN matches SYN queue entry.  Update timestamp and do nothing.</span></div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;            SYNQueue[wQueueInsertPos].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a0aa09af9f70a0f4959f9d8949c04df35">wTimestamp</a> = <a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>();</div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;        }</div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;        </div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;        <span class="comment">// Check to see if we have any server sockets which </span></div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;        <span class="comment">// are currently connected, but could handle this SYN </span></div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;        <span class="comment">// request at a later time if the client disconnects.</span></div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;        <span class="keywordflow">for</span>(hTCP = 0; hTCP &lt; TCP_SOCKET_COUNT; hTCP++)</div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;        {</div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;            SyncTCBStub(hTCP);</div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;            <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">bServer</a>)</div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;</div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;            SyncTCB();</div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;<span class="preprocessor">            #if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;            <span class="keywordflow">if</span>((MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> != h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>) &amp;&amp; (MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> != h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>))</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;<span class="preprocessor">            #else</span></div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> != h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>)</div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;<span class="preprocessor">            #endif</span></div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;</div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;            <span class="comment">// Generate the SYN queue entry</span></div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;            memcpy((<span class="keywordtype">void</span>*)&amp;SYNQueue[wQueueInsertPos].niSourceAddress, (<span class="keywordtype">void</span>*)remote, <span class="keyword">sizeof</span>(<a class="code" href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a>));</div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;            SYNQueue[wQueueInsertPos].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ad129842efc936a38e329384496850daf">wSourcePort</a> = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>;</div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;            SYNQueue[wQueueInsertPos].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ab040df9bb3ca4da90ebc0b1b59a6a618">dwSourceSEQ</a> = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">SeqNumber</a>;</div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;            SYNQueue[wQueueInsertPos].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a4a73e1502cba148db181af196cdf145a">wDestPort</a> = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>;</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;            SYNQueue[wQueueInsertPos].<a class="code" href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a0aa09af9f70a0f4959f9d8949c04df35">wTimestamp</a> = <a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>();</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;</div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;        }</div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;    }</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;        </div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;</div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;}</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;</div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;</div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;<span class="comment">    static void SwapTCPHeader(TCP_HEADER* header)</span></div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;<span class="comment">    Swaps endian-ness of a TCP header.</span></div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;<span class="comment">    This function swaps the endian-ness of a given TCP header for comparison.</span></div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;<span class="comment">    header - The TCP header that is to be swapped</span></div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> SwapTCPHeader(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>* header)</div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;{</div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;    header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>      = <a class="code" href="_helpers_8h.html#add09104747ab0b189bcd8137ab2458ea">swaps</a>(header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">SourcePort</a>);</div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;    header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>        = <a class="code" href="_helpers_8h.html#add09104747ab0b189bcd8137ab2458ea">swaps</a>(header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">DestPort</a>);</div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;    header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">SeqNumber</a>       = <a class="code" href="_helpers_8h.html#a8f07ee728c4a31e32ebf3ed585086b6a">swapl</a>(header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">SeqNumber</a>);</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;    header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">AckNumber</a>       = <a class="code" href="_helpers_8h.html#a8f07ee728c4a31e32ebf3ed585086b6a">swapl</a>(header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">AckNumber</a>);</div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;    header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a>          = <a class="code" href="_helpers_8h.html#add09104747ab0b189bcd8137ab2458ea">swaps</a>(header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a>);</div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;    header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a85011e0b7801556de62f34a465135806">Checksum</a>        = <a class="code" href="_helpers_8h.html#add09104747ab0b189bcd8137ab2458ea">swaps</a>(header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a85011e0b7801556de62f34a465135806">Checksum</a>);</div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;    header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a17e1de1a82c0beee37397a59a7d8c812">UrgentPointer</a>   = <a class="code" href="_helpers_8h.html#add09104747ab0b189bcd8137ab2458ea">swaps</a>(header-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a17e1de1a82c0beee37397a59a7d8c812">UrgentPointer</a>);</div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;}</div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;</div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;</div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;<span class="comment">    static void CloseSocket(void)</span></div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;<span class="comment">    Closes a TCP socket.</span></div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;<span class="comment">    This function closes a TCP socket.  All socket state information is </span></div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;<span class="comment">    reset, and any buffered bytes are discarded.  The socket is no longer</span></div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;<span class="comment">    accessible by the application after this point.</span></div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;<span class="comment">    The TCPStub corresponding to the socket to be closed is synced.</span></div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> CloseSocket(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;{</div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;    SyncTCB();</div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;</div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">bServer</a> ? <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b">TCP_LISTEN</a> : <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a680a81a7e7676aef8d747d1e06610633">TCP_CLOSED</a>;</div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa2eabcef6e3f7cb140ddc43f3b0f01f2">vUnackedKeepalives</a> = 0;</div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a> = 0;</div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">bTimer2Enabled</a> = 0;</div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a97e8fa1695ed948d0a715a3b96bb6d8d">bDelayedACKTimerEnabled</a> = 0;</div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a64467e967affbc7f3bd04af24a62255f">bOneSegmentReceived</a> = 0;</div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a> = 0;</div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#abf1b4439c5f152ddb383859e5a0f3bd3">bTXASAP</a> = 0;</div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a> = 0;</div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2b4e5624c7ff0110540b0b87b484c636">bTXFIN</a> = 0;</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a02643e9de8ceb55dd2a4669b53af4ba8">bSocketReset</a> = 1;</div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;</div>
<div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;    <span class="comment">// If SSL is active, then we need to close it</span></div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;    {</div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;        <a class="code" href="_s_s_l_8h.html#a420378f37017a1ddaee8c9f5a52b2077">SSLTerminate</a>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a>);</div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> = SSL_INVALID_ID;</div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;</div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;        <span class="comment">// Swap the SSL port and local port back to proper values</span></div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;        MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;        MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;    }</div>
<div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;    <span class="comment">// Reset the SSL buffer pointers</span></div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;    </div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;</div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#ae7e84a3fa64de6e94ad093b762400e10">bFINSent</a> = 0;</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a5d60ed0da9975f201bdb5832564f24a2">bSYNSent</a> = 0;</div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#acd4766b3fc8c443d8aceb1920fc58677">bRXNoneACKed1</a> = 0;</div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a22ffb6306d775b5180f9d9691240df08">bRXNoneACKed2</a> = 0;</div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;    ((<a class="code" href="union_d_w_o_r_d___v_a_l.html">DWORD_VAL</a>*)(&amp;MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>))-&gt;w[0] = <a class="code" href="_helpers_8h.html#aa96b3af9ccf2d7d2a4558708b90981cd">LFSRRand</a>();</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;    ((<a class="code" href="union_d_w_o_r_d___v_a_l.html">DWORD_VAL</a>*)(&amp;MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>))-&gt;w[1] = <a class="code" href="_helpers_8h.html#aa96b3af9ccf2d7d2a4558708b90981cd">LFSRRand</a>();</div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> = -1;</div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> = 1;</div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;}</div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;</div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;<span class="comment">    static WORD GetMaxSegSizeOption(void)</span></div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;<span class="comment">    Obtains the Maximum Segment Size (MSS) TCP Option out of the TCP header </span></div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;<span class="comment">    for the current socket.</span></div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;<span class="comment">    Parses the current TCP packet header and extracts the Maximum Segment Size </span></div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;<span class="comment">    option.  </span></div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;<span class="comment">    Must be called while a TCP packet is present and being processed via </span></div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;<span class="comment">    HandleTCPSeg() and only if the the TCP SYN flag is set.</span></div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;<span class="comment">    Maximum segment size option value.  If illegal or not present, a failsafe </span></div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;<span class="comment">    value of 536 is returned.  If the option is larger than the </span></div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;<span class="comment">    TCP_MAX_SEG_SIZE_TX upper limit, then TCP_MAX_SEG_SIZE_TX is returned.</span></div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;<span class="comment">    The internal MAC Read Pointer is moved but not restored.</span></div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;<span class="keyword">static</span> <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> GetMaxSegSizeOption(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;{</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vOptionsBytes;</div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vOption;</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wMSS;</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;</div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;    <span class="comment">// Find out how many options bytes are in this packet.</span></div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;    <a class="code" href="_i_p_8h.html#a33cd719865ee57f9591c92a63e74d59f">IPSetRxBuffer</a>(2+2+4+4); <span class="comment">// Seek to data offset field, skipping Source port (2), Destination port (2), Sequence number (4), and Acknowledgement number (4)</span></div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;    vOptionsBytes = <a class="code" href="_m_a_c_8h.html#a24b67ec68e80243ca4fdcfaaf0a91072">MACGet</a>();</div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;    vOptionsBytes = ((vOptionsBytes&amp;0xF0)&gt;&gt;2) - <span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>);</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;    <span class="comment">// Return minimum Maximum Segment Size value of 536 bytes if none are </span></div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;    <span class="comment">// present</span></div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;    <span class="keywordflow">if</span>(vOptionsBytes == 0u)</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;        <span class="keywordflow">return</span> 536;</div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;        </div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;    <span class="comment">// Seek to beginning of options</span></div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;    <a class="code" href="_m_a_c_8h.html#a89d13e85195c0d00f308194305845016">MACGetArray</a>(NULL, 7);</div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;</div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;    <span class="comment">// Search for the Maximum Segment Size option   </span></div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;    <span class="keywordflow">while</span>(vOptionsBytes--)</div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;    {</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;        vOption = <a class="code" href="_m_a_c_8h.html#a24b67ec68e80243ca4fdcfaaf0a91072">MACGet</a>();</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;        </div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;        <span class="keywordflow">if</span>(vOption == 0u)   <span class="comment">// End of Options list</span></div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;        </div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;        <span class="keywordflow">if</span>(vOption == 1u)   <span class="comment">// NOP option</span></div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;            </div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;        <span class="keywordflow">if</span>(vOption == 2u)   <span class="comment">// Maximum Segment Size option</span></div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;        {</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;            <span class="keywordflow">if</span>(vOptionsBytes &lt; 3u)</div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;</div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;            wMSS = 0;</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;                </div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;            <span class="comment">// Get option length</span></div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;            vOption = <a class="code" href="_m_a_c_8h.html#a24b67ec68e80243ca4fdcfaaf0a91072">MACGet</a>();</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;            <span class="keywordflow">if</span>(vOption == 4u)</div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;            {<span class="comment">// Retrieve MSS and swap value to little endian</span></div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;                ((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;wMSS)[1] = <a class="code" href="_m_a_c_8h.html#a24b67ec68e80243ca4fdcfaaf0a91072">MACGet</a>();</div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;                ((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;wMSS)[0] = <a class="code" href="_m_a_c_8h.html#a24b67ec68e80243ca4fdcfaaf0a91072">MACGet</a>();</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;            }</div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;            </div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;            <span class="keywordflow">if</span>(wMSS &lt; 536u)</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;            <span class="keywordflow">if</span>(wMSS &gt; TCP_MAX_SEG_SIZE_TX)</div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;                <span class="keywordflow">return</span> TCP_MAX_SEG_SIZE_TX;</div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;            <span class="keywordflow">else</span> </div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;                <span class="keywordflow">return</span> wMSS;</div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;        }</div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;        { <span class="comment">// Assume this is a multi byte option and throw it way</span></div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;            <span class="keywordflow">if</span>(vOptionsBytes &lt; 2u)</div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;            vOption = <a class="code" href="_m_a_c_8h.html#a24b67ec68e80243ca4fdcfaaf0a91072">MACGet</a>();</div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;            <span class="keywordflow">if</span>(vOptionsBytes &lt; vOption)</div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;            <a class="code" href="_m_a_c_8h.html#a89d13e85195c0d00f308194305845016">MACGetArray</a>(NULL, vOption);</div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;            vOptionsBytes -= vOption;</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;        }</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;        </div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;    }</div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;    </div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;    <span class="comment">// Did not find MSS option, return worst case default</span></div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;    <span class="keywordflow">return</span> 536;</div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;}</div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;</div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;<span class="comment">    static void HandleTCPSeg(TCP_HEADER* h, WORD len)</span></div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;<span class="comment">    Processes an incoming TCP segment.</span></div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;<span class="comment">    Once an incoming segment has been matched to a socket, this function</span></div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;<span class="comment">    performs the necessary processing with the data.  Depending on the </span></div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;<span class="comment">    segment and the state, this may include copying data to the TCP buffer,</span></div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;<span class="comment">    re-assembling out-of order packets, continuing an initialization or </span></div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;<span class="comment">    closing handshake, or closing the socket altogether.</span></div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;<span class="comment">    TCP is initialized and the current TCP stub is already synced.</span></div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;<span class="comment">    h - The TCP header for this packet</span></div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;<span class="comment">    len - The total buffer length of this segment</span></div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> HandleTCPSeg(<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a>* h, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len)</div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;{</div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a> dwTemp;</div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;    PTR_BASE wTemp;</div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a> lMissingBytes;</div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wMissingBytes;</div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wFreeSpace;</div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> localHeaderFlags;</div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a> localAckNumber;</div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a> localSeqNumber;</div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wSegmentLength;</div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> bSegmentAcceptable;</div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wNewWindow;</div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;</div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;</div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;    <span class="comment">// Cache a few variables in local RAM.  </span></div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;    <span class="comment">// PIC18s take a fair amount of code and execution time to </span></div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;    <span class="comment">// dereference pointers frequently.</span></div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;    localHeaderFlags = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a246b502fed0f04ba167ba7b4e998e1a7">Flags</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a4ec262e8432e722273b67cea923f72a6">byte</a>;</div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;    localAckNumber = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">AckNumber</a>;</div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;    localSeqNumber = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">SeqNumber</a>;</div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;</div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;    <span class="comment">// We received a packet, reset the keep alive timer and count</span></div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;<span class="preprocessor">    #if defined(TCP_KEEP_ALIVE_TIMEOUT)</span></div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa2eabcef6e3f7cb140ddc43f3b0f01f2">vUnackedKeepalives</a> = 0;</div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;        <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a>)</div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + TCP_KEEP_ALIVE_TIMEOUT;</div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;</div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;    <span class="comment">// Handle TCP_LISTEN and TCP_SYN_SENT states</span></div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;    <span class="comment">// Both of these states will return, so code following this </span></div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;    <span class="comment">// state machine need not check explicitly for these two </span></div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;    <span class="comment">// states.</span></div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;    <span class="keywordflow">switch</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a>)</div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;    {</div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b">TCP_LISTEN</a>:</div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;            <span class="comment">// First: check RST flag</span></div>
<div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;            <span class="keywordflow">if</span>(localHeaderFlags &amp; RST)</div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;            {</div>
<div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;                CloseSocket();  <span class="comment">// Unbind remote IP address/port info</span></div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;            }</div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;</div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;            <span class="comment">// Second: check ACK flag, which would be invalid</span></div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;            <span class="keywordflow">if</span>(localHeaderFlags &amp; ACK)</div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;            {</div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;                <span class="comment">// Use a believable sequence number and reset the remote node</span></div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> = localAckNumber;</div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;                SendTCP(RST, 0);</div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;                CloseSocket();  <span class="comment">// Unbind remote IP address/port info</span></div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;            }</div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;</div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;            <span class="comment">// Third: check for SYN flag, which is what we&#39;re looking for</span></div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;            <span class="keywordflow">if</span>(localHeaderFlags &amp; SYN)</div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;            {</div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;                <span class="comment">// We now have a sequence number for the remote node</span></div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a> = localSeqNumber + 1;</div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;</div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;                <span class="comment">// Get MSS option</span></div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a> = GetMaxSegSizeOption();</div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;</div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;                <span class="comment">// Set Initial Send Sequence (ISS) number</span></div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;                <span class="comment">// Nothing to do on this step... ISS already set in CloseSocket()</span></div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;                </div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;                <span class="comment">// Respond with SYN + ACK</span></div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;                SendTCP(SYN | ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a>;</div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;            }</div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;            {</div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;                CloseSocket();  <span class="comment">// Unbind remote IP address/port info</span></div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;            }</div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;</div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;            <span class="comment">// Fourth: check for other text and control</span></div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;            <span class="comment">// Nothing to do since we don&#39;t support this</span></div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;</div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a8d61cf0dd6dacc41f87a1ed05766365c">TCP_SYN_SENT</a>:</div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;            <span class="comment">// Second: check the RST bit</span></div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;            <span class="comment">// This is out of order because this stack has no API for </span></div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;            <span class="comment">// notifying the application that the connection seems to </span></div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;            <span class="comment">// be failing.  Instead, the application must time out and </span></div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;            <span class="comment">// the stack will just keep trying in the mean time.</span></div>
<div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;            <span class="keywordflow">if</span>(localHeaderFlags &amp; RST)</div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;</div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;            <span class="comment">// First: check ACK bit</span></div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;            <span class="keywordflow">if</span>(localHeaderFlags &amp; ACK)</div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;            {</div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;                <span class="keywordflow">if</span>(localAckNumber != MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>)</div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;                {</div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;                    <span class="comment">// Send a RST packet with SEQ = SEG.ACK, but retain our SEQ </span></div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;                    <span class="comment">// number for arivial of any other SYN+ACK packets</span></div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;                    localSeqNumber = MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>;   <span class="comment">// Save our original SEQ number</span></div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> = localAckNumber;   <span class="comment">// Set SEQ = SEG.ACK</span></div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;                    SendTCP(RST, SENDTCP_RESET_TIMERS);     <span class="comment">// Send the RST</span></div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> = localSeqNumber;   <span class="comment">// Restore original SEQ number</span></div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;                }</div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;            }</div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;</div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;            <span class="comment">// Third: check the security and precedence</span></div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;            <span class="comment">// No such feature in this stack.  We want to accept all connections.</span></div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;            <span class="comment">// Fourth: check the SYN bit</span></div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;            <span class="keywordflow">if</span>(localHeaderFlags &amp; SYN)</div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;            {</div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;                <span class="comment">// We now have an initial sequence number and window size</span></div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a> = localSeqNumber + 1;</div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a>;</div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;</div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;                <span class="comment">// Get MSS option</span></div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">wRemoteMSS</a> = GetMaxSegSizeOption();</div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;</div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;                <span class="keywordflow">if</span>(localHeaderFlags &amp; ACK)</div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;                {</div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;                    SendTCP(ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>;</div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;                    <span class="comment">// Set up keep-alive timer</span></div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;<span class="preprocessor">                    #if defined(TCP_KEEP_ALIVE_TIMEOUT)</span></div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + TCP_KEEP_ALIVE_TIMEOUT;</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;<span class="preprocessor">                    #endif</span></div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a> = 0;</div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;                }</div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;                {</div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;                    SendTCP(SYN | ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a>;</div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;                }</div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;            }</div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;</div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;            <span class="comment">// Fifth: drop the segment if neither SYN or RST is set</span></div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;</div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;    }</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;</div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;    <span class="comment">// First: check the sequence number</span></div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;    wSegmentLength = len;</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;    <span class="keywordflow">if</span>(localHeaderFlags &amp; FIN)</div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;        wSegmentLength++;</div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;    <span class="keywordflow">if</span>(localHeaderFlags &amp; SYN)</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;        wSegmentLength++;</div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;</div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;    <span class="comment">// Calculate the RX FIFO space</span></div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>)</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;        wFreeSpace = (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>) - (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>);</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;        wFreeSpace = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> - 1;</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;</div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;    <span class="comment">// Calculate the number of bytes ahead of our head pointer this segment skips</span></div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;    lMissingBytes = localSeqNumber - MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a>;</div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;    wMissingBytes = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)lMissingBytes;</div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;    </div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;    <span class="comment">// Run TCP acceptability tests to verify that this packet has a valid sequence number</span></div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;    bSegmentAcceptable = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;    <span class="keywordflow">if</span>(wSegmentLength)</div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;    {</div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;        <span class="comment">// Check to see if we have free space, and if so, if any of the data falls within the freespace</span></div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;        <span class="keywordflow">if</span>(wFreeSpace)</div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;        {</div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;            <span class="comment">// RCV.NXT =&lt; SEG.SEQ &lt; RCV.NXT+RCV.WND</span></div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;            <span class="keywordflow">if</span>((lMissingBytes &gt;= (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)0) &amp;&amp; (wFreeSpace &gt; (<a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>)lMissingBytes))</div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;                bSegmentAcceptable = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;            {</div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;                <span class="comment">// RCV.NXT =&lt; SEG.SEQ+SEG.LEN-1 &lt; RCV.NXT+RCV.WND</span></div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;                <span class="keywordflow">if</span>((lMissingBytes + (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)wSegmentLength &gt; (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)0) &amp;&amp; (lMissingBytes &lt;= (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)(<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)(wFreeSpace - wSegmentLength)))</div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;                    bSegmentAcceptable = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;            }</div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;            </div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;            <span class="keywordflow">if</span>((lMissingBytes &lt; (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)wFreeSpace) &amp;&amp; ((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)wMissingBytes + (<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)wSegmentLength &gt; (<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)0))</div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;                bSegmentAcceptable = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;        }</div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;        <span class="comment">// Segments with data are not acceptable if we have no free space</span></div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;    }</div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;    {</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;        <span class="comment">// Zero length packets are acceptable if they fall within our free space window</span></div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;        <span class="comment">// SEG.SEQ = RCV.NXT</span></div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;        <span class="keywordflow">if</span>(lMissingBytes == 0)</div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;        {</div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;            bSegmentAcceptable = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;        }</div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;        {</div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;            <span class="comment">// RCV.NXT =&lt; SEG.SEQ &lt; RCV.NXT+RCV.WND</span></div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;            <span class="keywordflow">if</span>((lMissingBytes &gt;= (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)0) &amp;&amp; (wFreeSpace &gt; (<a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>)lMissingBytes))</div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;                bSegmentAcceptable = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;        }</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;    }</div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;    </div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;    <span class="keywordflow">if</span>(!bSegmentAcceptable)</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;    {</div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;        <span class="comment">// Unacceptable segment, drop it and respond appropriately</span></div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;        <span class="keywordflow">if</span>(!(localHeaderFlags &amp; RST)) </div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;            SendTCP(ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;    }</div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;</div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;</div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;    <span class="comment">// Second: check the RST bit</span></div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;    <span class="comment">// Fourth: check the SYN bit</span></div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;    <span class="comment">// Note, that since the third step is not implemented, we can </span></div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;    <span class="comment">// combine this second and fourth step into a single operation.</span></div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;    <span class="keywordflow">if</span>(localHeaderFlags &amp; (RST | SYN))</div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;    {</div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;        CloseSocket();</div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;    }</div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;    <span class="comment">// Third: check the security and precedence</span></div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;    <span class="comment">// Feature not supported.  Let&#39;s process this segment.</span></div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;</div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;    <span class="comment">// Fifth: check the ACK bit</span></div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;    <span class="keywordflow">if</span>(!(localHeaderFlags &amp; ACK))</div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;</div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;    <span class="keywordflow">switch</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a>)</div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;    {</div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a>:</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;            <span class="keywordflow">if</span>(localAckNumber != MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>)</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;            {</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;                <span class="comment">// Send a RST packet with SEQ = SEG.ACK, but retain our SEQ </span></div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;                <span class="comment">// number for arivial of any other correct packets</span></div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;                localSeqNumber = MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a>;   <span class="comment">// Save our original SEQ number</span></div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> = localAckNumber;   <span class="comment">// Set SEQ = SEG.ACK</span></div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;                SendTCP(RST, SENDTCP_RESET_TIMERS);     <span class="comment">// Send the RST</span></div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> = localSeqNumber;   <span class="comment">// Restore original SEQ number</span></div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;            }</div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>;</div>
<div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;            <span class="comment">// No break</span></div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;</div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>:</div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a>:</div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c">TCP_FIN_WAIT_2</a>:</div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a>:</div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a62d0ebf32025a28195c2d8e87e68f3af">TCP_CLOSING</a>:</div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;            <span class="comment">// Calculate what the highest possible SEQ number in our TX FIFO is</span></div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;            wTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> - MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>;</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;            <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)wTemp &lt; (<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)0)</div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;                wTemp += MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;            dwTemp = MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> + (<a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>)wTemp;</div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;            <span class="comment">// Drop the packet if it ACKs something we haven&#39;t sent</span></div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;            dwTemp = (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)localAckNumber - (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)dwTemp;</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;            <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)dwTemp &gt; 0)</div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;            {   <span class="comment">// acknowledged more than we&#39;ve sent??</span></div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;                <span class="keywordflow">if</span>(!MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#ae7e84a3fa64de6e94ad093b762400e10">bFINSent</a> || dwTemp != 1)</div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;                {</div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;                    SendTCP(ACK, 0);</div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;                }</div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;                {</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;                    localAckNumber--;   <span class="comment">// since we don&#39;t count the FIN anyway</span></div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;                }</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;            }</div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;</div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;            <span class="comment">// Throw away all ACKnowledged TX data:</span></div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;            <span class="comment">// Calculate what the last acknowledged sequence number was (ignoring any FINs we sent)</span></div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;            dwTemp = MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> - (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)(<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>);</div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>)</div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;                dwTemp -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;    </div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;            <span class="comment">// Calcluate how many bytes were ACKed with this packet</span></div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;            dwTemp = localAckNumber - dwTemp;</div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;            <span class="keywordflow">if</span>(((<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)(dwTemp) &gt; (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)0) &amp;&amp; (dwTemp &lt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>))</div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;            {</div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#acd4766b3fc8c443d8aceb1920fc58677">bRXNoneACKed1</a> = 0;</div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a22ffb6306d775b5180f9d9691240df08">bRXNoneACKed2</a> = 0;</div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">bHalfFullFlush</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;    </div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;                <span class="comment">// Bytes ACKed, free up the TX FIFO space</span></div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;                wTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>;</div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> += dwTemp;</div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> &gt;= wTemp)</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;                {</div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;                    <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>)</div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;                    {</div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> += MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> - MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>;</div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>;</div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;                    }</div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;                }</div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;                {</div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;                    wTemp = MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> + (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>);</div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;                    <span class="keywordflow">if</span>(wTemp &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>)</div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;                    {</div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> += MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> - wTemp;</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>;</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;                    }</div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;                }</div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;                <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;            }</div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;            {</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;                <span class="comment">// See if we have outstanding TX data that is waiting for an ACK</span></div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;                <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> != MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a>)</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;                {</div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;                    <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#acd4766b3fc8c443d8aceb1920fc58677">bRXNoneACKed1</a>)</div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;                    {</div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;                        <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a22ffb6306d775b5180f9d9691240df08">bRXNoneACKed2</a>)</div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;                        {</div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;                            <span class="comment">// Set up to perform a fast retransmission</span></div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;                            <span class="comment">// Roll back unacknowledged TX tail pointer to cause retransmit to occur</span></div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;                            MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> -= (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)(<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>);</div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;                            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>)</div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;                                MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> -= (<a class="code" href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a>)(<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>);</div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;                            MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a>;</div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;                            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">bTXASAPWithoutTimerReset</a> = 1;</div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;                        }</div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#a22ffb6306d775b5180f9d9691240df08">bRXNoneACKed2</a> = 1;</div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;                    }</div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#acd4766b3fc8c443d8aceb1920fc58677">bRXNoneACKed1</a> = 1;</div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;                }</div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;            }</div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;</div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;            <span class="comment">// No need to keep our retransmit timer going if we have nothing that needs ACKing anymore</span></div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> == MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>)</div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;            {</div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;                <span class="comment">// Make sure there isn&#39;t a &quot;FIN byte in our TX FIFO&quot;</span></div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;                <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2b4e5624c7ff0110540b0b87b484c636">bTXFIN</a> == 0u)</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;                {</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;                    <span class="comment">// Convert retransmission timer to keep-alive timer</span></div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;<span class="preprocessor">                    #if defined(TCP_KEEP_ALIVE_TIMEOUT)</span></div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + TCP_KEEP_ALIVE_TIMEOUT;</div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;<span class="preprocessor">                    #endif</span></div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a> = 0;</div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;                }</div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;                {</div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;                    <span class="comment">// &quot;Throw away&quot; FIN byte from our TX FIFO if it has been ACKed</span></div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;                    <span class="keywordflow">if</span>((MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> == localAckNumber) &amp;&amp; MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#ae7e84a3fa64de6e94ad093b762400e10">bFINSent</a>)</div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;                    {</div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a> = 0;</div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2b4e5624c7ff0110540b0b87b484c636">bTXFIN</a> = 0;</div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;                    }</div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;                }</div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;            }</div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;</div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;            <span class="comment">// The window size advirtised in this packet is adjusted to account </span></div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;            <span class="comment">// for any bytes that we have transmitted but haven&#39;t been ACKed yet </span></div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;            <span class="comment">// by this segment.</span></div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;            wNewWindow = h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">Window</a> - ((<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)(MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> - localAckNumber));</div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;</div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;            <span class="comment">// Update the local stored copy of the RemoteWindow.</span></div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;            <span class="comment">// If previously we had a zero window, and now we don&#39;t, then </span></div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;            <span class="comment">// immediately send whatever was pending.</span></div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;            <span class="keywordflow">if</span>((MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> == 0u) &amp;&amp; wNewWindow)</div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#abf1b4439c5f152ddb383859e5a0f3bd3">bTXASAP</a> = 1;</div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">remoteWindow</a> = wNewWindow;</div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;</div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;            <span class="comment">// A couple of states must do all of the TCP_ESTABLISHED stuff, but also a little more</span></div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a>)</div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;            {</div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;                <span class="comment">// Check to see if our FIN has been ACKnowledged</span></div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;                <span class="keywordflow">if</span>((MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> == localAckNumber) &amp;&amp; MyTCB.<a class="code" href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">flags</a>.<a class="code" href="struct_t_c_b.html#ae7e84a3fa64de6e94ad093b762400e10">bFINSent</a>)</div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;                {</div>
<div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;                    <span class="comment">// Reset our timer for forced closure if the remote node </span></div>
<div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;                    <span class="comment">// doesn&#39;t send us a FIN in a timely manner.</span></div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">eventTime</a> = <a class="code" href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a>() + TCP_FIN_WAIT_2_TIMEOUT;</div>
<div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">bTimerEnabled</a> = 1;</div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c">TCP_FIN_WAIT_2</a>;</div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;                }</div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;            }</div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c">TCP_FIN_WAIT_2</a>)</div>
<div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;            {</div>
<div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;                <span class="comment">// RFC noncompliance:</span></div>
<div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;                <span class="comment">// The remote node should not keep sending us data </span></div>
<div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;                <span class="comment">// indefinitely after we send a FIN to it.  </span></div>
<div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;                <span class="comment">// However, some bad stacks may still keep sending </span></div>
<div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;                <span class="comment">// us data indefinitely after ACKing our FIN.  To </span></div>
<div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;                <span class="comment">// prevent this from locking up our socket, let&#39;s </span></div>
<div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;                <span class="comment">// send a RST right now and close forcefully on </span></div>
<div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;                <span class="comment">// our side.</span></div>
<div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;                <span class="keywordflow">if</span>(!(localHeaderFlags &amp; FIN))</div>
<div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;                {</div>
<div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> = localAckNumber;   <span class="comment">// Set SEQ = SEG.ACK</span></div>
<div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;                    SendTCP(RST | ACK, 0);</div>
<div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;                    CloseSocket();</div>
<div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;                }</div>
<div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;            }</div>
<div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a62d0ebf32025a28195c2d8e87e68f3af">TCP_CLOSING</a>)</div>
<div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;            {</div>
<div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;                <span class="comment">// Check to see if our FIN has been ACKnowledged</span></div>
<div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> == localAckNumber)</div>
<div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;                {</div>
<div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;                    <span class="comment">// RFC not recommended: We should be going to </span></div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;                    <span class="comment">// the TCP_TIME_WAIT state right here and </span></div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;                    <span class="comment">// starting a 2MSL timer, but since we have so </span></div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;                    <span class="comment">// few precious sockets, we can&#39;t afford to </span></div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;                    <span class="comment">// leave a socket waiting around doing nothing </span></div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;                    <span class="comment">// for a long time.  If the remote node does </span></div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;                    <span class="comment">// not recieve this ACK, it&#39;ll have to figure </span></div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;                    <span class="comment">// out on it&#39;s own that the connection is now </span></div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;                    <span class="comment">// closed.</span></div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;                    CloseSocket();</div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;                }</div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;</div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;            }</div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;</div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;</div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a>:</div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;            <span class="comment">// Check to see if our FIN has been ACKnowledged</span></div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> + 1 == localAckNumber)</div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;                CloseSocket();</div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;</div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;<span class="comment">//      case TCP_TIME_WAIT:</span></div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;<span class="comment">//          // Nothing is supposed to arrive here.  If it does, reset the quiet timer.</span></div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;<span class="comment">//          SendTCP(ACK, SENDTCP_RESET_TIMERS);</span></div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;<span class="comment">//          return;</span></div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;</div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;    }</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;</div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;    <span class="comment">// Sixth: Check the URG bit</span></div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;    <span class="comment">// Urgent packets are not supported in this stack, so we</span></div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;    <span class="comment">// will throw them away instead</span></div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;    <span class="keywordflow">if</span>(localHeaderFlags &amp; URG)</div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;</div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;    <span class="comment">// Seventh: Process the segment text</span></div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;    <span class="comment">// Throw data away if in a state that doesn&#39;t accept data</span></div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a>)</div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a62d0ebf32025a28195c2d8e87e68f3af">TCP_CLOSING</a>)</div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a>)</div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;<span class="comment">//  if(MyTCBStub.smState == TCP_TIME_WAIT)</span></div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;<span class="comment">//      return;</span></div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;</div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;    <span class="comment">// Copy any valid segment data into our RX FIFO, if any</span></div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;    <span class="keywordflow">if</span>(len)</div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;    {</div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;        <span class="comment">// See if there are bytes we must skip</span></div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;        <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)wMissingBytes &lt;= 0)</div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;        {</div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;            <span class="comment">// Position packet read pointer to start of useful data area.</span></div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;            <a class="code" href="_i_p_8h.html#a33cd719865ee57f9591c92a63e74d59f">IPSetRxBuffer</a>((h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a57bf620571057a239c31978ce012adfa">DataOffset</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a5822b7000f077dc1e2f88a31a6b89a39">Val</a> &lt;&lt; 2) - wMissingBytes);</div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;            len += wMissingBytes;       </div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;    </div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;            <span class="comment">// Truncate packets that would overflow our TCP RX FIFO</span></div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;            <span class="comment">// and request a retransmit by sending a duplicate ACK</span></div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;            <span class="keywordflow">if</span>(len &gt; wFreeSpace)</div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;                len = wFreeSpace;</div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;    </div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a> += (<a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>)len;</div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;        </div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;            <span class="comment">// Copy the application data from the packet into the socket RX FIFO</span></div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;            <span class="comment">// See if we need a two part copy (spans bufferEnd-&gt;bufferRxStart)</span></div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> + len &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;            {</div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;                wTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> + 1;</div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;                TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)-1, <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, wTemp);</div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;                TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)-1, <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, len - wTemp);</div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + (len - wTemp);</div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;            }</div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;            {</div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;                TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)-1, <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, len);</div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> += len;</div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;            }</div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;        </div>
<div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;            <span class="comment">// See if we have a hole and other data waiting already in the RX FIFO</span></div>
<div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> != -1)</div>
<div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;            {</div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> -= len;</div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;                wTemp = MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a> + MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a>;</div>
<div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;        </div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;                <span class="comment">// See if we just closed up a hole, and if so, advance head pointer</span></div>
<div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;                <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)wTemp &lt; (<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)0)</div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;                {</div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> = -1;</div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;                }</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> &lt;= 0)</div>
<div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;                {</div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a> += wTemp;</div>
<div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> += wTemp;</div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;                    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;                          </div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> = -1;</div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;                }</div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;            }</div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;        } <span class="comment">// This packet is out of order or we lost a packet, see if we can generate a hole to accomodate it</span></div>
<div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)wMissingBytes &gt; 0)</div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;        {</div>
<div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;            <span class="comment">// Truncate packets that would overflow our TCP RX FIFO</span></div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;            <span class="keywordflow">if</span>(len + wMissingBytes &gt; wFreeSpace)</div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;                len = wFreeSpace - wMissingBytes;</div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;        </div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;            <span class="comment">// Position packet read pointer to start of useful data area.</span></div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;            <a class="code" href="_i_p_8h.html#a33cd719865ee57f9591c92a63e74d59f">IPSetRxBuffer</a>(h-&gt;<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a57bf620571057a239c31978ce012adfa">DataOffset</a>.<a class="code" href="struct_t_c_p___h_e_a_d_e_r.html#a5822b7000f077dc1e2f88a31a6b89a39">Val</a> &lt;&lt; 2);</div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;    </div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;            <span class="comment">// See if we need a two part copy (spans bufferEnd-&gt;bufferRxStart)</span></div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> + wMissingBytes + len &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;            {</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;                <span class="comment">// Calculate number of data bytes to copy before wraparound</span></div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;                wTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> + 1 - wMissingBytes;</div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;                <span class="keywordflow">if</span>((<a class="code" href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a>)wTemp &gt;= 0)</div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;                {</div>
<div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;                    TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> + wMissingBytes, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)-1, <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, wTemp);</div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;                    TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)-1, <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, len - wTemp);</div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;                }</div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;                {</div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;                    TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> + wMissingBytes - (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1), MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)-1, <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, len);</div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;                }</div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;            }</div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;            {</div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;                TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> + wMissingBytes, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)-1, <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>, len);</div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;            }</div>
<div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;        </div>
<div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;            <span class="comment">// Record the hole is here</span></div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;            <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> == -1)</div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;            {</div>
<div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> = wMissingBytes;</div>
<div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;                MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a> = len;</div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;            }</div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;            {</div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;                <span class="comment">// We already have a hole, see if we can shrink the hole </span></div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;                <span class="comment">// or extend the future data size</span></div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;                <span class="keywordflow">if</span>(wMissingBytes &lt; (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a>)</div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;                {</div>
<div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;                    <span class="keywordflow">if</span>((wMissingBytes + len &gt; (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> + MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a>) || (wMissingBytes + len &lt; (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a>))</div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a> = len;</div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> + MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a> - wMissingBytes;</div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;                    MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> = wMissingBytes;</div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;                }</div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(wMissingBytes + len &gt; (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> + MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a>)</div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;                {</div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;                    <span class="comment">// Make sure that there isn&#39;t a second hole between </span></div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;                    <span class="comment">// our future data and this TCP segment&#39;s future data</span></div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;                    <span class="keywordflow">if</span>(wMissingBytes &lt;= (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> + MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a>)</div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;                        MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a> += wMissingBytes + len - (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> - MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a>;</div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;                }</div>
<div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;                </div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;            }</div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;        }</div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;    }</div>
<div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;</div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;    <span class="comment">// Send back an ACK of the data (+SYN | FIN) we just received, </span></div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;    <span class="comment">// if any.  To minimize bandwidth waste, we are implementing </span></div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;    <span class="comment">// the delayed acknowledgement algorithm here, only sending </span></div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;    <span class="comment">// back an immediate ACK if this is the second segment received.  </span></div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;    <span class="comment">// Otherwise, a 200ms timer will cause the ACK to be transmitted.</span></div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;    <span class="keywordflow">if</span>(wSegmentLength)</div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;    {</div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;        <span class="comment">// For non-established sockets, let&#39;s delete all data in </span></div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;        <span class="comment">// the RX buffer immediately after receiving it.  This is </span></div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;        <span class="comment">// not really how TCP was intended to operate since a </span></div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;        <span class="comment">// socket cannot receive any response after it sends a FIN,</span></div>
<div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;        <span class="comment">// but our TCP application API doesn&#39;t readily accomodate</span></div>
<div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;        <span class="comment">// receiving data after calling TCPDisconnect(), which </span></div>
<div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;        <span class="comment">// invalidates the application TCP handle.  By deleting all </span></div>
<div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;        <span class="comment">// data, we&#39;ll ensure that the RX window is nonzero and </span></div>
<div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;        <span class="comment">// the remote node will be able to send us a FIN response, </span></div>
<div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;        <span class="comment">// which needs an RX window of at least 1.</span></div>
<div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> != <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>)</div>
<div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;</div>
<div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a64467e967affbc7f3bd04af24a62255f">bOneSegmentReceived</a>)</div>
<div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;        {</div>
<div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;            SendTCP(ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;            SyncTCB();</div>
<div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;            <span class="comment">// bOneSegmentReceived is cleared in SendTCP(), so no need here</span></div>
<div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;        }</div>
<div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;        {</div>
<div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a64467e967affbc7f3bd04af24a62255f">bOneSegmentReceived</a> = <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>; </div>
<div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;        </div>
<div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;            <span class="comment">// Do not send an ACK immediately back.  Instead, we will </span></div>
<div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;            <span class="comment">// perform delayed acknowledgements.  To do this, we will </span></div>
<div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;            <span class="comment">// just start a timer</span></div>
<div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;            <span class="keywordflow">if</span>(!MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a97e8fa1695ed948d0a715a3b96bb6d8d">bDelayedACKTimerEnabled</a>)</div>
<div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;            {</div>
<div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a97e8fa1695ed948d0a715a3b96bb6d8d">bDelayedACKTimerEnabled</a> = 1;</div>
<div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ad7a32728d33041b932eab132ddec9a6f">OverlappedTimers</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#ac42d764ddec4dd25aab3d65a9a415753">delayedACKTime</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() + (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)((TCP_DELAYED_ACK_TIMEOUT)&gt;&gt;8);</div>
<div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;            }</div>
<div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;        }</div>
<div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;    }</div>
<div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;</div>
<div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;    <span class="comment">// Eighth: check the FIN bit</span></div>
<div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;    <span class="keywordflow">if</span>(localHeaderFlags &amp; FIN)</div>
<div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;    {</div>
<div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;        <span class="comment">// Note: Since we don&#39;t have a good means of storing &quot;FIN bytes&quot; </span></div>
<div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;        <span class="comment">// in our TCP RX FIFO, we must ensure that FINs are processed </span></div>
<div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;        <span class="comment">// in-order.</span></div>
<div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;        <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a> + 1 == localSeqNumber + (<a class="code" href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a>)wSegmentLength)</div>
<div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;        {</div>
<div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;            <span class="comment">// FINs are treated as one byte of data for ACK sequencing</span></div>
<div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;            MyTCB.<a class="code" href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">RemoteSEQ</a>++;</div>
<div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;            </div>
<div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;            <span class="keywordflow">switch</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a>)</div>
<div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;            {</div>
<div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a>:</div>
<div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;                    <span class="comment">// RFC in exact: Our API has no need for the user </span></div>
<div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;                    <span class="comment">// to explicitly close a socket that never really </span></div>
<div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;                    <span class="comment">// got opened fully in the first place, so just </span></div>
<div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;                    <span class="comment">// transmit a FIN automatically and jump to </span></div>
<div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;                    <span class="comment">// TCP_LAST_ACK</span></div>
<div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a>;</div>
<div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;                    SendTCP(FIN | ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;</div>
<div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>:</div>
<div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;                    <span class="comment">// Go to TCP_CLOSE_WAIT state</span></div>
<div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a>;</div>
<div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;                    </div>
<div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;                    <span class="comment">// For legacy applications that don&#39;t call </span></div>
<div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;                    <span class="comment">// TCPDisconnect() as needed and expect the TCP/IP </span></div>
<div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;                    <span class="comment">// Stack to automatically close sockets when the </span></div>
<div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;                    <span class="comment">// remote node sends a FIN, let&#39;s start a timer so </span></div>
<div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;                    <span class="comment">// that we will eventually close the socket automatically</span></div>
<div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ad7a32728d33041b932eab132ddec9a6f">OverlappedTimers</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#adbf3a5a42e98b90ba8a87652e0b9099e">closeWaitTime</a> = (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)<a class="code" href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a>() + (<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>)((TCP_CLOSE_WAIT_TIMEOUT)&gt;&gt;8);</div>
<div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;    </div>
<div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a>:</div>
<div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;                    <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">MySEQ</a> == localAckNumber)</div>
<div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;                    {</div>
<div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;                        <span class="comment">// RFC not recommended: We should be going to </span></div>
<div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;                        <span class="comment">// the TCP_TIME_WAIT state right here and </span></div>
<div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;                        <span class="comment">// starting a 2MSL timer, but since we have so </span></div>
<div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;                        <span class="comment">// few precious sockets, we can&#39;t afford to </span></div>
<div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;                        <span class="comment">// leave a socket waiting around doing nothing </span></div>
<div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;                        <span class="comment">// for a long time.  If the remote node does </span></div>
<div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;                        <span class="comment">// not recieve this ACK, it&#39;ll have to figure </span></div>
<div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;                        <span class="comment">// out on it&#39;s own that the connection is now </span></div>
<div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;                        <span class="comment">// closed.</span></div>
<div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;                        SendTCP(ACK, 0);</div>
<div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;                        CloseSocket();</div>
<div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;                        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;                    }</div>
<div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;                    {</div>
<div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;                        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> = <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a62d0ebf32025a28195c2d8e87e68f3af">TCP_CLOSING</a>;</div>
<div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;                    }</div>
<div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;    </div>
<div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c">TCP_FIN_WAIT_2</a>:</div>
<div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;                    <span class="comment">// RFC not recommended: We should be going to </span></div>
<div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;                    <span class="comment">// the TCP_TIME_WAIT state right here and </span></div>
<div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;                    <span class="comment">// starting a 2MSL timer, but since we have so </span></div>
<div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;                    <span class="comment">// few precious sockets, we can&#39;t afford to </span></div>
<div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;                    <span class="comment">// leave a socket waiting around doing nothing </span></div>
<div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;                    <span class="comment">// for a long time.  If the remote node does </span></div>
<div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;                    <span class="comment">// not recieve this ACK, it&#39;ll have to figure </span></div>
<div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;                    <span class="comment">// out on it&#39;s own that the connection is now </span></div>
<div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;                    <span class="comment">// closed.</span></div>
<div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;                    SendTCP(ACK, 0);</div>
<div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;                    CloseSocket();</div>
<div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;</div>
<div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;            }</div>
<div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;</div>
<div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;            <span class="comment">// Acknowledge receipt of FIN</span></div>
<div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;            SendTCP(ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;        }</div>
<div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;    }</div>
<div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;}</div>
<div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;</div>
<div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;<span class="comment">    Buffer Management Functions</span></div>
<div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;</div>
<div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;<span class="comment">    BOOL TCPAdjustFIFOSize(TCP_SOCKET hTCP, WORD wMinRXSize, </span></div>
<div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;<span class="comment">                            WORD wMinTXSize, BYTE vFlags)</span></div>
<div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;<span class="comment">    Adjusts the relative sizes of the RX and TX buffers.</span></div>
<div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;<span class="comment">    This function can be used to adjust the relative sizes of the RX and</span></div>
<div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;<span class="comment">    TX FIFO depending on the immediate needs of an application.  Since a </span></div>
<div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;<span class="comment">    larger FIFO can allow more data to be sent in a given packet, adjusting </span></div>
<div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;<span class="comment">    the relative sizes on the fly can allow for optimal transmission speed </span></div>
<div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;<span class="comment">    for one-sided application protocols.  For example, HTTP typically </span></div>
<div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;<span class="comment">    begins by receiving large amounts of data from the client, then switches</span></div>
<div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;<span class="comment">    to serving large amounts of data back.  Adjusting the FIFO at these </span></div>
<div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;<span class="comment">    points can increase performance substantially.  Once the FIFO is</span></div>
<div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;<span class="comment">    adjusted, a window update is sent.</span></div>
<div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;<span class="comment">    If neither or both of TCP_ADJUST_GIVE_REST_TO_TX and </span></div>
<div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;<span class="comment">    TCP_ADJUST_GIVE_REST_TO_RX are set, the function distributes the</span></div>
<div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;<span class="comment">    remaining space equally.</span></div>
<div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;<span class="comment">    Received data can be preserved as long as the buffer is expanding and </span></div>
<div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;<span class="comment">    has not wrapped.</span></div>
<div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;<span class="comment">    hTCP        - The socket to be adjusted</span></div>
<div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;<span class="comment">    wMinRXSize  - Minimum number of byte for the RX FIFO</span></div>
<div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;<span class="comment">    wMinTXSize  - Minimum number of bytes for the RX FIFO</span></div>
<div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;<span class="comment">    vFlags      - Any combination of TCP_ADJUST_GIVE_REST_TO_RX, </span></div>
<div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;<span class="comment">                  TCP_ADJUST_GIVE_REST_TO_TX, TCP_ADJUST_PRESERVE_RX.</span></div>
<div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;<span class="comment">                  TCP_ADJUST_PRESERVE_TX is not currently supported.</span></div>
<div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;<span class="comment">    TRUE - The FIFOs were adjusted successfully</span></div>
<div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;<span class="comment">    FALSE - Minimum RX, Minimum TX, or flags couldn&#39;t be accommodated and</span></div>
<div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;<span class="comment">            therefore the socket was left unchanged.</span></div>
<div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;<span class="comment">  Side Effects:</span></div>
<div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;<span class="comment">    Any unacknowledged or untransmitted data in the TX FIFO is always</span></div>
<div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;<span class="comment">    deleted.</span></div>
<div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;<span class="comment">    At least one byte must always be allocated to the RX buffer so that</span></div>
<div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;<span class="comment">    a FIN can be received.  The function automatically corrects for this.</span></div>
<div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04349"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ae0f1ef659a3000449e90a10ffdb816e6"> 4349</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#ae0f1ef659a3000449e90a10ffdb816e6">TCPAdjustFIFOSize</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wMinRXSize, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wMinTXSize, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vFlags)</div>
<div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;{</div>
<div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;    PTR_BASE ptrTemp, ptrHead;</div>
<div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wTXAllocation;</div>
<div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;    </div>
<div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;    {</div>
<div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;    }</div>
<div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;    </div>
<div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;    <span class="comment">// Load up info on this socket</span></div>
<div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;</div>
<div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;    <span class="comment">// RX has to be at least 1 byte to receive SYN and FIN bytes </span></div>
<div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;    <span class="comment">// from the remote node, even if they aren&#39;t stored in the RX FIFO</span></div>
<div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;    <span class="keywordflow">if</span>(wMinRXSize == 0u)</div>
<div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;        wMinRXSize = 1;</div>
<div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;        </div>
<div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;    <span class="comment">// SSL connections need to be able to send or receive at least </span></div>
<div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;    <span class="comment">// a full Alert record, MAC, and FIN</span></div>
<div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a">TCPIsSSL</a>(hTCP) &amp;&amp; wMinRXSize &lt; 25u)</div>
<div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;        wMinRXSize = 25;</div>
<div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a">TCPIsSSL</a>(hTCP) &amp;&amp; wMinTXSize &lt; 25u)</div>
<div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;        wMinTXSize = 25;</div>
<div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;    </div>
<div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;    <span class="comment">// Make sure space is available for minimums</span></div>
<div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;    ptrTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> - 1;</div>
<div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;    <span class="keywordflow">if</span>(wMinRXSize + wMinTXSize &gt; ptrTemp)</div>
<div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;</div>
<div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;    SyncTCB();</div>
<div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;</div>
<div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;    <span class="comment">// Set both allocation flags if none set</span></div>
<div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;    <span class="keywordflow">if</span>(!(vFlags &amp; (TCP_ADJUST_GIVE_REST_TO_TX | TCP_ADJUST_GIVE_REST_TO_RX)))</div>
<div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;        vFlags |= TCP_ADJUST_GIVE_REST_TO_TX | TCP_ADJUST_GIVE_REST_TO_RX;</div>
<div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;        </div>
<div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;</div>
<div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;    <span class="comment">// Allocate minimums</span></div>
<div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;    wTXAllocation = wMinTXSize;</div>
<div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;    ptrTemp -= wMinRXSize + wMinTXSize;</div>
<div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;</div>
<div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;    <span class="comment">// Allocate extra</span></div>
<div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;    <span class="keywordflow">if</span>(vFlags &amp; TCP_ADJUST_GIVE_REST_TO_TX)</div>
<div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;    {</div>
<div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;        <span class="keywordflow">if</span>(vFlags &amp; TCP_ADJUST_GIVE_REST_TO_RX)</div>
<div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;        {</div>
<div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;            <span class="comment">// Do a 50%/50% split with any odd byte always going to the RX FIFO</span></div>
<div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;            wTXAllocation += ptrTemp&gt;&gt;1;</div>
<div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;        }</div>
<div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;        {</div>
<div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;            wTXAllocation += ptrTemp;</div>
<div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;        }</div>
<div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;    }</div>
<div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;</div>
<div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;    <span class="comment">// Calculate new bufferRxStart pointer</span></div>
<div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;    ptrTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> + wTXAllocation + 1;</div>
<div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;</div>
<div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;    <span class="comment">// Find the head pointer to use</span></div>
<div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;    ptrHead = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a">TCPIsSSL</a>(hTCP))</div>
<div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;        ptrHead = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a>;</div>
<div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;    </div>
<div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;    <span class="comment">// If there&#39;s out-of-order data pending, adjust the head pointer to compensate</span></div>
<div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;    <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> != -1)</div>
<div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;    {</div>
<div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;        ptrHead += MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> + MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a>;</div>
<div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;        <span class="keywordflow">if</span>(ptrHead &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;            ptrHead -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;</div>
<div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;    }</div>
<div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;</div>
<div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;    <span class="comment">// Determine if resizing will lose any RX data</span></div>
<div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> &lt; ptrHead)</div>
<div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;    {</div>
<div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;        <span class="keywordflow">if</span>(ptrTemp &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>)</div>
<div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;        {</div>
<div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;            <span class="keywordflow">if</span>(vFlags &amp; TCP_ADJUST_PRESERVE_RX)</div>
<div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;            {</div>
<div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = ptrTemp;</div>
<div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = ptrTemp;</div>
<div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;</div>
<div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;<span class="preprocessor">                #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = ptrTemp;</div>
<div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;<span class="preprocessor">                #endif</span></div>
<div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;            }</div>
<div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;        }</div>
<div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;    }</div>
<div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> &gt; ptrHead)</div>
<div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;    {</div>
<div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;        <span class="keywordflow">if</span>(ptrTemp &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;        {</div>
<div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;            <span class="keywordflow">if</span>(vFlags &amp; TCP_ADJUST_PRESERVE_RX)</div>
<div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;            {</div>
<div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = ptrTemp;</div>
<div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = ptrTemp;</div>
<div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;                </div>
<div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;<span class="preprocessor">                #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = ptrTemp;</div>
<div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;<span class="preprocessor">                #endif</span></div>
<div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;            }</div>
<div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;        }</div>
<div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;    }</div>
<div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;    {</div>
<div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;        <span class="comment">// No data to preserve, but we may need to move </span></div>
<div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;        <span class="comment">// the pointers to stay in the RX space</span></div>
<div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = ptrTemp;</div>
<div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = ptrTemp;</div>
<div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;        </div>
<div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;<span class="preprocessor">        #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = ptrTemp;</div>
<div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;    }</div>
<div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;    </div>
<div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;    <span class="comment">// If we need to preserve data that wrapped in the ring, we must copy</span></div>
<div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;    <span class="keywordflow">if</span>(ptrHead &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> &amp;&amp; (vFlags &amp; TCP_ADJUST_PRESERVE_RX))</div>
<div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;    {</div>
<div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;        TCPRAMCopy(ptrTemp, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, </div>
<div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>,</div>
<div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;            ptrHead - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>);</div>
<div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;</div>
<div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;        <span class="comment">// Move the pointers if they were in front of the tail</span></div>
<div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;<span class="preprocessor">        #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a">TCPIsSSL</a>(hTCP) &amp;&amp; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>)</div>
<div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - ptrTemp;</div>
<div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;        <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>)</div>
<div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - ptrTemp;</div>
<div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;    }</div>
<div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;    </div>
<div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;    <span class="comment">// Move the RX buffer pointer - it&#39;s the one that divides the two</span></div>
<div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> = ptrTemp;</div>
<div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;</div>
<div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;    <span class="comment">// Empty the TX buffer</span></div>
<div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">txUnackedTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">txTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;    </div>
<div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;<span class="preprocessor">    #if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a">TCPIsSSL</a>(hTCP))</div>
<div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> + 5;</div>
<div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;    </div>
<div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;    <span class="comment">// Send a window update to notify remote node of change</span></div>
<div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> == <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a>)</div>
<div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;        SendTCP(ACK, SENDTCP_RESET_TIMERS);</div>
<div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;</div>
<div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;</div>
<div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;}</div>
<div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;</div>
<div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;<span class="comment">    static void TCPRAMCopy(PTR_BASE ptrDest, BYTE vDestType, PTR_BASE ptrSource, </span></div>
<div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;<span class="comment">                            BYTE vSourceType, WORD wLength)</span></div>
<div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;<span class="comment">    Copies data to/from various memory mediums.</span></div>
<div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;<span class="comment">    This function copies data between memory mediums (PIC RAM, SPI</span></div>
<div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;<span class="comment">    RAM, and Ethernet buffer RAM).</span></div>
<div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160;<span class="comment">    ptrDest     - Address to write to</span></div>
<div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;<span class="comment">    vDestType   - Destination meidum (TCP_PIC_RAM, TCP_ETH_RAM, TCP_SPI_RAM)</span></div>
<div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;<span class="comment">    ptrSource   - Address to copy from</span></div>
<div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;<span class="comment">    vSourceType - Source medium (TCP_PIC_RAM, TCP_ETH_RAM, or TCP_SPI_RAM)</span></div>
<div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;<span class="comment">    wLength     - Number of bytes to copy</span></div>
<div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;<span class="comment">    Copying to a destination region that overlaps with the source address </span></div>
<div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;<span class="comment">    is supported only if the destination start address is at a lower memory </span></div>
<div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;<span class="comment">    address (closer to 0x0000) than the source pointer.  However, if they do </span></div>
<div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;<span class="comment">    overlap there must be at least 4 bytes of non-overlap to ensure correct </span></div>
<div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;<span class="comment">    results due to hardware DMA requirements.</span></div>
<div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> TCPRAMCopy(PTR_BASE ptrDest, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vDestType, PTR_BASE ptrSource, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vSourceType, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLength)</div>
<div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;{</div>
<div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;<span class="preprocessor">    #if defined(SPIRAM_CS_TRIS)</span></div>
<div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vBuffer[16];</div>
<div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> w;</div>
<div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;        </div>
<div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;    <span class="keywordflow">switch</span>(vSourceType)</div>
<div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;    {</div>
<div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>:</div>
<div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;            <span class="keywordflow">switch</span>(vDestType)</div>
<div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;            {</div>
<div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>:</div>
<div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;                    memcpy((<span class="keywordtype">void</span>*)(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)ptrDest, (<span class="keywordtype">void</span>*)(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)ptrSource, wLength);</div>
<div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;    </div>
<div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>:</div>
<div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;                    <span class="keywordflow">if</span>(ptrDest!=(PTR_BASE)-1)</div>
<div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;                        <a class="code" href="_m_a_c_8h.html#a76abcd85736be75ac9dee35b573bb90d">MACSetWritePtr</a>(ptrDest);</div>
<div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;                    <a class="code" href="_m_a_c_8h.html#a87a779bb5e5f2c7ffc444f52d696efa2">MACPutArray</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)ptrSource, wLength);</div>
<div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;    </div>
<div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;<span class="preprocessor">                #if defined(SPIRAM_CS_TRIS)</span></div>
<div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#aba628f222575a1aeed0f684edb39351b">TCP_SPI_RAM</a>:</div>
<div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;                    <a class="code" href="_s_p_i_r_a_m_8h.html#a901a1adc847c32a66f762a7a23c556cc">SPIRAMPutArray</a>(ptrDest, (<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)ptrSource, wLength);</div>
<div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;<span class="preprocessor">                #endif</span></div>
<div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;            }</div>
<div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;    </div>
<div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>:</div>
<div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;            <span class="keywordflow">switch</span>(vDestType)</div>
<div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;            {</div>
<div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>:</div>
<div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;                    <span class="keywordflow">if</span>(ptrSource!=(PTR_BASE)-1)</div>
<div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;                        <a class="code" href="_m_a_c_8h.html#aad63644420d87642a890d2f41abb7454">MACSetReadPtr</a>(ptrSource);</div>
<div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160;                    <a class="code" href="_m_a_c_8h.html#a89d13e85195c0d00f308194305845016">MACGetArray</a>((<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)ptrDest, wLength);</div>
<div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04578"></a><span class="lineno"> 4578</span>&#160;    </div>
<div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>:</div>
<div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;                    <a class="code" href="_m_a_c_8h.html#a4442711ab4c3d47ffc913476630330e2">MACMemCopyAsync</a>(ptrDest, ptrSource, wLength);</div>
<div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;                    <span class="keywordflow">while</span>(!<a class="code" href="_m_a_c_8h.html#a72d4a1a3347c7316acbae4d96ba44f63">MACIsMemCopyDone</a>());</div>
<div class="line"><a name="l04582"></a><span class="lineno"> 4582</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04583"></a><span class="lineno"> 4583</span>&#160;    </div>
<div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;<span class="preprocessor">                #if defined(SPIRAM_CS_TRIS)</span></div>
<div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#aba628f222575a1aeed0f684edb39351b">TCP_SPI_RAM</a>:</div>
<div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;                    <span class="keywordflow">if</span>(ptrSource!=(PTR_BASE)-1)</div>
<div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;                        <a class="code" href="_m_a_c_8h.html#aad63644420d87642a890d2f41abb7454">MACSetReadPtr</a>(ptrSource);</div>
<div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;                    w = <span class="keyword">sizeof</span>(vBuffer);</div>
<div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;                    <span class="keywordflow">while</span>(wLength)</div>
<div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;                    {</div>
<div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;                        <span class="keywordflow">if</span>(w &gt; wLength)</div>
<div class="line"><a name="l04592"></a><span class="lineno"> 4592</span>&#160;                            w = wLength;</div>
<div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;                        </div>
<div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;                        <span class="comment">// Read and write a chunk   </span></div>
<div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;                        <a class="code" href="_m_a_c_8h.html#a89d13e85195c0d00f308194305845016">MACGetArray</a>(vBuffer, w);</div>
<div class="line"><a name="l04596"></a><span class="lineno"> 4596</span>&#160;                        <a class="code" href="_s_p_i_r_a_m_8h.html#a901a1adc847c32a66f762a7a23c556cc">SPIRAMPutArray</a>(ptrDest, vBuffer, w);</div>
<div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;                        ptrDest += w;</div>
<div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;                        wLength -= w;</div>
<div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;                    }</div>
<div class="line"><a name="l04600"></a><span class="lineno"> 4600</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;<span class="preprocessor">                #endif</span></div>
<div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160;            }</div>
<div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;    </div>
<div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;<span class="preprocessor">        #if defined(SPIRAM_CS_TRIS)</span></div>
<div class="line"><a name="l04606"></a><span class="lineno"> 4606</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#aba628f222575a1aeed0f684edb39351b">TCP_SPI_RAM</a>:</div>
<div class="line"><a name="l04607"></a><span class="lineno"> 4607</span>&#160;            <span class="keywordflow">switch</span>(vDestType)</div>
<div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;            {</div>
<div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>:</div>
<div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;                    <a class="code" href="_s_p_i_r_a_m_8h.html#a31bee30d447bb33488f856251ac4c51f">SPIRAMGetArray</a>(ptrSource, (<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)ptrDest, wLength);</div>
<div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160;    </div>
<div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>:</div>
<div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160;                    <span class="keywordflow">if</span>(ptrDest!=(PTR_BASE)-1)</div>
<div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;                        <a class="code" href="_m_a_c_8h.html#a76abcd85736be75ac9dee35b573bb90d">MACSetWritePtr</a>(ptrDest);</div>
<div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;                    w = <span class="keyword">sizeof</span>(vBuffer);</div>
<div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160;                    <span class="keywordflow">while</span>(wLength)</div>
<div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;                    {</div>
<div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;                        <span class="keywordflow">if</span>(w &gt; wLength)</div>
<div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;                            w = wLength;</div>
<div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;                        </div>
<div class="line"><a name="l04622"></a><span class="lineno"> 4622</span>&#160;                        <span class="comment">// Read and write a chunk   </span></div>
<div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160;                        <a class="code" href="_s_p_i_r_a_m_8h.html#a31bee30d447bb33488f856251ac4c51f">SPIRAMGetArray</a>(ptrSource, vBuffer, w);</div>
<div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;                        ptrSource += w;</div>
<div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;                        <a class="code" href="_m_a_c_8h.html#a87a779bb5e5f2c7ffc444f52d696efa2">MACPutArray</a>(vBuffer, w);</div>
<div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;                        wLength -= w;</div>
<div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;                    }</div>
<div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04629"></a><span class="lineno"> 4629</span>&#160;    </div>
<div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#aba628f222575a1aeed0f684edb39351b">TCP_SPI_RAM</a>:</div>
<div class="line"><a name="l04631"></a><span class="lineno"> 4631</span>&#160;                    <span class="comment">// Copy all of the data over in chunks</span></div>
<div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;                    w = <span class="keyword">sizeof</span>(vBuffer);</div>
<div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;                    <span class="keywordflow">while</span>(wLength)</div>
<div class="line"><a name="l04634"></a><span class="lineno"> 4634</span>&#160;                    {</div>
<div class="line"><a name="l04635"></a><span class="lineno"> 4635</span>&#160;                        <span class="keywordflow">if</span>(w &gt; wLength)</div>
<div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;                            w = wLength;</div>
<div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160;                            </div>
<div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;                        <a class="code" href="_s_p_i_r_a_m_8h.html#a31bee30d447bb33488f856251ac4c51f">SPIRAMGetArray</a>(ptrSource, vBuffer, w);</div>
<div class="line"><a name="l04639"></a><span class="lineno"> 4639</span>&#160;                        <a class="code" href="_s_p_i_r_a_m_8h.html#a901a1adc847c32a66f762a7a23c556cc">SPIRAMPutArray</a>(ptrDest, vBuffer, w);</div>
<div class="line"><a name="l04640"></a><span class="lineno"> 4640</span>&#160;                        ptrSource += w;</div>
<div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;                        ptrDest += w;</div>
<div class="line"><a name="l04642"></a><span class="lineno"> 4642</span>&#160;                        wLength -= w;</div>
<div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160;                    }</div>
<div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;            }</div>
<div class="line"><a name="l04646"></a><span class="lineno"> 4646</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;<span class="preprocessor">        #endif          </span></div>
<div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;    }</div>
<div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;}</div>
<div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;</div>
<div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160;<span class="comment">    static void TCPRAMCopyROM(PTR_BASE wDest, BYTE wDestType, ROM BYTE* wSource, </span></div>
<div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;<span class="comment">                                WORD wLength)</span></div>
<div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;<span class="comment">    Copies data to/from various memory mediums.</span></div>
<div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160;<span class="comment">    This function copies data between memory mediums (PIC RAM, SPI</span></div>
<div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;<span class="comment">    RAM, and Ethernet buffer RAM).  This function is to be used when </span></div>
<div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;<span class="comment">    copying from ROM.</span></div>
<div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;<span class="comment">    wDest       - Address to write to</span></div>
<div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;<span class="comment">    wDestType   - Destination meidum (TCP_PIC_RAM, TCP_ETH_RAM, TCP_SPI_RAM)</span></div>
<div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;<span class="comment">    wSource     - Address to copy from</span></div>
<div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;<span class="comment">    wLength     - Number of bytes to copy</span></div>
<div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;<span class="comment">    Copying to a destination region that overlaps with the source address </span></div>
<div class="line"><a name="l04678"></a><span class="lineno"> 4678</span>&#160;<span class="comment">    is supported only if the destination start address is at a lower memory </span></div>
<div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160;<span class="comment">    address (closer to 0x0000) than the source pointer.</span></div>
<div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;<span class="comment">    This function is aliased to TCPRAMCopy on non-PIC18 platforms.</span></div>
<div class="line"><a name="l04682"></a><span class="lineno"> 4682</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;<span class="preprocessor">#if defined(__18CXX)</span></div>
<div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> TCPRAMCopyROM(PTR_BASE wDest, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> wDestType, ROM <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* wSource, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wLength)</div>
<div class="line"><a name="l04685"></a><span class="lineno"> 4685</span>&#160;{</div>
<div class="line"><a name="l04686"></a><span class="lineno"> 4686</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> vBuffer[16];</div>
<div class="line"><a name="l04687"></a><span class="lineno"> 4687</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> w;</div>
<div class="line"><a name="l04688"></a><span class="lineno"> 4688</span>&#160;    </div>
<div class="line"><a name="l04689"></a><span class="lineno"> 4689</span>&#160;    <span class="keywordflow">switch</span>(wDestType)</div>
<div class="line"><a name="l04690"></a><span class="lineno"> 4690</span>&#160;    {</div>
<div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>:</div>
<div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;            memcpypgm2ram((<span class="keywordtype">void</span>*)(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)wDest, (ROM <span class="keywordtype">void</span>*)wSource, wLength);</div>
<div class="line"><a name="l04693"></a><span class="lineno"> 4693</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04694"></a><span class="lineno"> 4694</span>&#160;    </div>
<div class="line"><a name="l04695"></a><span class="lineno"> 4695</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a>:</div>
<div class="line"><a name="l04696"></a><span class="lineno"> 4696</span>&#160;            <span class="keywordflow">if</span>(wDest!=(PTR_BASE)-1)</div>
<div class="line"><a name="l04697"></a><span class="lineno"> 4697</span>&#160;                <a class="code" href="_m_a_c_8h.html#a76abcd85736be75ac9dee35b573bb90d">MACSetWritePtr</a>(wDest);</div>
<div class="line"><a name="l04698"></a><span class="lineno"> 4698</span>&#160;            w = <span class="keyword">sizeof</span>(vBuffer);</div>
<div class="line"><a name="l04699"></a><span class="lineno"> 4699</span>&#160;            <span class="keywordflow">while</span>(wLength)</div>
<div class="line"><a name="l04700"></a><span class="lineno"> 4700</span>&#160;            {</div>
<div class="line"><a name="l04701"></a><span class="lineno"> 4701</span>&#160;                <span class="keywordflow">if</span>(w &gt; wLength)</div>
<div class="line"><a name="l04702"></a><span class="lineno"> 4702</span>&#160;                    w = wLength;</div>
<div class="line"><a name="l04703"></a><span class="lineno"> 4703</span>&#160;                </div>
<div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;                <span class="comment">// Read and write a chunk   </span></div>
<div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;                memcpypgm2ram(vBuffer, (ROM <span class="keywordtype">void</span>*)wSource, w);</div>
<div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;                <a class="code" href="_m_a_c_8h.html#a87a779bb5e5f2c7ffc444f52d696efa2">MACPutArray</a>(vBuffer, w);</div>
<div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;                wSource += w;</div>
<div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;                wLength -= w;</div>
<div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160;            }</div>
<div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160;    </div>
<div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;<span class="preprocessor">        #if defined(SPIRAM_CS_TRIS)</span></div>
<div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="_t_c_p_i_p_8h.html#aba628f222575a1aeed0f684edb39351b">TCP_SPI_RAM</a>:</div>
<div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;            w = <span class="keyword">sizeof</span>(vBuffer);</div>
<div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;            <span class="keywordflow">while</span>(wLength)</div>
<div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;            {</div>
<div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;                <span class="keywordflow">if</span>(w &gt; wLength)</div>
<div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;                    w = wLength;</div>
<div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;                </div>
<div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;                <span class="comment">// Read and write a chunk   </span></div>
<div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;                memcpypgm2ram(vBuffer, (ROM <span class="keywordtype">void</span>*)wSource, w);</div>
<div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;                <a class="code" href="_s_p_i_r_a_m_8h.html#a901a1adc847c32a66f762a7a23c556cc">SPIRAMPutArray</a>(wDest, vBuffer, w);</div>
<div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160;                wDest += w;</div>
<div class="line"><a name="l04724"></a><span class="lineno"> 4724</span>&#160;                wSource += w;</div>
<div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;                wLength -= w;</div>
<div class="line"><a name="l04726"></a><span class="lineno"> 4726</span>&#160;            }</div>
<div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;<span class="preprocessor">        #endif</span></div>
<div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;    }</div>
<div class="line"><a name="l04730"></a><span class="lineno"> 4730</span>&#160;}</div>
<div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;</div>
<div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;<span class="comment">/****************************************************************************</span></div>
<div class="line"><a name="l04734"></a><span class="lineno"> 4734</span>&#160;<span class="comment">  Section:</span></div>
<div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;<span class="comment">    SSL Functions</span></div>
<div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04737"></a><span class="lineno"> 4737</span>&#160;</div>
<div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;<span class="comment">    BOOL TCPStartSSLClient(TCP_SOCKET hTCP, BYTE* host)</span></div>
<div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;<span class="comment">    Begins an SSL client session.</span></div>
<div class="line"><a name="l04744"></a><span class="lineno"> 4744</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04746"></a><span class="lineno"> 4746</span>&#160;<span class="comment">    This function escalates the current connection to an SSL secured </span></div>
<div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;<span class="comment">    connection by initiating an SSL client handshake.</span></div>
<div class="line"><a name="l04748"></a><span class="lineno"> 4748</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04749"></a><span class="lineno"> 4749</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;<span class="comment">    TCP is initialized and hTCP is already connected.</span></div>
<div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;<span class="comment">    hTCP        - TCP connection to secure</span></div>
<div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;<span class="comment">    host        - Expected host name on certificate (currently ignored)</span></div>
<div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;<span class="comment">    TRUE        - an SSL connection was initiated</span></div>
<div class="line"><a name="l04758"></a><span class="lineno"> 4758</span>&#160;<span class="comment">    FALSE       - Insufficient SSL resources (stubs) were available</span></div>
<div class="line"><a name="l04759"></a><span class="lineno"> 4759</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l04761"></a><span class="lineno"> 4761</span>&#160;<span class="comment">    The host parameter is currently ignored and is not validated.</span></div>
<div class="line"><a name="l04762"></a><span class="lineno"> 4762</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04763"></a><span class="lineno"> 4763</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL_CLIENT)</span></div>
<div class="line"><a name="l04764"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#aa6f006c76da3ced9d0d46f2d2537198a"> 4764</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#aa6f006c76da3ced9d0d46f2d2537198a">TCPStartSSLClient</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* host)</div>
<div class="line"><a name="l04765"></a><span class="lineno"> 4765</span>&#160;{</div>
<div class="line"><a name="l04766"></a><span class="lineno"> 4766</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;</div>
<div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;    </div>
<div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l04769"></a><span class="lineno"> 4769</span>&#160;    {</div>
<div class="line"><a name="l04770"></a><span class="lineno"> 4770</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;    }</div>
<div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160;    </div>
<div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;    </div>
<div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;    <span class="comment">// Make sure SSL is not established already</span></div>
<div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;    </div>
<div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;    <span class="comment">// Try to start the session</span></div>
<div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> = <a class="code" href="_s_s_l_8h.html#a6e3cd6655fc5dd8120ba7b51085c5ae0">SSLStartSession</a>(hTCP, NULL, 0);</div>
<div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160;    </div>
<div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;    <span class="comment">// Make sure a session stub was obtained</span></div>
<div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> == SSL_INVALID_ID)</div>
<div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;</div>
<div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;    <span class="comment">// Mark connection as handshaking and return</span></div>
<div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">sslReqMessage</a> = <a class="code" href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3caa6f3b90371b211cf68edb9e1b1aa4608">SSL_CLIENT_HELLO</a>;</div>
<div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a63180a6b39bd41e931e34cbd85e965f0">bSSLHandshaking</a> = 1;</div>
<div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; 5u; i++)</div>
<div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;    {<span class="comment">// Skip first 5 bytes in TX for the record header</span></div>
<div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;        <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l04794"></a><span class="lineno"> 4794</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160;    }</div>
<div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;}</div>
<div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;<span class="preprocessor">#endif // SSL Client</span></div>
<div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;</div>
<div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04802"></a><span class="lineno"> 4802</span>&#160;<span class="comment">    BOOL TCPStartSSLClientEx(TCP_SOCKET hTCP, BYTE* host, BYTE * buffer, BYTE suppDataType)</span></div>
<div class="line"><a name="l04803"></a><span class="lineno"> 4803</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;<span class="comment">    Begins an SSL client session.</span></div>
<div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04807"></a><span class="lineno"> 4807</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160;<span class="comment">    This function escalates the current connection to an SSL secured </span></div>
<div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;<span class="comment">    connection by initiating an SSL client handshake.</span></div>
<div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;<span class="comment">    TCP is initialized and hTCP is already connected.</span></div>
<div class="line"><a name="l04813"></a><span class="lineno"> 4813</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04814"></a><span class="lineno"> 4814</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160;<span class="comment">    hTCP            - TCP connection to secure</span></div>
<div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;<span class="comment">    host            - Expected host name on certificate (currently ignored)</span></div>
<div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160;<span class="comment">    buffer          - Buffer for supplementary data return</span></div>
<div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;<span class="comment">    suppDataType    - Type of supplementary data to copy</span></div>
<div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;<span class="comment">    TRUE        - an SSL connection was initiated</span></div>
<div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;<span class="comment">    FALSE       - Insufficient SSL resources (stubs) were available</span></div>
<div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160;<span class="comment">    The host parameter is currently ignored and is not validated.</span></div>
<div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL_CLIENT)</span></div>
<div class="line"><a name="l04828"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ac63bee3cb4236129fee37b05b66ab02a"> 4828</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#ac63bee3cb4236129fee37b05b66ab02a">TCPStartSSLClientEx</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* host, <span class="keywordtype">void</span> * buffer, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> suppDataType)</div>
<div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160;{</div>
<div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;</div>
<div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;    </div>
<div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;    {</div>
<div class="line"><a name="l04834"></a><span class="lineno"> 4834</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04835"></a><span class="lineno"> 4835</span>&#160;    }</div>
<div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;    </div>
<div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l04838"></a><span class="lineno"> 4838</span>&#160;    </div>
<div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;    <span class="comment">// Make sure SSL is not established already</span></div>
<div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;    </div>
<div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160;    <span class="comment">// Try to start the session</span></div>
<div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> = <a class="code" href="_s_s_l_8h.html#a6e3cd6655fc5dd8120ba7b51085c5ae0">SSLStartSession</a>(hTCP, buffer, suppDataType);</div>
<div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;    </div>
<div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;    <span class="comment">// Make sure a session stub was obtained</span></div>
<div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> == SSL_INVALID_ID)</div>
<div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;</div>
<div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;    <span class="comment">// Mark connection as handshaking and return</span></div>
<div class="line"><a name="l04851"></a><span class="lineno"> 4851</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">sslReqMessage</a> = <a class="code" href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3caa6f3b90371b211cf68edb9e1b1aa4608">SSL_CLIENT_HELLO</a>;</div>
<div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a63180a6b39bd41e931e34cbd85e965f0">bSSLHandshaking</a> = 1;</div>
<div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; 5u; i++)</div>
<div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;    {<span class="comment">// Skip first 5 bytes in TX for the record header</span></div>
<div class="line"><a name="l04857"></a><span class="lineno"> 4857</span>&#160;        <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;    }</div>
<div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160;}</div>
<div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;<span class="preprocessor">#endif // SSL Client</span></div>
<div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;</div>
<div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;<span class="comment">    BOOL TCPStartSSLServer(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;<span class="comment">    Begins an SSL server session.</span></div>
<div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;<span class="comment">    This function sets up an SSL server session when a new connection is</span></div>
<div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;<span class="comment">    established on an SSL port.</span></div>
<div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;<span class="comment">    TCP is initialized and hTCP is already connected.</span></div>
<div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;<span class="comment">    hTCP        - TCP connection to secure</span></div>
<div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;<span class="comment">    TRUE        - an SSL connection was initiated</span></div>
<div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160;<span class="comment">    FALSE       - Insufficient SSL resources (stubs) were available</span></div>
<div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l04886"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a9be64cc028f6aef8bc603abb10073639"> 4886</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#a9be64cc028f6aef8bc603abb10073639">TCPStartSSLServer</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;{</div>
<div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;</div>
<div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;    </div>
<div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;    {</div>
<div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;    }</div>
<div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;    </div>
<div class="line"><a name="l04895"></a><span class="lineno"> 4895</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;    SyncTCB();</div>
<div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;    </div>
<div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160;    <span class="comment">// Make sure SSL is not established already</span></div>
<div class="line"><a name="l04899"></a><span class="lineno"> 4899</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> != SSL_INVALID_ID)</div>
<div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160;    </div>
<div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;    <span class="comment">// Try to start the session</span></div>
<div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> = <a class="code" href="_s_s_l_8h.html#a6e3cd6655fc5dd8120ba7b51085c5ae0">SSLStartSession</a>(hTCP, NULL, 0);</div>
<div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;    </div>
<div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;    <span class="comment">// Make sure a session stub was obtained</span></div>
<div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> == SSL_INVALID_ID)</div>
<div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;</div>
<div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160;    <span class="comment">// Swap the localPort and localSSLPort</span></div>
<div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">localPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;</div>
<div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">remoteHash</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a>;  </div>
<div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;</div>
<div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;    <span class="comment">// Mark connection as handshaking and return</span></div>
<div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">sslReqMessage</a> = <a class="code" href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3ca8a70b1ac06fee60fd90c439252ff229d">SSL_NO_MESSAGE</a>;</div>
<div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a63180a6b39bd41e931e34cbd85e965f0">bSSLHandshaking</a> = 1;</div>
<div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; 5u; i++)</div>
<div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;    {<span class="comment">// Skip first 5 bytes in TX for the record header</span></div>
<div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;        <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;    }</div>
<div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;}</div>
<div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;<span class="preprocessor">#endif // SSL Client</span></div>
<div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;</div>
<div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160;<span class="comment">    BOOL TCPAddSSLListener(TCP_SOCKET hTCP, WORD port)</span></div>
<div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;<span class="comment">    Listens for SSL connection on a specific port.</span></div>
<div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;<span class="comment">    This function adds an additional listening port to a TCP connection.  </span></div>
<div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160;<span class="comment">    Connections made on this alternate port will be secured via SSL.</span></div>
<div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;<span class="comment">    TCP is initialized and hTCP is listening.</span></div>
<div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;<span class="comment">    hTCP        - TCP connection to secure</span></div>
<div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160;<span class="comment">    port        - SSL port to listen on</span></div>
<div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160;<span class="comment">    TRUE        - SSL port was added.</span></div>
<div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;<span class="comment">    FALSE       - The socket was not a listening socket.</span></div>
<div class="line"><a name="l04949"></a><span class="lineno"> 4949</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL_SERVER)</span></div>
<div class="line"><a name="l04951"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a8214942e78ddf27c40b767e5edc25d97"> 4951</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#a8214942e78ddf27c40b767e5edc25d97">TCPAddSSLListener</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> port)</div>
<div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;{</div>
<div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;    {</div>
<div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;    }</div>
<div class="line"><a name="l04957"></a><span class="lineno"> 4957</span>&#160;    </div>
<div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;    </div>
<div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">smState</a> != <a class="code" href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b">TCP_LISTEN</a>)</div>
<div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;    </div>
<div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;    SyncTCB();</div>
<div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;    </div>
<div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;    MyTCB.<a class="code" href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">localSSLPort</a>.<a class="code" href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">Val</a> = port;</div>
<div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = port;</div>
<div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;</div>
<div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l04969"></a><span class="lineno"> 4969</span>&#160;}</div>
<div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;<span class="preprocessor">#endif // SSL Server</span></div>
<div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;</div>
<div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l04974"></a><span class="lineno"> 4974</span>&#160;<span class="comment">    BOOL TCPRequestSSLMessage(TCP_SOCKET hTCP, BYTE msg)</span></div>
<div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;<span class="comment">    Requests an SSL message to be transmitted.</span></div>
<div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04979"></a><span class="lineno"> 4979</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;<span class="comment">    This function is called to request that a specific SSL message be</span></div>
<div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;<span class="comment">    transmitted.  This message should only be called by the SSL module.</span></div>
<div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;<span class="comment">    TCP is initialized.</span></div>
<div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;<span class="comment">    hTCP        - TCP connection to use</span></div>
<div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160;<span class="comment">    msg         - One of the SSL_MESSAGE types to transmit.</span></div>
<div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;<span class="comment">    TRUE        - The message was requested.</span></div>
<div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;<span class="comment">    FALSE       - Another message is already pending transmission.</span></div>
<div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l04995"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a07ef2578bb03e45aa95d22538713652c"> 4995</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#a07ef2578bb03e45aa95d22538713652c">TCPRequestSSLMessage</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> msg)</div>
<div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;{</div>
<div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160;    {</div>
<div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;    }</div>
<div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160;    </div>
<div class="line"><a name="l05002"></a><span class="lineno"> 5002</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;    </div>
<div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160;    <span class="keywordflow">if</span>(msg == <a class="code" href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3ca8a70b1ac06fee60fd90c439252ff229d">SSL_NO_MESSAGE</a> || MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">sslReqMessage</a> == <a class="code" href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3ca8a70b1ac06fee60fd90c439252ff229d">SSL_NO_MESSAGE</a>)</div>
<div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;    {</div>
<div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">sslReqMessage</a> = msg;</div>
<div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;    }</div>
<div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;    </div>
<div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;}</div>
<div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;<span class="preprocessor">#endif // SSL</span></div>
<div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160;</div>
<div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;<span class="comment">    BOOL TCPSSLIsHandshaking(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05018"></a><span class="lineno"> 5018</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;<span class="comment">    Determines if an SSL session is still handshaking.</span></div>
<div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;<span class="comment">    Call this function after calling TCPStartSSLClient until FALSE is</span></div>
<div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160;<span class="comment">    returned.  Then your application may continue with its normal data</span></div>
<div class="line"><a name="l05024"></a><span class="lineno"> 5024</span>&#160;<span class="comment">    transfer (which is now secured).</span></div>
<div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;<span class="comment">    TCP is initialized and hTCP is connected.</span></div>
<div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05029"></a><span class="lineno"> 5029</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160;<span class="comment">    hTCP        - TCP connection to check</span></div>
<div class="line"><a name="l05031"></a><span class="lineno"> 5031</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05032"></a><span class="lineno"> 5032</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;<span class="comment">    TRUE        - SSL handshake is still progressing</span></div>
<div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;<span class="comment">    FALSE       - SSL handshake has completed</span></div>
<div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05037"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#abe7ba29a2e4d1993e906baa1c8eee785"> 5037</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#abe7ba29a2e4d1993e906baa1c8eee785">TCPSSLIsHandshaking</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;{</div>
<div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;    {</div>
<div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;    }</div>
<div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;    </div>
<div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160;    <span class="keywordflow">return</span> MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a63180a6b39bd41e931e34cbd85e965f0">bSSLHandshaking</a>; </div>
<div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;}</div>
<div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;<span class="preprocessor">#endif // SSL</span></div>
<div class="line"><a name="l05048"></a><span class="lineno"> 5048</span>&#160;</div>
<div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05051"></a><span class="lineno"> 5051</span>&#160;<span class="comment">    BOOL TCPIsSSL(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l05052"></a><span class="lineno"> 5052</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;<span class="comment">    Determines if a TCP connection is secured with SSL.</span></div>
<div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;<span class="comment">    Call this function to determine whether or not a TCP connection is </span></div>
<div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;<span class="comment">    secured with SSL.</span></div>
<div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;<span class="comment">    TCP is initialized and hTCP is connected.</span></div>
<div class="line"><a name="l05062"></a><span class="lineno"> 5062</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;<span class="comment">    hTCP        - TCP connection to check</span></div>
<div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;<span class="comment">  Return Values:</span></div>
<div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;<span class="comment">    TRUE        - Connection is secured via SSL</span></div>
<div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160;<span class="comment">    FALSE       - Connection is not secured</span></div>
<div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05071"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a"> 5071</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="code" href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a">TCPIsSSL</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;{</div>
<div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05074"></a><span class="lineno"> 5074</span>&#160;    {</div>
<div class="line"><a name="l05075"></a><span class="lineno"> 5075</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l05076"></a><span class="lineno"> 5076</span>&#160;    }</div>
<div class="line"><a name="l05077"></a><span class="lineno"> 5077</span>&#160;    </div>
<div class="line"><a name="l05078"></a><span class="lineno"> 5078</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05079"></a><span class="lineno"> 5079</span>&#160;    </div>
<div class="line"><a name="l05080"></a><span class="lineno"> 5080</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a> == SSL_INVALID_ID)</div>
<div class="line"><a name="l05081"></a><span class="lineno"> 5081</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;</div>
<div class="line"><a name="l05082"></a><span class="lineno"> 5082</span>&#160;    </div>
<div class="line"><a name="l05083"></a><span class="lineno"> 5083</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a>;</div>
<div class="line"><a name="l05084"></a><span class="lineno"> 5084</span>&#160;}</div>
<div class="line"><a name="l05085"></a><span class="lineno"> 5085</span>&#160;<span class="preprocessor">#endif // SSL</span></div>
<div class="line"><a name="l05086"></a><span class="lineno"> 5086</span>&#160;</div>
<div class="line"><a name="l05087"></a><span class="lineno"> 5087</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05088"></a><span class="lineno"> 5088</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05089"></a><span class="lineno"> 5089</span>&#160;<span class="comment">    void TCPSSLHandshakeComplete(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l05090"></a><span class="lineno"> 5090</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05091"></a><span class="lineno"> 5091</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05092"></a><span class="lineno"> 5092</span>&#160;<span class="comment">    Clears the SSL handshake flag.</span></div>
<div class="line"><a name="l05093"></a><span class="lineno"> 5093</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05094"></a><span class="lineno"> 5094</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05095"></a><span class="lineno"> 5095</span>&#160;<span class="comment">    This function clears the flag indicating that an SSL handshake is</span></div>
<div class="line"><a name="l05096"></a><span class="lineno"> 5096</span>&#160;<span class="comment">    complete.</span></div>
<div class="line"><a name="l05097"></a><span class="lineno"> 5097</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05098"></a><span class="lineno"> 5098</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05099"></a><span class="lineno"> 5099</span>&#160;<span class="comment">    TCP is initialized and hTCP is connected.</span></div>
<div class="line"><a name="l05100"></a><span class="lineno"> 5100</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05101"></a><span class="lineno"> 5101</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05102"></a><span class="lineno"> 5102</span>&#160;<span class="comment">    hTCP        - TCP connection to set</span></div>
<div class="line"><a name="l05103"></a><span class="lineno"> 5103</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05104"></a><span class="lineno"> 5104</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l05105"></a><span class="lineno"> 5105</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l05106"></a><span class="lineno"> 5106</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05107"></a><span class="lineno"> 5107</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l05108"></a><span class="lineno"> 5108</span>&#160;<span class="comment">    This function should never be called by an application.  It is used </span></div>
<div class="line"><a name="l05109"></a><span class="lineno"> 5109</span>&#160;<span class="comment">    only by the SSL module itself.</span></div>
<div class="line"><a name="l05110"></a><span class="lineno"> 5110</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05111"></a><span class="lineno"> 5111</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05112"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#adec02cc1509ee936b96812db8c714fc7"> 5112</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#adec02cc1509ee936b96812db8c714fc7">TCPSSLHandshakeComplete</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l05113"></a><span class="lineno"> 5113</span>&#160;{</div>
<div class="line"><a name="l05114"></a><span class="lineno"> 5114</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05115"></a><span class="lineno"> 5115</span>&#160;    {</div>
<div class="line"><a name="l05116"></a><span class="lineno"> 5116</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l05117"></a><span class="lineno"> 5117</span>&#160;    }</div>
<div class="line"><a name="l05118"></a><span class="lineno"> 5118</span>&#160;    </div>
<div class="line"><a name="l05119"></a><span class="lineno"> 5119</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05120"></a><span class="lineno"> 5120</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">Flags</a>.<a class="code" href="struct_t_c_b___s_t_u_b.html#a63180a6b39bd41e931e34cbd85e965f0">bSSLHandshaking</a> = 0;</div>
<div class="line"><a name="l05121"></a><span class="lineno"> 5121</span>&#160;}</div>
<div class="line"><a name="l05122"></a><span class="lineno"> 5122</span>&#160;<span class="preprocessor">#endif // SSL</span></div>
<div class="line"><a name="l05123"></a><span class="lineno"> 5123</span>&#160;</div>
<div class="line"><a name="l05124"></a><span class="lineno"> 5124</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05125"></a><span class="lineno"> 5125</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05126"></a><span class="lineno"> 5126</span>&#160;<span class="comment">    void TCPSSLDecryptMAC(TCP_SOCKET hTCP, ARCFOUR_CTX* ctx, WORD len)</span></div>
<div class="line"><a name="l05127"></a><span class="lineno"> 5127</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05128"></a><span class="lineno"> 5128</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05129"></a><span class="lineno"> 5129</span>&#160;<span class="comment">    Decrypts and MACs data arriving via SSL.</span></div>
<div class="line"><a name="l05130"></a><span class="lineno"> 5130</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05131"></a><span class="lineno"> 5131</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05132"></a><span class="lineno"> 5132</span>&#160;<span class="comment">    This function decrypts data in the TCP buffer and calculates the MAC over</span></div>
<div class="line"><a name="l05133"></a><span class="lineno"> 5133</span>&#160;<span class="comment">    the data.  All data is left in the exact same location in the TCP buffer.</span></div>
<div class="line"><a name="l05134"></a><span class="lineno"> 5134</span>&#160;<span class="comment">    It is called to help process incoming SSL records.</span></div>
<div class="line"><a name="l05135"></a><span class="lineno"> 5135</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05136"></a><span class="lineno"> 5136</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05137"></a><span class="lineno"> 5137</span>&#160;<span class="comment">    TCP is initialized, hTCP is connected, and ctx&#39;s Sbox is loaded.</span></div>
<div class="line"><a name="l05138"></a><span class="lineno"> 5138</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05139"></a><span class="lineno"> 5139</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05140"></a><span class="lineno"> 5140</span>&#160;<span class="comment">    hTCP        - TCP connection to decrypt in</span></div>
<div class="line"><a name="l05141"></a><span class="lineno"> 5141</span>&#160;<span class="comment">    ctx         - ARCFOUR encryption context to use</span></div>
<div class="line"><a name="l05142"></a><span class="lineno"> 5142</span>&#160;<span class="comment">    len         - Number of bytes to crypt</span></div>
<div class="line"><a name="l05143"></a><span class="lineno"> 5143</span>&#160;<span class="comment">    inPlace     - TRUE to write back in place, FALSE to write at end of</span></div>
<div class="line"><a name="l05144"></a><span class="lineno"> 5144</span>&#160;<span class="comment">                    currently visible data.</span></div>
<div class="line"><a name="l05145"></a><span class="lineno"> 5145</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05146"></a><span class="lineno"> 5146</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l05147"></a><span class="lineno"> 5147</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l05148"></a><span class="lineno"> 5148</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05149"></a><span class="lineno"> 5149</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l05150"></a><span class="lineno"> 5150</span>&#160;<span class="comment">    This function should never be called by an application.  It is used </span></div>
<div class="line"><a name="l05151"></a><span class="lineno"> 5151</span>&#160;<span class="comment">    only by the SSL module itself.</span></div>
<div class="line"><a name="l05152"></a><span class="lineno"> 5152</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05153"></a><span class="lineno"> 5153</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05154"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a63ddce4a03bda22230cf593d0c3d9825"> 5154</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#a63ddce4a03bda22230cf593d0c3d9825">TCPSSLDecryptMAC</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="struct_a_r_c_f_o_u_r___c_t_x.html">ARCFOUR_CTX</a>* ctx, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len)</div>
<div class="line"><a name="l05155"></a><span class="lineno"> 5155</span>&#160;{</div>
<div class="line"><a name="l05156"></a><span class="lineno"> 5156</span>&#160;    PTR_BASE wSrc, wDest, wBlockLen, wTemp;</div>
<div class="line"><a name="l05157"></a><span class="lineno"> 5157</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> buffer[32];</div>
<div class="line"><a name="l05158"></a><span class="lineno"> 5158</span>&#160;    </div>
<div class="line"><a name="l05159"></a><span class="lineno"> 5159</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05160"></a><span class="lineno"> 5160</span>&#160;    {</div>
<div class="line"><a name="l05161"></a><span class="lineno"> 5161</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l05162"></a><span class="lineno"> 5162</span>&#160;    }</div>
<div class="line"><a name="l05163"></a><span class="lineno"> 5163</span>&#160;    </div>
<div class="line"><a name="l05164"></a><span class="lineno"> 5164</span>&#160;    <span class="comment">// Set up the pointers</span></div>
<div class="line"><a name="l05165"></a><span class="lineno"> 5165</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05166"></a><span class="lineno"> 5166</span>&#160;    wSrc = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>;</div>
<div class="line"><a name="l05167"></a><span class="lineno"> 5167</span>&#160;    wDest = wSrc;</div>
<div class="line"><a name="l05168"></a><span class="lineno"> 5168</span>&#160;    </div>
<div class="line"><a name="l05169"></a><span class="lineno"> 5169</span>&#160;    <span class="comment">// Handle 32 bytes at a time</span></div>
<div class="line"><a name="l05170"></a><span class="lineno"> 5170</span>&#160;    <span class="keywordflow">while</span>(len)</div>
<div class="line"><a name="l05171"></a><span class="lineno"> 5171</span>&#160;    {</div>
<div class="line"><a name="l05172"></a><span class="lineno"> 5172</span>&#160;        <span class="comment">// Determine how many bytes we can read</span></div>
<div class="line"><a name="l05173"></a><span class="lineno"> 5173</span>&#160;        wBlockLen = <span class="keyword">sizeof</span>(buffer);</div>
<div class="line"><a name="l05174"></a><span class="lineno"> 5174</span>&#160;        <span class="keywordflow">if</span>(wBlockLen &gt; len) <span class="comment">// Don&#39;t do more than we should</span></div>
<div class="line"><a name="l05175"></a><span class="lineno"> 5175</span>&#160;            wBlockLen = len;</div>
<div class="line"><a name="l05176"></a><span class="lineno"> 5176</span>&#160;        </div>
<div class="line"><a name="l05177"></a><span class="lineno"> 5177</span>&#160;        <span class="comment">// Read those bytes to a buffer</span></div>
<div class="line"><a name="l05178"></a><span class="lineno"> 5178</span>&#160;        <span class="keywordflow">if</span>(wSrc + wBlockLen &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l05179"></a><span class="lineno"> 5179</span>&#160;        {<span class="comment">// Two part read</span></div>
<div class="line"><a name="l05180"></a><span class="lineno"> 5180</span>&#160;            wTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - wSrc + 1;</div>
<div class="line"><a name="l05181"></a><span class="lineno"> 5181</span>&#160;            TCPRAMCopy((PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wSrc, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wTemp);</div>
<div class="line"><a name="l05182"></a><span class="lineno"> 5182</span>&#160;            TCPRAMCopy((PTR_BASE)buffer+wTemp, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wBlockLen - wTemp);</div>
<div class="line"><a name="l05183"></a><span class="lineno"> 5183</span>&#160;            wSrc = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + wBlockLen - wTemp;</div>
<div class="line"><a name="l05184"></a><span class="lineno"> 5184</span>&#160;        }</div>
<div class="line"><a name="l05185"></a><span class="lineno"> 5185</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l05186"></a><span class="lineno"> 5186</span>&#160;        {</div>
<div class="line"><a name="l05187"></a><span class="lineno"> 5187</span>&#160;            TCPRAMCopy((PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wSrc, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wBlockLen);</div>
<div class="line"><a name="l05188"></a><span class="lineno"> 5188</span>&#160;            wSrc += wBlockLen;</div>
<div class="line"><a name="l05189"></a><span class="lineno"> 5189</span>&#160;        }</div>
<div class="line"><a name="l05190"></a><span class="lineno"> 5190</span>&#160;        </div>
<div class="line"><a name="l05191"></a><span class="lineno"> 5191</span>&#160;        <span class="comment">// Decrypt and hash</span></div>
<div class="line"><a name="l05192"></a><span class="lineno"> 5192</span>&#160;        <a class="code" href="_a_r_c_f_o_u_r_8h.html#a396caa5732461f89a22534ca087e9002">ARCFOURCrypt</a>(ctx, buffer, wBlockLen);</div>
<div class="line"><a name="l05193"></a><span class="lineno"> 5193</span>&#160;        <a class="code" href="_s_s_l_8h.html#a3cf8678c85307a7368eba201d2ecf7fb">SSLMACAdd</a>(buffer, wBlockLen);</div>
<div class="line"><a name="l05194"></a><span class="lineno"> 5194</span>&#160;        </div>
<div class="line"><a name="l05195"></a><span class="lineno"> 5195</span>&#160;        <span class="comment">// Write decrypted bytes back</span></div>
<div class="line"><a name="l05196"></a><span class="lineno"> 5196</span>&#160;        <span class="keywordflow">if</span>(wDest + wBlockLen &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l05197"></a><span class="lineno"> 5197</span>&#160;        {<span class="comment">// Two part write</span></div>
<div class="line"><a name="l05198"></a><span class="lineno"> 5198</span>&#160;            wTemp = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - wDest + 1;</div>
<div class="line"><a name="l05199"></a><span class="lineno"> 5199</span>&#160;            TCPRAMCopy(wDest, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wTemp);</div>
<div class="line"><a name="l05200"></a><span class="lineno"> 5200</span>&#160;            TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)buffer+wTemp, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wBlockLen - wTemp);</div>
<div class="line"><a name="l05201"></a><span class="lineno"> 5201</span>&#160;            wDest = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + wBlockLen - wTemp;</div>
<div class="line"><a name="l05202"></a><span class="lineno"> 5202</span>&#160;        }</div>
<div class="line"><a name="l05203"></a><span class="lineno"> 5203</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l05204"></a><span class="lineno"> 5204</span>&#160;        {</div>
<div class="line"><a name="l05205"></a><span class="lineno"> 5205</span>&#160;            TCPRAMCopy(wDest, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, wBlockLen);</div>
<div class="line"><a name="l05206"></a><span class="lineno"> 5206</span>&#160;            wDest += wBlockLen;</div>
<div class="line"><a name="l05207"></a><span class="lineno"> 5207</span>&#160;        }</div>
<div class="line"><a name="l05208"></a><span class="lineno"> 5208</span>&#160;        </div>
<div class="line"><a name="l05209"></a><span class="lineno"> 5209</span>&#160;        <span class="comment">// Update the length remaining</span></div>
<div class="line"><a name="l05210"></a><span class="lineno"> 5210</span>&#160;        len -= wBlockLen;</div>
<div class="line"><a name="l05211"></a><span class="lineno"> 5211</span>&#160;    }</div>
<div class="line"><a name="l05212"></a><span class="lineno"> 5212</span>&#160;}   </div>
<div class="line"><a name="l05213"></a><span class="lineno"> 5213</span>&#160;<span class="preprocessor">#endif // SSL</span></div>
<div class="line"><a name="l05214"></a><span class="lineno"> 5214</span>&#160;</div>
<div class="line"><a name="l05215"></a><span class="lineno"> 5215</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05216"></a><span class="lineno"> 5216</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05217"></a><span class="lineno"> 5217</span>&#160;<span class="comment">    void TCPSSLInPlaceMACEncrypt(TCP_SOCKET hTCP, ARCFOUR_CTX* ctx, </span></div>
<div class="line"><a name="l05218"></a><span class="lineno"> 5218</span>&#160;<span class="comment">                                    BYTE* MACSecret, WORD len)</span></div>
<div class="line"><a name="l05219"></a><span class="lineno"> 5219</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05220"></a><span class="lineno"> 5220</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05221"></a><span class="lineno"> 5221</span>&#160;<span class="comment">    Encrypts and MACs data in place in the TCP TX buffer.</span></div>
<div class="line"><a name="l05222"></a><span class="lineno"> 5222</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05223"></a><span class="lineno"> 5223</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05224"></a><span class="lineno"> 5224</span>&#160;<span class="comment">    This function encrypts data in the TCP buffer while calcuating a MAC.  </span></div>
<div class="line"><a name="l05225"></a><span class="lineno"> 5225</span>&#160;<span class="comment">    When encryption is finished, the MAC is appended to the buffer and </span></div>
<div class="line"><a name="l05226"></a><span class="lineno"> 5226</span>&#160;<span class="comment">    the record will be ready to transmit.</span></div>
<div class="line"><a name="l05227"></a><span class="lineno"> 5227</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05228"></a><span class="lineno"> 5228</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05229"></a><span class="lineno"> 5229</span>&#160;<span class="comment">    TCP is initialized, hTCP is connected, and ctx&#39;s Sbox is loaded.</span></div>
<div class="line"><a name="l05230"></a><span class="lineno"> 5230</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05231"></a><span class="lineno"> 5231</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05232"></a><span class="lineno"> 5232</span>&#160;<span class="comment">    hTCP        - TCP connection to encrypt in</span></div>
<div class="line"><a name="l05233"></a><span class="lineno"> 5233</span>&#160;<span class="comment">    ctx         - ARCFOUR encryption context to use</span></div>
<div class="line"><a name="l05234"></a><span class="lineno"> 5234</span>&#160;<span class="comment">    MACSecret   - MAC encryption secret to use</span></div>
<div class="line"><a name="l05235"></a><span class="lineno"> 5235</span>&#160;<span class="comment">    len         - Number of bytes to crypt</span></div>
<div class="line"><a name="l05236"></a><span class="lineno"> 5236</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05237"></a><span class="lineno"> 5237</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l05238"></a><span class="lineno"> 5238</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l05239"></a><span class="lineno"> 5239</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05240"></a><span class="lineno"> 5240</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l05241"></a><span class="lineno"> 5241</span>&#160;<span class="comment">    This function should never be called by an application.  It is used </span></div>
<div class="line"><a name="l05242"></a><span class="lineno"> 5242</span>&#160;<span class="comment">    only by the SSL module itself.</span></div>
<div class="line"><a name="l05243"></a><span class="lineno"> 5243</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05244"></a><span class="lineno"> 5244</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05245"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a423af91678aeffc96d8fb908c4bf834d"> 5245</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#a423af91678aeffc96d8fb908c4bf834d">TCPSSLInPlaceMACEncrypt</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="struct_a_r_c_f_o_u_r___c_t_x.html">ARCFOUR_CTX</a>* ctx, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* MACSecret, <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> len)</div>
<div class="line"><a name="l05246"></a><span class="lineno"> 5246</span>&#160;{</div>
<div class="line"><a name="l05247"></a><span class="lineno"> 5247</span>&#160;    PTR_BASE pos;</div>
<div class="line"><a name="l05248"></a><span class="lineno"> 5248</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> blockLen;</div>
<div class="line"><a name="l05249"></a><span class="lineno"> 5249</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> buffer[32];</div>
<div class="line"><a name="l05250"></a><span class="lineno"> 5250</span>&#160;    </div>
<div class="line"><a name="l05251"></a><span class="lineno"> 5251</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05252"></a><span class="lineno"> 5252</span>&#160;    {</div>
<div class="line"><a name="l05253"></a><span class="lineno"> 5253</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l05254"></a><span class="lineno"> 5254</span>&#160;    }</div>
<div class="line"><a name="l05255"></a><span class="lineno"> 5255</span>&#160;    </div>
<div class="line"><a name="l05256"></a><span class="lineno"> 5256</span>&#160;    <span class="comment">// Set up the pointers</span></div>
<div class="line"><a name="l05257"></a><span class="lineno"> 5257</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05258"></a><span class="lineno"> 5258</span>&#160;    pos = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>;</div>
<div class="line"><a name="l05259"></a><span class="lineno"> 5259</span>&#160;    <span class="keywordflow">for</span>(blockLen = 0; blockLen &lt; 5u; blockLen++)</div>
<div class="line"><a name="l05260"></a><span class="lineno"> 5260</span>&#160;    {<span class="comment">// Skips first 5 bytes for the header</span></div>
<div class="line"><a name="l05261"></a><span class="lineno"> 5261</span>&#160;        <span class="keywordflow">if</span>(++pos &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l05262"></a><span class="lineno"> 5262</span>&#160;            pos = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l05263"></a><span class="lineno"> 5263</span>&#160;    }</div>
<div class="line"><a name="l05264"></a><span class="lineno"> 5264</span>&#160;    </div>
<div class="line"><a name="l05265"></a><span class="lineno"> 5265</span>&#160;    <span class="comment">// Handle 32 bytes at a time</span></div>
<div class="line"><a name="l05266"></a><span class="lineno"> 5266</span>&#160;    <span class="keywordflow">while</span>(len)</div>
<div class="line"><a name="l05267"></a><span class="lineno"> 5267</span>&#160;    {</div>
<div class="line"><a name="l05268"></a><span class="lineno"> 5268</span>&#160;        <span class="comment">// Determine how many bytes we can read</span></div>
<div class="line"><a name="l05269"></a><span class="lineno"> 5269</span>&#160;        blockLen = <span class="keyword">sizeof</span>(buffer);</div>
<div class="line"><a name="l05270"></a><span class="lineno"> 5270</span>&#160;        <span class="keywordflow">if</span>(blockLen &gt; len) <span class="comment">// Don&#39;t do more than we should</span></div>
<div class="line"><a name="l05271"></a><span class="lineno"> 5271</span>&#160;            blockLen = len;</div>
<div class="line"><a name="l05272"></a><span class="lineno"> 5272</span>&#160;        <span class="keywordflow">if</span>(blockLen &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - pos) <span class="comment">// Don&#39;t pass the end</span></div>
<div class="line"><a name="l05273"></a><span class="lineno"> 5273</span>&#160;            blockLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - pos;</div>
<div class="line"><a name="l05274"></a><span class="lineno"> 5274</span>&#160;        </div>
<div class="line"><a name="l05275"></a><span class="lineno"> 5275</span>&#160;        <span class="comment">// Read those bytes to a buffer</span></div>
<div class="line"><a name="l05276"></a><span class="lineno"> 5276</span>&#160;        TCPRAMCopy((PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, pos, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, blockLen);</div>
<div class="line"><a name="l05277"></a><span class="lineno"> 5277</span>&#160;        </div>
<div class="line"><a name="l05278"></a><span class="lineno"> 5278</span>&#160;        <span class="comment">// Hash and encrypt</span></div>
<div class="line"><a name="l05279"></a><span class="lineno"> 5279</span>&#160;        <a class="code" href="_s_s_l_8h.html#a3cf8678c85307a7368eba201d2ecf7fb">SSLMACAdd</a>(buffer, blockLen);</div>
<div class="line"><a name="l05280"></a><span class="lineno"> 5280</span>&#160;        <a class="code" href="_a_r_c_f_o_u_r_8h.html#a396caa5732461f89a22534ca087e9002">ARCFOURCrypt</a>(ctx, buffer, blockLen);</div>
<div class="line"><a name="l05281"></a><span class="lineno"> 5281</span>&#160;        </div>
<div class="line"><a name="l05282"></a><span class="lineno"> 5282</span>&#160;        <span class="comment">// Put them back</span></div>
<div class="line"><a name="l05283"></a><span class="lineno"> 5283</span>&#160;        TCPRAMCopy(pos, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, blockLen);</div>
<div class="line"><a name="l05284"></a><span class="lineno"> 5284</span>&#160;        </div>
<div class="line"><a name="l05285"></a><span class="lineno"> 5285</span>&#160;        <span class="comment">// Update the pointers</span></div>
<div class="line"><a name="l05286"></a><span class="lineno"> 5286</span>&#160;        pos += blockLen;</div>
<div class="line"><a name="l05287"></a><span class="lineno"> 5287</span>&#160;        len -= blockLen;</div>
<div class="line"><a name="l05288"></a><span class="lineno"> 5288</span>&#160;        <span class="keywordflow">if</span>(pos &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l05289"></a><span class="lineno"> 5289</span>&#160;            pos = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l05290"></a><span class="lineno"> 5290</span>&#160;    }</div>
<div class="line"><a name="l05291"></a><span class="lineno"> 5291</span>&#160;    </div>
<div class="line"><a name="l05292"></a><span class="lineno"> 5292</span>&#160;    <span class="comment">// Calculate and add the MAC</span></div>
<div class="line"><a name="l05293"></a><span class="lineno"> 5293</span>&#160;    <a class="code" href="_s_s_l_8h.html#a58f586f8d87cd2ae8268523c591c93dc">SSLMACCalc</a>(MACSecret, buffer);</div>
<div class="line"><a name="l05294"></a><span class="lineno"> 5294</span>&#160;    <a class="code" href="_a_r_c_f_o_u_r_8h.html#a396caa5732461f89a22534ca087e9002">ARCFOURCrypt</a>(ctx, buffer, 16);</div>
<div class="line"><a name="l05295"></a><span class="lineno"> 5295</span>&#160;</div>
<div class="line"><a name="l05296"></a><span class="lineno"> 5296</span>&#160;    <span class="comment">// Write the MAC to the TX FIFO</span></div>
<div class="line"><a name="l05297"></a><span class="lineno"> 5297</span>&#160;    <span class="comment">// Can&#39;t use TCPPutArray here because TCPIsPutReady() saves 16 bytes for the MAC</span></div>
<div class="line"><a name="l05298"></a><span class="lineno"> 5298</span>&#160;    <span class="comment">// TCPPut* functions use this to prevent writing too much data.  Therefore, the</span></div>
<div class="line"><a name="l05299"></a><span class="lineno"> 5299</span>&#160;    <span class="comment">// functionality is duplicated here.</span></div>
<div class="line"><a name="l05300"></a><span class="lineno"> 5300</span>&#160;    </div>
<div class="line"><a name="l05301"></a><span class="lineno"> 5301</span>&#160;    len = 16;</div>
<div class="line"><a name="l05302"></a><span class="lineno"> 5302</span>&#160;    blockLen = 0;</div>
<div class="line"><a name="l05303"></a><span class="lineno"> 5303</span>&#160;    <span class="comment">// See if we need a two part put</span></div>
<div class="line"><a name="l05304"></a><span class="lineno"> 5304</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> + len &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l05305"></a><span class="lineno"> 5305</span>&#160;    {</div>
<div class="line"><a name="l05306"></a><span class="lineno"> 5306</span>&#160;        blockLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>-MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>;</div>
<div class="line"><a name="l05307"></a><span class="lineno"> 5307</span>&#160;        TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)buffer, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, blockLen);</div>
<div class="line"><a name="l05308"></a><span class="lineno"> 5308</span>&#160;        len -= blockLen;</div>
<div class="line"><a name="l05309"></a><span class="lineno"> 5309</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l05310"></a><span class="lineno"> 5310</span>&#160;    }</div>
<div class="line"><a name="l05311"></a><span class="lineno"> 5311</span>&#160;    </div>
<div class="line"><a name="l05312"></a><span class="lineno"> 5312</span>&#160;    TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)&amp;buffer[blockLen], <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, len);</div>
<div class="line"><a name="l05313"></a><span class="lineno"> 5313</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> += len;</div>
<div class="line"><a name="l05314"></a><span class="lineno"> 5314</span>&#160;</div>
<div class="line"><a name="l05315"></a><span class="lineno"> 5315</span>&#160;}   </div>
<div class="line"><a name="l05316"></a><span class="lineno"> 5316</span>&#160;<span class="preprocessor">#endif // SSL</span></div>
<div class="line"><a name="l05317"></a><span class="lineno"> 5317</span>&#160;</div>
<div class="line"><a name="l05318"></a><span class="lineno"> 5318</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05319"></a><span class="lineno"> 5319</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05320"></a><span class="lineno"> 5320</span>&#160;<span class="comment">    void TCPSSLPutRecordHeader(TCP_SOCKET hTCP, BYTE* hdr, BOOL recDone)</span></div>
<div class="line"><a name="l05321"></a><span class="lineno"> 5321</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05322"></a><span class="lineno"> 5322</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05323"></a><span class="lineno"> 5323</span>&#160;<span class="comment">    Writes an SSL record header and sends an SSL record.</span></div>
<div class="line"><a name="l05324"></a><span class="lineno"> 5324</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05325"></a><span class="lineno"> 5325</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05326"></a><span class="lineno"> 5326</span>&#160;<span class="comment">    This function writes an SSL record header to the pending TCP SSL data, </span></div>
<div class="line"><a name="l05327"></a><span class="lineno"> 5327</span>&#160;<span class="comment">    then indicates that the data is ready to be sent by moving the txHead</span></div>
<div class="line"><a name="l05328"></a><span class="lineno"> 5328</span>&#160;<span class="comment">    pointer.</span></div>
<div class="line"><a name="l05329"></a><span class="lineno"> 5329</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05330"></a><span class="lineno"> 5330</span>&#160;<span class="comment">    If the record is complete, set recDone to TRUE.  The sslTxHead </span></div>
<div class="line"><a name="l05331"></a><span class="lineno"> 5331</span>&#160;<span class="comment">    pointer will be moved forward 5 bytes to leave space for a future </span></div>
<div class="line"><a name="l05332"></a><span class="lineno"> 5332</span>&#160;<span class="comment">    record header.  If the record is only partially sent, use FALSE and</span></div>
<div class="line"><a name="l05333"></a><span class="lineno"> 5333</span>&#160;<span class="comment">    to leave the pointer where it is so that more data can be added</span></div>
<div class="line"><a name="l05334"></a><span class="lineno"> 5334</span>&#160;<span class="comment">    to the record.  Partial records can only be used for the </span></div>
<div class="line"><a name="l05335"></a><span class="lineno"> 5335</span>&#160;<span class="comment">    SERVER_CERTIFICATE handshake message.</span></div>
<div class="line"><a name="l05336"></a><span class="lineno"> 5336</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05337"></a><span class="lineno"> 5337</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05338"></a><span class="lineno"> 5338</span>&#160;<span class="comment">    TCP is initialized, and hTCP is connected with an active SSL session.</span></div>
<div class="line"><a name="l05339"></a><span class="lineno"> 5339</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05340"></a><span class="lineno"> 5340</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05341"></a><span class="lineno"> 5341</span>&#160;<span class="comment">    hTCP        - TCP connection to write the header and transmit with</span></div>
<div class="line"><a name="l05342"></a><span class="lineno"> 5342</span>&#160;<span class="comment">    hdr         - Record header (5 bytes) to send or NULL to just </span></div>
<div class="line"><a name="l05343"></a><span class="lineno"> 5343</span>&#160;<span class="comment">                  move the pointerctx</span></div>
<div class="line"><a name="l05344"></a><span class="lineno"> 5344</span>&#160;<span class="comment">    recDone     - TRUE if the record is done, FALSE otherwise</span></div>
<div class="line"><a name="l05345"></a><span class="lineno"> 5345</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05346"></a><span class="lineno"> 5346</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l05347"></a><span class="lineno"> 5347</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l05348"></a><span class="lineno"> 5348</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05349"></a><span class="lineno"> 5349</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l05350"></a><span class="lineno"> 5350</span>&#160;<span class="comment">    This function should never be called by an application.  It is used </span></div>
<div class="line"><a name="l05351"></a><span class="lineno"> 5351</span>&#160;<span class="comment">    only by the SSL module itself.</span></div>
<div class="line"><a name="l05352"></a><span class="lineno"> 5352</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05353"></a><span class="lineno"> 5353</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05354"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#a83f916c6c4f2c0db03647c37da11e838"> 5354</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#a83f916c6c4f2c0db03647c37da11e838">TCPSSLPutRecordHeader</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP, <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* hdr, <a class="code" href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a> recDone)</div>
<div class="line"><a name="l05355"></a><span class="lineno"> 5355</span>&#160;{</div>
<div class="line"><a name="l05356"></a><span class="lineno"> 5356</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;</div>
<div class="line"><a name="l05357"></a><span class="lineno"> 5357</span>&#160;    </div>
<div class="line"><a name="l05358"></a><span class="lineno"> 5358</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05359"></a><span class="lineno"> 5359</span>&#160;    {</div>
<div class="line"><a name="l05360"></a><span class="lineno"> 5360</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l05361"></a><span class="lineno"> 5361</span>&#160;    }</div>
<div class="line"><a name="l05362"></a><span class="lineno"> 5362</span>&#160;    </div>
<div class="line"><a name="l05363"></a><span class="lineno"> 5363</span>&#160;    <span class="comment">// Set up the pointers</span></div>
<div class="line"><a name="l05364"></a><span class="lineno"> 5364</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05365"></a><span class="lineno"> 5365</span>&#160;    </div>
<div class="line"><a name="l05366"></a><span class="lineno"> 5366</span>&#160;    <span class="comment">// Write the header if needed</span></div>
<div class="line"><a name="l05367"></a><span class="lineno"> 5367</span>&#160;    <span class="keywordflow">if</span>(hdr)</div>
<div class="line"><a name="l05368"></a><span class="lineno"> 5368</span>&#160;    {<span class="comment">// This is a new record, so insert the header</span></div>
<div class="line"><a name="l05369"></a><span class="lineno"> 5369</span>&#160;        <span class="keywordflow">for</span>(i = 0; i &lt; 5u; i++)</div>
<div class="line"><a name="l05370"></a><span class="lineno"> 5370</span>&#160;        {</div>
<div class="line"><a name="l05371"></a><span class="lineno"> 5371</span>&#160;            TCPRAMCopy(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, (PTR_BASE)hdr+i, <a class="code" href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a>, <span class="keyword">sizeof</span>(<a class="code" href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>));</div>
<div class="line"><a name="l05372"></a><span class="lineno"> 5372</span>&#160;            <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l05373"></a><span class="lineno"> 5373</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l05374"></a><span class="lineno"> 5374</span>&#160;        }</div>
<div class="line"><a name="l05375"></a><span class="lineno"> 5375</span>&#160;    }</div>
<div class="line"><a name="l05376"></a><span class="lineno"> 5376</span>&#160;    </div>
<div class="line"><a name="l05377"></a><span class="lineno"> 5377</span>&#160;    <span class="comment">// Move the txHead pointer to indicate what data is ready</span></div>
<div class="line"><a name="l05378"></a><span class="lineno"> 5378</span>&#160;    <span class="comment">// Also, flush just the header, then all the data.  This shotguns two </span></div>
<div class="line"><a name="l05379"></a><span class="lineno"> 5379</span>&#160;    <span class="comment">// packets down the line, therefore causing immediate ACKs by the </span></div>
<div class="line"><a name="l05380"></a><span class="lineno"> 5380</span>&#160;    <span class="comment">// remote node.  Reconnect handshakes are as much as 60% faster now.</span></div>
<div class="line"><a name="l05381"></a><span class="lineno"> 5381</span>&#160;    <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP);</div>
<div class="line"><a name="l05382"></a><span class="lineno"> 5382</span>&#160;    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a>;</div>
<div class="line"><a name="l05383"></a><span class="lineno"> 5383</span>&#160;    <a class="code" href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a>(hTCP);</div>
<div class="line"><a name="l05384"></a><span class="lineno"> 5384</span>&#160;    </div>
<div class="line"><a name="l05385"></a><span class="lineno"> 5385</span>&#160;    <span class="comment">// If this record is done, move the sslTxHead forward</span></div>
<div class="line"><a name="l05386"></a><span class="lineno"> 5386</span>&#160;    <span class="comment">// to accomodate the next record header</span></div>
<div class="line"><a name="l05387"></a><span class="lineno"> 5387</span>&#160;    <span class="keywordflow">if</span>(recDone)</div>
<div class="line"><a name="l05388"></a><span class="lineno"> 5388</span>&#160;    {</div>
<div class="line"><a name="l05389"></a><span class="lineno"> 5389</span>&#160;        <span class="keywordflow">for</span>(i = 0; i &lt; 5u; i++)</div>
<div class="line"><a name="l05390"></a><span class="lineno"> 5390</span>&#160;        {<span class="comment">// Skip first 5 bytes in TX for the record header</span></div>
<div class="line"><a name="l05391"></a><span class="lineno"> 5391</span>&#160;            <span class="keywordflow">if</span>(++MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &gt;= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l05392"></a><span class="lineno"> 5392</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a>;</div>
<div class="line"><a name="l05393"></a><span class="lineno"> 5393</span>&#160;        }</div>
<div class="line"><a name="l05394"></a><span class="lineno"> 5394</span>&#160;    }</div>
<div class="line"><a name="l05395"></a><span class="lineno"> 5395</span>&#160;}   </div>
<div class="line"><a name="l05396"></a><span class="lineno"> 5396</span>&#160;<span class="preprocessor">#endif // SSL</span></div>
<div class="line"><a name="l05397"></a><span class="lineno"> 5397</span>&#160;</div>
<div class="line"><a name="l05398"></a><span class="lineno"> 5398</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05399"></a><span class="lineno"> 5399</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05400"></a><span class="lineno"> 5400</span>&#160;<span class="comment">    WORD TCPSSLGetPendingTxSize(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l05401"></a><span class="lineno"> 5401</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05402"></a><span class="lineno"> 5402</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05403"></a><span class="lineno"> 5403</span>&#160;<span class="comment">    Determines how many bytes are pending for a future SSL record.</span></div>
<div class="line"><a name="l05404"></a><span class="lineno"> 5404</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05405"></a><span class="lineno"> 5405</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05406"></a><span class="lineno"> 5406</span>&#160;<span class="comment">    This function determines how many bytes are pending for a future SSL</span></div>
<div class="line"><a name="l05407"></a><span class="lineno"> 5407</span>&#160;<span class="comment">    record.</span></div>
<div class="line"><a name="l05408"></a><span class="lineno"> 5408</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05409"></a><span class="lineno"> 5409</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05410"></a><span class="lineno"> 5410</span>&#160;<span class="comment">    TCP is initialized, and hTCP is connected with an active SSL connection.</span></div>
<div class="line"><a name="l05411"></a><span class="lineno"> 5411</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05412"></a><span class="lineno"> 5412</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05413"></a><span class="lineno"> 5413</span>&#160;<span class="comment">    hTCP        - TCP connection to check</span></div>
<div class="line"><a name="l05414"></a><span class="lineno"> 5414</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05415"></a><span class="lineno"> 5415</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l05416"></a><span class="lineno"> 5416</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l05417"></a><span class="lineno"> 5417</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05418"></a><span class="lineno"> 5418</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05419"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#af62b584e06310e5a763cd87ff3c5c7ae"> 5419</a></span>&#160;<a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="code" href="_t_c_p_8c.html#af62b584e06310e5a763cd87ff3c5c7ae">TCPSSLGetPendingTxSize</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l05420"></a><span class="lineno"> 5420</span>&#160;{</div>
<div class="line"><a name="l05421"></a><span class="lineno"> 5421</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05422"></a><span class="lineno"> 5422</span>&#160;    {</div>
<div class="line"><a name="l05423"></a><span class="lineno"> 5423</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l05424"></a><span class="lineno"> 5424</span>&#160;    }</div>
<div class="line"><a name="l05425"></a><span class="lineno"> 5425</span>&#160;    </div>
<div class="line"><a name="l05426"></a><span class="lineno"> 5426</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05427"></a><span class="lineno"> 5427</span>&#160;</div>
<div class="line"><a name="l05428"></a><span class="lineno"> 5428</span>&#160;    <span class="comment">// Non-SSL connections have no pending SSL data</span></div>
<div class="line"><a name="l05429"></a><span class="lineno"> 5429</span>&#160;    <span class="comment">//if(MyTCBStub.sslStubID == SSL_INVALID_ID)</span></div>
<div class="line"><a name="l05430"></a><span class="lineno"> 5430</span>&#160;    <span class="comment">//  return 0;</span></div>
<div class="line"><a name="l05431"></a><span class="lineno"> 5431</span>&#160;            </div>
<div class="line"><a name="l05432"></a><span class="lineno"> 5432</span>&#160;    <span class="comment">// Determine how many bytes are waiting to be written in this record</span></div>
<div class="line"><a name="l05433"></a><span class="lineno"> 5433</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a>)</div>
<div class="line"><a name="l05434"></a><span class="lineno"> 5434</span>&#160;        <span class="keywordflow">return</span> MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> - 5;</div>
<div class="line"><a name="l05435"></a><span class="lineno"> 5435</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l05436"></a><span class="lineno"> 5436</span>&#160;        <span class="keywordflow">return</span> (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">bufferTxStart</a> - 1) - (MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">txHead</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">sslTxHead</a> - 1) - 5;</div>
<div class="line"><a name="l05437"></a><span class="lineno"> 5437</span>&#160;}</div>
<div class="line"><a name="l05438"></a><span class="lineno"> 5438</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05439"></a><span class="lineno"> 5439</span>&#160;</div>
<div class="line"><a name="l05440"></a><span class="lineno"> 5440</span>&#160;</div>
<div class="line"><a name="l05441"></a><span class="lineno"> 5441</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l05442"></a><span class="lineno"> 5442</span>&#160;<span class="comment">  Function:</span></div>
<div class="line"><a name="l05443"></a><span class="lineno"> 5443</span>&#160;<span class="comment">    void TCPSSLHandleIncoming(TCP_SOCKET hTCP)</span></div>
<div class="line"><a name="l05444"></a><span class="lineno"> 5444</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05445"></a><span class="lineno"> 5445</span>&#160;<span class="comment">  Summary:</span></div>
<div class="line"><a name="l05446"></a><span class="lineno"> 5446</span>&#160;<span class="comment">    Hands newly arrive TCP data to the SSL module for processing.</span></div>
<div class="line"><a name="l05447"></a><span class="lineno"> 5447</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05448"></a><span class="lineno"> 5448</span>&#160;<span class="comment">  Description:</span></div>
<div class="line"><a name="l05449"></a><span class="lineno"> 5449</span>&#160;<span class="comment">    This function processes incoming TCP data as an SSL record and </span></div>
<div class="line"><a name="l05450"></a><span class="lineno"> 5450</span>&#160;<span class="comment">    performs any necessary repositioning and decrypting.</span></div>
<div class="line"><a name="l05451"></a><span class="lineno"> 5451</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l05452"></a><span class="lineno"> 5452</span>&#160;<span class="comment">  Precondition:</span></div>
<div class="line"><a name="l05453"></a><span class="lineno"> 5453</span>&#160;<span class="comment">    TCP is initialized, and hTCP is connected with an active SSL session.</span></div>
<div class="line"><a name="l05454"></a><span class="lineno"> 5454</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05455"></a><span class="lineno"> 5455</span>&#160;<span class="comment">  Parameters:</span></div>
<div class="line"><a name="l05456"></a><span class="lineno"> 5456</span>&#160;<span class="comment">    hTCP        - TCP connection to handle incoming data on</span></div>
<div class="line"><a name="l05457"></a><span class="lineno"> 5457</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05458"></a><span class="lineno"> 5458</span>&#160;<span class="comment">  Returns:</span></div>
<div class="line"><a name="l05459"></a><span class="lineno"> 5459</span>&#160;<span class="comment">    None</span></div>
<div class="line"><a name="l05460"></a><span class="lineno"> 5460</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l05461"></a><span class="lineno"> 5461</span>&#160;<span class="comment">  Remarks:</span></div>
<div class="line"><a name="l05462"></a><span class="lineno"> 5462</span>&#160;<span class="comment">    This function should never be called by an application.  It is used </span></div>
<div class="line"><a name="l05463"></a><span class="lineno"> 5463</span>&#160;<span class="comment">    only by the SSL module itself.</span></div>
<div class="line"><a name="l05464"></a><span class="lineno"> 5464</span>&#160;<span class="comment">  ***************************************************************************/</span></div>
<div class="line"><a name="l05465"></a><span class="lineno"> 5465</span>&#160;<span class="preprocessor">#if defined(STACK_USE_SSL)</span></div>
<div class="line"><a name="l05466"></a><span class="lineno"><a class="line" href="_t_c_p_8c.html#ad03097c0020aa6abe8446835dde60c9a"> 5466</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_t_c_p_8c.html#ad03097c0020aa6abe8446835dde60c9a">TCPSSLHandleIncoming</a>(<a class="code" href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a> hTCP)</div>
<div class="line"><a name="l05467"></a><span class="lineno"> 5467</span>&#160;{</div>
<div class="line"><a name="l05468"></a><span class="lineno"> 5468</span>&#160;    PTR_BASE prevRxTail, nextRxHead, startRxTail, wSrc, wDest;</div>
<div class="line"><a name="l05469"></a><span class="lineno"> 5469</span>&#160;    <a class="code" href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> wToMove, wLen, wSSLBytesThatPoofed, wDecryptedBytes;</div>
<div class="line"><a name="l05470"></a><span class="lineno"> 5470</span>&#160;    </div>
<div class="line"><a name="l05471"></a><span class="lineno"> 5471</span>&#160;    <span class="keywordflow">if</span>(hTCP &gt;= TCP_SOCKET_COUNT)</div>
<div class="line"><a name="l05472"></a><span class="lineno"> 5472</span>&#160;    {</div>
<div class="line"><a name="l05473"></a><span class="lineno"> 5473</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l05474"></a><span class="lineno"> 5474</span>&#160;    }</div>
<div class="line"><a name="l05475"></a><span class="lineno"> 5475</span>&#160;    </div>
<div class="line"><a name="l05476"></a><span class="lineno"> 5476</span>&#160;    <span class="comment">// Sync the stub</span></div>
<div class="line"><a name="l05477"></a><span class="lineno"> 5477</span>&#160;    SyncTCBStub(hTCP);</div>
<div class="line"><a name="l05478"></a><span class="lineno"> 5478</span>&#160;</div>
<div class="line"><a name="l05479"></a><span class="lineno"> 5479</span>&#160;    <span class="comment">// If new data is waiting</span></div>
<div class="line"><a name="l05480"></a><span class="lineno"> 5480</span>&#160;    <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> != MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>)</div>
<div class="line"><a name="l05481"></a><span class="lineno"> 5481</span>&#160;    {</div>
<div class="line"><a name="l05482"></a><span class="lineno"> 5482</span>&#160;        <span class="comment">// Reconfigure pointers for SSL use</span></div>
<div class="line"><a name="l05483"></a><span class="lineno"> 5483</span>&#160;        prevRxTail = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>;</div>
<div class="line"><a name="l05484"></a><span class="lineno"> 5484</span>&#160;        nextRxHead = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l05485"></a><span class="lineno"> 5485</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l05486"></a><span class="lineno"> 5486</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a>;</div>
<div class="line"><a name="l05487"></a><span class="lineno"> 5487</span>&#160;        </div>
<div class="line"><a name="l05488"></a><span class="lineno"> 5488</span>&#160;        <span class="keywordflow">do</span></div>
<div class="line"><a name="l05489"></a><span class="lineno"> 5489</span>&#160;        {</div>
<div class="line"><a name="l05490"></a><span class="lineno"> 5490</span>&#160;            startRxTail = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>;</div>
<div class="line"><a name="l05491"></a><span class="lineno"> 5491</span>&#160;</div>
<div class="line"><a name="l05492"></a><span class="lineno"> 5492</span>&#160;            <span class="comment">// Handle incoming data.  This function performs deframing of the </span></div>
<div class="line"><a name="l05493"></a><span class="lineno"> 5493</span>&#160;            <span class="comment">// SSL records, decryption, and MAC verification.</span></div>
<div class="line"><a name="l05494"></a><span class="lineno"> 5494</span>&#160;            wSSLBytesThatPoofed = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l05495"></a><span class="lineno"> 5495</span>&#160;            wDecryptedBytes = <a class="code" href="_s_s_l_8h.html#a5efb945b370a663ad5e0b882ff1c878f">SSLRxRecord</a>(hTCP, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">sslStubID</a>);</div>
<div class="line"><a name="l05496"></a><span class="lineno"> 5496</span>&#160;            wSSLBytesThatPoofed -= <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l05497"></a><span class="lineno"> 5497</span>&#160;</div>
<div class="line"><a name="l05498"></a><span class="lineno"> 5498</span>&#160;            <span class="comment">// Now need to move data to fill the SSL header/MAC/padding hole, </span></div>
<div class="line"><a name="l05499"></a><span class="lineno"> 5499</span>&#160;            <span class="comment">// if there is one</span></div>
<div class="line"><a name="l05500"></a><span class="lineno"> 5500</span>&#160;            <span class="keywordflow">if</span>(wSSLBytesThatPoofed)</div>
<div class="line"><a name="l05501"></a><span class="lineno"> 5501</span>&#160;            {   </div>
<div class="line"><a name="l05502"></a><span class="lineno"> 5502</span>&#160;                <span class="comment">// Sync the TCP so we can see if there is a TCP hole</span></div>
<div class="line"><a name="l05503"></a><span class="lineno"> 5503</span>&#160;                SyncTCB();</div>
<div class="line"><a name="l05504"></a><span class="lineno"> 5504</span>&#160;</div>
<div class="line"><a name="l05505"></a><span class="lineno"> 5505</span>&#160;                <span class="comment">// Calculate how big the SSL hole is</span></div>
<div class="line"><a name="l05506"></a><span class="lineno"> 5506</span>&#160;                <span class="keywordflow">if</span>(MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> == -1)</div>
<div class="line"><a name="l05507"></a><span class="lineno"> 5507</span>&#160;                {<span class="comment">// Just need to move pending SSL data</span></div>
<div class="line"><a name="l05508"></a><span class="lineno"> 5508</span>&#160;                    wToMove = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP);</div>
<div class="line"><a name="l05509"></a><span class="lineno"> 5509</span>&#160;                }</div>
<div class="line"><a name="l05510"></a><span class="lineno"> 5510</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l05511"></a><span class="lineno"> 5511</span>&#160;                {<span class="comment">// A TCP hole exists, so move all data</span></div>
<div class="line"><a name="l05512"></a><span class="lineno"> 5512</span>&#160;                    wToMove = <a class="code" href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a>(hTCP) + MyTCB.<a class="code" href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">sHoleSize</a> + MyTCB.<a class="code" href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">wFutureDataSize</a>;</div>
<div class="line"><a name="l05513"></a><span class="lineno"> 5513</span>&#160;                }</div>
<div class="line"><a name="l05514"></a><span class="lineno"> 5514</span>&#160;                </div>
<div class="line"><a name="l05515"></a><span class="lineno"> 5515</span>&#160;                <span class="comment">// Start with the destination as the startRxTail and source as current rxTail</span></div>
<div class="line"><a name="l05516"></a><span class="lineno"> 5516</span>&#160;                wDest = startRxTail;</div>
<div class="line"><a name="l05517"></a><span class="lineno"> 5517</span>&#160;                wSrc = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>;</div>
<div class="line"><a name="l05518"></a><span class="lineno"> 5518</span>&#160;                </div>
<div class="line"><a name="l05519"></a><span class="lineno"> 5519</span>&#160;                <span class="comment">// If data exists between the end of the buffer and </span></div>
<div class="line"><a name="l05520"></a><span class="lineno"> 5520</span>&#160;                <span class="comment">// the destination, then move it forward</span></div>
<div class="line"><a name="l05521"></a><span class="lineno"> 5521</span>&#160;                <span class="keywordflow">if</span>(wSrc &gt; wDest)</div>
<div class="line"><a name="l05522"></a><span class="lineno"> 5522</span>&#160;                {</div>
<div class="line"><a name="l05523"></a><span class="lineno"> 5523</span>&#160;                    wLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - wSrc + 1;</div>
<div class="line"><a name="l05524"></a><span class="lineno"> 5524</span>&#160;                    <span class="keywordflow">if</span>(wLen &gt; wToMove)</div>
<div class="line"><a name="l05525"></a><span class="lineno"> 5525</span>&#160;                        wLen = wToMove;</div>
<div class="line"><a name="l05526"></a><span class="lineno"> 5526</span>&#160;                    TCPRAMCopy(wDest, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, </div>
<div class="line"><a name="l05527"></a><span class="lineno"> 5527</span>&#160;                               wSrc, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wLen);</div>
<div class="line"><a name="l05528"></a><span class="lineno"> 5528</span>&#160;                    wDest += wLen;</div>
<div class="line"><a name="l05529"></a><span class="lineno"> 5529</span>&#160;                    wSrc = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l05530"></a><span class="lineno"> 5530</span>&#160;                    wToMove -= wLen;</div>
<div class="line"><a name="l05531"></a><span class="lineno"> 5531</span>&#160;                }</div>
<div class="line"><a name="l05532"></a><span class="lineno"> 5532</span>&#160;                </div>
<div class="line"><a name="l05533"></a><span class="lineno"> 5533</span>&#160;                <span class="comment">// If data remains to be moved, fill in to end of buffer</span></div>
<div class="line"><a name="l05534"></a><span class="lineno"> 5534</span>&#160;                <span class="keywordflow">if</span>(wToMove)</div>
<div class="line"><a name="l05535"></a><span class="lineno"> 5535</span>&#160;                {</div>
<div class="line"><a name="l05536"></a><span class="lineno"> 5536</span>&#160;                    wLen = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - wDest + 1;</div>
<div class="line"><a name="l05537"></a><span class="lineno"> 5537</span>&#160;                    <span class="keywordflow">if</span>(wLen &gt; wToMove)</div>
<div class="line"><a name="l05538"></a><span class="lineno"> 5538</span>&#160;                        wLen = wToMove;</div>
<div class="line"><a name="l05539"></a><span class="lineno"> 5539</span>&#160;                    TCPRAMCopy(wDest, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, </div>
<div class="line"><a name="l05540"></a><span class="lineno"> 5540</span>&#160;                               wSrc, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wLen);</div>
<div class="line"><a name="l05541"></a><span class="lineno"> 5541</span>&#160;                    wDest = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>;</div>
<div class="line"><a name="l05542"></a><span class="lineno"> 5542</span>&#160;                    wSrc += wLen;</div>
<div class="line"><a name="l05543"></a><span class="lineno"> 5543</span>&#160;                    wToMove -= wLen;</div>
<div class="line"><a name="l05544"></a><span class="lineno"> 5544</span>&#160;                }</div>
<div class="line"><a name="l05545"></a><span class="lineno"> 5545</span>&#160;                </div>
<div class="line"><a name="l05546"></a><span class="lineno"> 5546</span>&#160;                <span class="comment">// If data still remains, copy from from front + len to front</span></div>
<div class="line"><a name="l05547"></a><span class="lineno"> 5547</span>&#160;                <span class="keywordflow">if</span>(wToMove)</div>
<div class="line"><a name="l05548"></a><span class="lineno"> 5548</span>&#160;                {</div>
<div class="line"><a name="l05549"></a><span class="lineno"> 5549</span>&#160;                    TCPRAMCopy(wDest, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>,</div>
<div class="line"><a name="l05550"></a><span class="lineno"> 5550</span>&#160;                               wSrc, MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a>, wToMove);</div>
<div class="line"><a name="l05551"></a><span class="lineno"> 5551</span>&#160;                }</div>
<div class="line"><a name="l05552"></a><span class="lineno"> 5552</span>&#160;</div>
<div class="line"><a name="l05553"></a><span class="lineno"> 5553</span>&#160;                <span class="comment">// Since bytes poofed, we need to move the head pointers </span></div>
<div class="line"><a name="l05554"></a><span class="lineno"> 5554</span>&#160;                <span class="comment">// backwards by an equal amount.</span></div>
<div class="line"><a name="l05555"></a><span class="lineno"> 5555</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> -= wSSLBytesThatPoofed;</div>
<div class="line"><a name="l05556"></a><span class="lineno"> 5556</span>&#160;                <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> &lt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a>)</div>
<div class="line"><a name="l05557"></a><span class="lineno"> 5557</span>&#160;                    MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> += MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;</div>
<div class="line"><a name="l05558"></a><span class="lineno"> 5558</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">sslRxHead</a> = MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a>;</div>
<div class="line"><a name="l05559"></a><span class="lineno"> 5559</span>&#160;            }</div>
<div class="line"><a name="l05560"></a><span class="lineno"> 5560</span>&#160;                </div>
<div class="line"><a name="l05561"></a><span class="lineno"> 5561</span>&#160;            <span class="comment">// Move tail pointer forward by the number of decrypted bytes ready </span></div>
<div class="line"><a name="l05562"></a><span class="lineno"> 5562</span>&#160;            <span class="comment">// for the application (but not poofed bytes)</span></div>
<div class="line"><a name="l05563"></a><span class="lineno"> 5563</span>&#160;            MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = startRxTail + wDecryptedBytes;</div>
<div class="line"><a name="l05564"></a><span class="lineno"> 5564</span>&#160;            <span class="keywordflow">if</span>(MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l05565"></a><span class="lineno"> 5565</span>&#160;                MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;</div>
<div class="line"><a name="l05566"></a><span class="lineno"> 5566</span>&#160;            nextRxHead += wDecryptedBytes;</div>
<div class="line"><a name="l05567"></a><span class="lineno"> 5567</span>&#160;            </div>
<div class="line"><a name="l05568"></a><span class="lineno"> 5568</span>&#160;            <span class="comment">// Loop until SSLRxRecord() runs out of data and stops doing </span></div>
<div class="line"><a name="l05569"></a><span class="lineno"> 5569</span>&#160;            <span class="comment">// anything</span></div>
<div class="line"><a name="l05570"></a><span class="lineno"> 5570</span>&#160;        } <span class="keywordflow">while</span>(wSSLBytesThatPoofed || (startRxTail != MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a>));</div>
<div class="line"><a name="l05571"></a><span class="lineno"> 5571</span>&#160;</div>
<div class="line"><a name="l05572"></a><span class="lineno"> 5572</span>&#160;        <span class="comment">// Restore TCP buffer pointers to point to the decrypted application data </span></div>
<div class="line"><a name="l05573"></a><span class="lineno"> 5573</span>&#160;        <span class="comment">// only</span></div>
<div class="line"><a name="l05574"></a><span class="lineno"> 5574</span>&#160;        <span class="keywordflow">if</span>(nextRxHead &gt; MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a>)</div>
<div class="line"><a name="l05575"></a><span class="lineno"> 5575</span>&#160;            nextRxHead -= MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">bufferEnd</a> - MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">bufferRxStart</a> + 1;</div>
<div class="line"><a name="l05576"></a><span class="lineno"> 5576</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">rxTail</a> = prevRxTail;</div>
<div class="line"><a name="l05577"></a><span class="lineno"> 5577</span>&#160;        MyTCBStub.<a class="code" href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">rxHead</a> = nextRxHead;</div>
<div class="line"><a name="l05578"></a><span class="lineno"> 5578</span>&#160;    }</div>
<div class="line"><a name="l05579"></a><span class="lineno"> 5579</span>&#160;}   </div>
<div class="line"><a name="l05580"></a><span class="lineno"> 5580</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05581"></a><span class="lineno"> 5581</span>&#160;</div>
<div class="line"><a name="l05582"></a><span class="lineno"> 5582</span>&#160;</div>
<div class="line"><a name="l05583"></a><span class="lineno"> 5583</span>&#160;<span class="preprocessor">#endif //#if defined(STACK_USE_TCP)</span></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a246f53628bdda1bc5bd5bda6eaf30f8f"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a246f53628bdda1bc5bd5bda6eaf30f8f">TCP_GATEWAY_GET_ARP</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00077">TCP.h:77</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a7b763068bda0dba69136cc2f9ed88aa9"><div class="ttname"><a href="_t_c_p_8c.html#a7b763068bda0dba69136cc2f9ed88aa9">TCPOpen</a></div><div class="ttdeci">TCP_SOCKET TCPOpen(DWORD dwRemoteHost, BYTE vRemoteHostType, WORD wPort, BYTE vSocketPurpose)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00594">TCP.c:594</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a35d3a823f8212fdb4ee305fb6dfe16f8"><div class="ttname"><a href="_t_c_p_8c.html#a35d3a823f8212fdb4ee305fb6dfe16f8">TCPFindArrayEx</a></div><div class="ttdeci">WORD TCPFindArrayEx(TCP_SOCKET hTCP, BYTE *cFindArray, WORD wLen, WORD wStart, WORD wSearchLen, BOOL bTextCompare)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01970">TCP.c:1970</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a3cf8678c85307a7368eba201d2ecf7fb"><div class="ttname"><a href="_s_s_l_8h.html#a3cf8678c85307a7368eba201d2ecf7fb">SSLMACAdd</a></div><div class="ttdeci">void SSLMACAdd(BYTE *data, WORD len)</div></div>
<div class="ttc" id="_t_c_p_8c_html_a1fa693b8370b2bb1f10823881a95612c"><div class="ttname"><a href="_t_c_p_8c.html#a1fa693b8370b2bb1f10823881a95612c">TCPProcess</a></div><div class="ttdeci">BOOL TCPProcess(NODE_INFO *remote, IP_ADDR *localIP, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l02811">TCP.c:2811</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a979649935757125e531ffac76be1200c"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a979649935757125e531ffac76be1200c">TCP_DNS_RESOLVE</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00075">TCP.h:75</a></div></div>
<div class="ttc" id="_i_p_8h_html_a33cd719865ee57f9591c92a63e74d59f"><div class="ttname"><a href="_i_p_8h.html#a33cd719865ee57f9591c92a63e74d59f">IPSetRxBuffer</a></div><div class="ttdeci">void IPSetRxBuffer(WORD Offset)</div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8c_source.html#l00299">IP.c:299</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a02643e9de8ceb55dd2a4669b53af4ba8"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a02643e9de8ceb55dd2a4669b53af4ba8">TCB_STUB::bSocketReset</a></div><div class="ttdeci">unsigned char bSocketReset</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00138">TCP.h:138</a></div></div>
<div class="ttc" id="struct_t_c_b_html_ab1e41ee8fe38bfb894ab8035087a3aeb"><div class="ttname"><a href="struct_t_c_b.html#ab1e41ee8fe38bfb894ab8035087a3aeb">TCB::MySEQ</a></div><div class="ttdeci">DWORD MySEQ</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00162">TCP.h:162</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a246b502fed0f04ba167ba7b4e998e1a7"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a246b502fed0f04ba167ba7b4e998e1a7">TCP_HEADER::Flags</a></div><div class="ttdeci">union TCP_HEADER::@488 Flags</div></div>
<div class="ttc" id="_t_c_p_8c_html_a63ddce4a03bda22230cf593d0c3d9825"><div class="ttname"><a href="_t_c_p_8c.html#a63ddce4a03bda22230cf593d0c3d9825">TCPSSLDecryptMAC</a></div><div class="ttdeci">void TCPSSLDecryptMAC(TCP_SOCKET hTCP, ARCFOUR_CTX *ctx, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05154">TCP.c:5154</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_a75b511078d49e6f61adc139aec3e6a74"><div class="ttname"><a href="_t_c_p_i_p_8h.html#a75b511078d49e6f61adc139aec3e6a74">TCP_SPI_RAM_SIZE</a></div><div class="ttdeci">#define TCP_SPI_RAM_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00209">TCPIP.h:209</a></div></div>
<div class="ttc" id="_helpers_8h_html_add09104747ab0b189bcd8137ab2458ea"><div class="ttname"><a href="_helpers_8h.html#add09104747ab0b189bcd8137ab2458ea">swaps</a></div><div class="ttdeci">WORD swaps(WORD v)</div><div class="ttdef"><b>Definition:</b> <a href="_helpers_8c_source.html#l01087">Helpers.c:1087</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a6a6329eb22236074b0f6b501ef3fdedf"><div class="ttname"><a href="struct_t_c_b.html#a6a6329eb22236074b0f6b501ef3fdedf">TCB::txUnackedTail</a></div><div class="ttdeci">PTR_BASE txUnackedTail</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00164">TCP.h:164</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a2e55714917e9fc97950ee037f14dcc7a"><div class="ttname"><a href="_t_c_p_8c.html#a2e55714917e9fc97950ee037f14dcc7a">TCPIsSSL</a></div><div class="ttdeci">BOOL TCPIsSSL(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05071">TCP.c:5071</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_ad66bc7b8521da8dc7e4d7768a8544705"><div class="ttname"><a href="_t_c_p_8c.html#ad66bc7b8521da8dc7e4d7768a8544705">TCPWasReset</a></div><div class="ttdeci">BOOL TCPWasReset(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00727">TCP.c:727</a></div></div>
<div class="ttc" id="struct___p_s_e_u_d_o___h_e_a_d_e_r_html_a89fa95e930f178cad3eae53104b93622"><div class="ttname"><a href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a89fa95e930f178cad3eae53104b93622">_PSEUDO_HEADER::SourceAddress</a></div><div class="ttdeci">IP_ADDR SourceAddress</div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8h_source.html#l00082">IP.h:82</a></div></div>
<div class="ttc" id="struct_t_c_p___o_p_t_i_o_n_s_html_ae875c7698e130ba8324b8746c3ef7a11"><div class="ttname"><a href="struct_t_c_p___o_p_t_i_o_n_s.html#ae875c7698e130ba8324b8746c3ef7a11">TCP_OPTIONS::Length</a></div><div class="ttdeci">BYTE Length</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00183">TCP.c:183</a></div></div>
<div class="ttc" id="struct_t_c_b_html_ad819775df364f9ddf85d4568ffe1ed18"><div class="ttname"><a href="struct_t_c_b.html#ad819775df364f9ddf85d4568ffe1ed18">TCB::RemoteSEQ</a></div><div class="ttdeci">DWORD RemoteSEQ</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00163">TCP.h:163</a></div></div>
<div class="ttc" id="_d_n_s_8h_html_a27e8ba4b66a0d78061be23911cd3a426"><div class="ttname"><a href="_d_n_s_8h.html#a27e8ba4b66a0d78061be23911cd3a426">DNSEndUsage</a></div><div class="ttdeci">BOOL DNSEndUsage(void)</div><div class="ttdef"><b>Definition:</b> <a href="_d_n_s_8c_source.html#l00206">DNS.c:206</a></div></div>
<div class="ttc" id="struct_t_c_b_html_aa71085d8339f25c6ebce50737f9e58fb"><div class="ttname"><a href="struct_t_c_b.html#aa71085d8339f25c6ebce50737f9e58fb">TCB::localPort</a></div><div class="ttdeci">WORD_VAL localPort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00166">TCP.h:166</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a09bdc0d5beae9f460788baec2d455a75"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a09bdc0d5beae9f460788baec2d455a75">TCP_HEADER::SeqNumber</a></div><div class="ttdeci">DWORD SeqNumber</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00148">TCP.c:148</a></div></div>
<div class="ttc" id="_d_n_s_8h_html_af437c76bc5d24f46a06064cfaef1c84a"><div class="ttname"><a href="_d_n_s_8h.html#af437c76bc5d24f46a06064cfaef1c84a">DNSResolveROM</a></div><div class="ttdeci">void DNSResolveROM(ROM BYTE *Hostname, BYTE Type)</div><div class="ttdef"><b>Definition:</b> <a href="_d_n_s_8c_source.html#l00303">DNS.c:303</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a154886bc2d25d87f4ea5446ffd54d858"><div class="ttname"><a href="_t_c_p_8c.html#a154886bc2d25d87f4ea5446ffd54d858">TCPPut</a></div><div class="ttdeci">BOOL TCPPut(TCP_SOCKET hTCP, BYTE byte)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01150">TCP.c:1150</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_abc8c237ba79d8186d8cb3de7df3a131a"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#abc8c237ba79d8186d8cb3de7df3a131a">TCP_HEADER::AckNumber</a></div><div class="ttdeci">DWORD AckNumber</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00149">TCP.c:149</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_abf1b4439c5f152ddb383859e5a0f3bd3"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#abf1b4439c5f152ddb383859e5a0f3bd3">TCB_STUB::bTXASAP</a></div><div class="ttdeci">unsigned char bTXASAP</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00135">TCP.h:135</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_ac2c356648731743c25b7588ac42f1216"><div class="ttname"><a href="_t_c_p_8c.html#ac2c356648731743c25b7588ac42f1216">TCPPeekArray</a></div><div class="ttdeci">WORD TCPPeekArray(TCP_SOCKET hTCP, BYTE *vBuffer, WORD wLen, WORD wStart)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01841">TCP.c:1841</a></div></div>
<div class="ttc" id="union_w_o_r_d___v_a_l_html_aa498550e7f87da9a38dc71609652e6bd"><div class="ttname"><a href="union_w_o_r_d___v_a_l.html#aa498550e7f87da9a38dc71609652e6bd">WORD_VAL::Val</a></div><div class="ttdeci">WORD Val</div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00372">GenericTypeDefs.h:372</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_aa7f87c3d5228b0da55681f228c67df44"><div class="ttname"><a href="_t_c_p_8c.html#aa7f87c3d5228b0da55681f228c67df44">TCPPutROMString</a></div><div class="ttdeci">ROM BYTE * TCPPutROMString(TCP_SOCKET hTCP, ROM BYTE *data)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01510">TCP.c:1510</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_a4ae1dab0fb4b072a66584546209e7d58"><div class="ttname"><a href="_generic_type_defs_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a></div><div class="ttdeci">unsigned char BYTE</div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00342">GenericTypeDefs.h:342</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_aa14ab130bfd7824b97f571fe55139fc4"><div class="ttname"><a href="_t_c_p_8c.html#aa14ab130bfd7824b97f571fe55139fc4">TCPInit</a></div><div class="ttdeci">void TCPInit(void)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00373">TCP.c:373</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a2b4e5624c7ff0110540b0b87b484c636"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a2b4e5624c7ff0110540b0b87b484c636">TCB_STUB::bTXFIN</a></div><div class="ttdeci">unsigned char bTXFIN</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00137">TCP.h:137</a></div></div>
<div class="ttc" id="struct_t_c_b_html_adc44e41369b7d7bebc66a88b5a289e72"><div class="ttname"><a href="struct_t_c_b.html#adc44e41369b7d7bebc66a88b5a289e72">TCB::flags</a></div><div class="ttdeci">struct TCB::@296 flags</div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a62d0ebf32025a28195c2d8e87e68f3af"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a62d0ebf32025a28195c2d8e87e68f3af">TCP_CLOSING</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00085">TCP.h:85</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_adfd9b628a5f15aec8aacd007d4fddae0"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#adfd9b628a5f15aec8aacd007d4fddae0">TCB_STUB::rxTail</a></div><div class="ttdeci">PTR_BASE rxTail</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00117">TCP.h:117</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_a549f153af94a2b817eab3299340f356a"><div class="ttname"><a href="_t_c_p_i_p_8h.html#a549f153af94a2b817eab3299340f356a">TCP_ETH_RAM</a></div><div class="ttdeci">#define TCP_ETH_RAM</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00072">TCPIP.h:72</a></div></div>
<div class="ttc" id="_helpers_8h_html_a9274752ec58a3cc6b2a9518a6e417fc3"><div class="ttname"><a href="_helpers_8h.html#a9274752ec58a3cc6b2a9518a6e417fc3">CalcIPChecksum</a></div><div class="ttdeci">WORD CalcIPChecksum(BYTE *buffer, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_helpers_8c_source.html#l01162">Helpers.c:1162</a></div></div>
<div class="ttc" id="struct_t_c_p___o_p_t_i_o_n_s_html_a7c46116cbd9a8db99e5d33283345e524"><div class="ttname"><a href="struct_t_c_p___o_p_t_i_o_n_s.html#a7c46116cbd9a8db99e5d33283345e524">TCP_OPTIONS::Kind</a></div><div class="ttdeci">BYTE Kind</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00182">TCP.c:182</a></div></div>
<div class="ttc" id="_a_r_p_8h_html_ab6db95d6f77786a0e13c0bda086c958a"><div class="ttname"><a href="_a_r_p_8h.html#ab6db95d6f77786a0e13c0bda086c958a">ARPIsResolved</a></div><div class="ttdeci">BOOL ARPIsResolved(IP_ADDR *IPAddr, MAC_ADDR *MACAddr)</div><div class="ttdef"><b>Definition:</b> <a href="_a_r_p_8c_source.html#l00677">ARP.c:677</a></div></div>
<div class="ttc" id="_stack_tsk_8h_html_a67540808395519081be1333c4e9aa1f8"><div class="ttname"><a href="_stack_tsk_8h.html#a67540808395519081be1333c4e9aa1f8">AppConfig</a></div><div class="ttdeci">APP_CONFIG AppConfig</div><div class="ttdef"><b>Definition:</b> <a href="_custom_h_t_t_p_app_8c_source.html#l01932">CustomHTTPApp.c:1932</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_afd4cf67bce7972d9e528bc05bcabc226"><div class="ttname"><a href="_t_c_p_8c.html#afd4cf67bce7972d9e528bc05bcabc226">TCPIsConnected</a></div><div class="ttdeci">BOOL TCPIsConnected(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00774">TCP.c:774</a></div></div>
<div class="ttc" id="struct___p_s_e_u_d_o___h_e_a_d_e_r_html"><div class="ttname"><a href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html">_PSEUDO_HEADER</a></div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8h_source.html#l00080">IP.h:80</a></div></div>
<div class="ttc" id="_s_p_i_r_a_m_8h_html_a901a1adc847c32a66f762a7a23c556cc"><div class="ttname"><a href="_s_p_i_r_a_m_8h.html#a901a1adc847c32a66f762a7a23c556cc">SPIRAMPutArray</a></div><div class="ttdeci">#define SPIRAMPutArray(a, b, c)</div><div class="ttdef"><b>Definition:</b> <a href="_s_p_i_r_a_m_8h_source.html#l00089">SPIRAM.h:89</a></div></div>
<div class="ttc" id="struct_t_c_p___o_p_t_i_o_n_s_html"><div class="ttname"><a href="struct_t_c_p___o_p_t_i_o_n_s.html">TCP_OPTIONS</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00180">TCP.c:180</a></div></div>
<div class="ttc" id="struct___p_s_e_u_d_o___h_e_a_d_e_r_html_a4e3381dd4fcd372f6f4fb0b2577e541a"><div class="ttname"><a href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a4e3381dd4fcd372f6f4fb0b2577e541a">_PSEUDO_HEADER::Protocol</a></div><div class="ttdeci">BYTE Protocol</div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8h_source.html#l00085">IP.h:85</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_aa9a3ea943e98acbcefcca1e021f6fef2"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#aa9a3ea943e98acbcefcca1e021f6fef2">TCB_STUB::sslReqMessage</a></div><div class="ttdeci">BYTE sslReqMessage</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00149">TCP.h:149</a></div></div>
<div class="ttc" id="union_d_w_o_r_d___v_a_l_html"><div class="ttname"><a href="union_d_w_o_r_d___v_a_l.html">DWORD_VAL</a></div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00400">GenericTypeDefs.h:400</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_af4e15f4e54c10b261e4587c0651d635f"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#af4e15f4e54c10b261e4587c0651d635f">TCP_HEADER::SourcePort</a></div><div class="ttdeci">WORD SourcePort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00146">TCP.c:146</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html">TCP_HEADER</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00144">TCP.c:144</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a680a81a7e7676aef8d747d1e06610633"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a680a81a7e7676aef8d747d1e06610633">TCP_CLOSED</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00089">TCP.h:89</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a4f359317ed99210951551eaaa243d2b1"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a4f359317ed99210951551eaaa243d2b1">TCB_STUB::eventTime2</a></div><div class="ttdeci">WORD eventTime2</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00119">TCP.h:119</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a0e0f72fc96e26fce4543fa99b7235ab4">TCP_ESTABLISHED</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00082">TCP.h:82</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_aee8c85c7e0542f41d000d4f6f59f4641"><div class="ttname"><a href="_t_c_p_8c.html#aee8c85c7e0542f41d000d4f6f59f4641">TCPFindROMArrayEx</a></div><div class="ttdeci">WORD TCPFindROMArrayEx(TCP_SOCKET hTCP, ROM BYTE *cFindArray, WORD wLen, WORD wStart, WORD wSearchLen, BOOL bTextCompare)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l02146">TCP.c:2146</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a856e07e4c4285f8a0f28518aed9fc2bd"><div class="ttname"><a href="struct_t_c_b.html#a856e07e4c4285f8a0f28518aed9fc2bd">TCB::remoteWindow</a></div><div class="ttdeci">WORD remoteWindow</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00167">TCP.h:167</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a89d13e85195c0d00f308194305845016"><div class="ttname"><a href="_m_a_c_8h.html#a89d13e85195c0d00f308194305845016">MACGetArray</a></div><div class="ttdeci">WORD MACGetArray(BYTE *val, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l01200">ENC28J60.c:1200</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a122f749211c26b45afbac25b4a278b56"><div class="ttname"><a href="struct_t_c_b.html#a122f749211c26b45afbac25b4a278b56">TCB::retryCount</a></div><div class="ttdeci">BYTE retryCount</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00188">TCP.h:188</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a56e0df836febac47f2f7f905f0641260"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a56e0df836febac47f2f7f905f0641260">TCB_STUB::bufferEnd</a></div><div class="ttdeci">PTR_BASE bufferEnd</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00113">TCP.h:113</a></div></div>
<div class="ttc" id="_d_n_s_8h_html_a7568a1a127a88a9b1aa4d34abbd19b53"><div class="ttname"><a href="_d_n_s_8h.html#a7568a1a127a88a9b1aa4d34abbd19b53">DNSIsResolved</a></div><div class="ttdeci">BOOL DNSIsResolved(IP_ADDR *HostIP)</div><div class="ttdef"><b>Definition:</b> <a href="_d_n_s_8c_source.html#l00347">DNS.c:347</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_af14a0a88eef0ca101814acf1157f42a3"><div class="ttname"><a href="_m_a_c_8h.html#af14a0a88eef0ca101814acf1157f42a3">CalcIPBufferChecksum</a></div><div class="ttdeci">WORD CalcIPBufferChecksum(WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l00946">ENC28J60.c:946</a></div></div>
<div class="ttc" id="_d_n_s_8h_html_a6d90f550f52f1e548b4db225a844e7e3"><div class="ttname"><a href="_d_n_s_8h.html#a6d90f550f52f1e548b4db225a844e7e3">DNSBeginUsage</a></div><div class="ttdeci">BOOL DNSBeginUsage(void)</div><div class="ttdef"><b>Definition:</b> <a href="_d_n_s_8c_source.html#l00169">DNS.c:169</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a33b561c9a2dc4a01aaba1a3cb7004bcc"><div class="ttname"><a href="_t_c_p_8c.html#a33b561c9a2dc4a01aaba1a3cb7004bcc">TCPGetTxFIFOFull</a></div><div class="ttdeci">WORD TCPGetTxFIFOFull(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01532">TCP.c:1532</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a38dc2cc8c71b2f6bfe51ea8db2acc67c"><div class="ttname"><a href="_m_a_c_8h.html#a38dc2cc8c71b2f6bfe51ea8db2acc67c">MACFlush</a></div><div class="ttdeci">void MACFlush(void)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l00692">ENC28J60.c:692</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a24b67ec68e80243ca4fdcfaaf0a91072"><div class="ttname"><a href="_m_a_c_8h.html#a24b67ec68e80243ca4fdcfaaf0a91072">MACGet</a></div><div class="ttdeci">BYTE MACGet(void)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l01132">ENC28J60.c:1132</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_af1873020d1122b2f2c79e8c2f590fe19"><div class="ttname"><a href="_t_c_p_8c.html#af1873020d1122b2f2c79e8c2f590fe19">TCPPutArray</a></div><div class="ttdeci">WORD TCPPutArray(TCP_SOCKET hTCP, BYTE *data, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01232">TCP.c:1232</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a876c8b9a4c092dc0006b7822efbeca27"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a876c8b9a4c092dc0006b7822efbeca27">TCB_STUB::bTimerEnabled</a></div><div class="ttdeci">unsigned char bTimerEnabled</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00130">TCP.h:130</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a63180a6b39bd41e931e34cbd85e965f0"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a63180a6b39bd41e931e34cbd85e965f0">TCB_STUB::bSSLHandshaking</a></div><div class="ttdeci">unsigned char bSSLHandshaking</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00139">TCP.h:139</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a75dd4a8683dde17aa7f3de43bbdc4e13"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a75dd4a8683dde17aa7f3de43bbdc4e13">TCB_STUB::rxHead</a></div><div class="ttdeci">PTR_BASE rxHead</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00116">TCP.h:116</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_a4f92c3804a4603ec0778b98834764851"><div class="ttname"><a href="_t_c_p_i_p_8h.html#a4f92c3804a4603ec0778b98834764851">TCP_ETH_RAM_SIZE</a></div><div class="ttdeci">#define TCP_ETH_RAM_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00207">TCPIP.h:207</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_ae047f0c0ce6b7f6cdc5fe8098bfef8ee"><div class="ttname"><a href="_s_s_l_8h.html#ae047f0c0ce6b7f6cdc5fe8098bfef8ee">SSLTxMessage</a></div><div class="ttdeci">void SSLTxMessage(TCP_SOCKET hTCP, BYTE sslStubID, BYTE msg)</div></div>
<div class="ttc" id="struct___p_s_e_u_d_o___h_e_a_d_e_r_html_a716d105478dd9de36ec29bc981795f47"><div class="ttname"><a href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a716d105478dd9de36ec29bc981795f47">_PSEUDO_HEADER::Length</a></div><div class="ttdeci">WORD Length</div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8h_source.html#l00086">IP.h:86</a></div></div>
<div class="ttc" id="struct___i_p___h_e_a_d_e_r_html"><div class="ttname"><a href="struct___i_p___h_e_a_d_e_r.html">_IP_HEADER</a></div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8h_source.html#l00064">IP.h:64</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a85e50d5129c9eaec6e4729cb5aacf312"><div class="ttname"><a href="struct_t_c_b.html#a85e50d5129c9eaec6e4729cb5aacf312">TCB::bRemoteHostIsROM</a></div><div class="ttdeci">unsigned char bRemoteHostIsROM</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00179">TCP.h:179</a></div></div>
<div class="ttc" id="struct_t_c_p___s_y_n___q_u_e_u_e_html_ab040df9bb3ca4da90ebc0b1b59a6a618"><div class="ttname"><a href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ab040df9bb3ca4da90ebc0b1b59a6a618">TCP_SYN_QUEUE::dwSourceSEQ</a></div><div class="ttdeci">DWORD dwSourceSEQ</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00195">TCP.c:195</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a3a4e74a03e65f7f665046aaac3127228"><div class="ttname"><a href="struct_t_c_b.html#a3a4e74a03e65f7f665046aaac3127228">TCB::wRemoteMSS</a></div><div class="ttdeci">WORD wRemoteMSS</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00184">TCP.h:184</a></div></div>
<div class="ttc" id="struct___p_s_e_u_d_o___h_e_a_d_e_r_html_aa6d4c439169ac792940a0ba329d64e25"><div class="ttname"><a href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#aa6d4c439169ac792940a0ba329d64e25">_PSEUDO_HEADER::Zero</a></div><div class="ttdeci">BYTE Zero</div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8h_source.html#l00084">IP.h:84</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_aa2eabcef6e3f7cb140ddc43f3b0f01f2"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#aa2eabcef6e3f7cb140ddc43f3b0f01f2">TCB_STUB::vUnackedKeepalives</a></div><div class="ttdeci">unsigned char vUnackedKeepalives</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00128">TCP.h:128</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a076e82abb9377d3cb38f3210dcce5414"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a076e82abb9377d3cb38f3210dcce5414">TCB_STUB::sslStubID</a></div><div class="ttdeci">BYTE sslStubID</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00148">TCP.h:148</a></div></div>
<div class="ttc" id="struct_t_c_b_html_afadd907b992146d3bcfb2f95cc670731"><div class="ttname"><a href="struct_t_c_b.html#afadd907b992146d3bcfb2f95cc670731">TCB::remote</a></div><div class="ttdeci">union TCB::@295 remote</div></div>
<div class="ttc" id="struct_t_c_b_html_ae7e84a3fa64de6e94ad093b762400e10"><div class="ttname"><a href="struct_t_c_b.html#ae7e84a3fa64de6e94ad093b762400e10">TCB::bFINSent</a></div><div class="ttdeci">unsigned char bFINSent</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00177">TCP.h:177</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a4b71a76cf1da559ef10b5f3f4cc87794"><div class="ttname"><a href="_t_c_p_8c.html#a4b71a76cf1da559ef10b5f3f4cc87794">TCPGetRemoteInfo</a></div><div class="ttdeci">SOCKET_INFO * TCPGetRemoteInfo(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00996">TCP.c:996</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a6ca0e6c4fdbfc3d7027ca6b56aaf671c">TCP_FIN_WAIT_2</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00084">TCP.h:84</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a72d4a1a3347c7316acbae4d96ba44f63"><div class="ttname"><a href="_m_a_c_8h.html#a72d4a1a3347c7316acbae4d96ba44f63">MACIsMemCopyDone</a></div><div class="ttdeci">BOOL MACIsMemCopyDone(void)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l01108">ENC28J60.c:1108</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_aa50ec388b8146677414b657d5876103b"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#aa50ec388b8146677414b657d5876103b">TCP_HEADER::Window</a></div><div class="ttdeci">WORD Window</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00172">TCP.c:172</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a0b66f1eb742dfdf0080a00214dce87e6"><div class="ttname"><a href="_m_a_c_8h.html#a0b66f1eb742dfdf0080a00214dce87e6">ETHER_HEADER</a></div><div class="ttdeci">ETHER_HEADER</div><div class="ttdef"><b>Definition:</b> <a href="_m_a_c_8h_source.html#l00103">MAC.h:103</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a07ef2578bb03e45aa95d22538713652c"><div class="ttname"><a href="_t_c_p_8c.html#a07ef2578bb03e45aa95d22538713652c">TCPRequestSSLMessage</a></div><div class="ttdeci">BOOL TCPRequestSSLMessage(TCP_SOCKET hTCP, BYTE msg)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l04995">TCP.c:4995</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html">TCB_STUB</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00109">TCP.h:109</a></div></div>
<div class="ttc" id="struct_t_c_b_html"><div class="ttname"><a href="struct_t_c_b.html">TCB</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00159">TCP.h:159</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a5d60ed0da9975f201bdb5832564f24a2"><div class="ttname"><a href="struct_t_c_b.html#a5d60ed0da9975f201bdb5832564f24a2">TCB::bSYNSent</a></div><div class="ttdeci">unsigned char bSYNSent</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00178">TCP.h:178</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a5ffcb7882b02ce0e97dedd9261ca74e0"><div class="ttname"><a href="_s_s_l_8h.html#a5ffcb7882b02ce0e97dedd9261ca74e0">SSLPeriodic</a></div><div class="ttdeci">void SSLPeriodic(TCP_SOCKET hTCP, BYTE sslStubID)</div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a2ec4952d1b77ec5800649853e0d95c65"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a2ec4952d1b77ec5800649853e0d95c65">TCB_STUB::eventTime</a></div><div class="ttdeci">DWORD eventTime</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00118">TCP.h:118</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a9fbb66288f62395d4b85180958dc3f85"><div class="ttname"><a href="_t_c_p_8c.html#a9fbb66288f62395d4b85180958dc3f85">TCPIsGetReady</a></div><div class="ttdeci">WORD TCPIsGetReady(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01613">TCP.c:1613</a></div></div>
<div class="ttc" id="_tick_8h_html_a035d1d3f8afdca7abedf588ee1b20af0"><div class="ttname"><a href="_tick_8h.html#a035d1d3f8afdca7abedf588ee1b20af0">TickGet</a></div><div class="ttdeci">DWORD TickGet(void)</div><div class="ttdef"><b>Definition:</b> <a href="_tick_8c_source.html#l00270">Tick.c:270</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_ae351c895eff77bbc9b231ee39dfdebe3"><div class="ttname"><a href="_t_c_p_8c.html#ae351c895eff77bbc9b231ee39dfdebe3">TCPPutString</a></div><div class="ttdeci">BYTE * TCPPutString(TCP_SOCKET hTCP, BYTE *data)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01475">TCP.c:1475</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_ace70c5eb1360822faadaab5d0431ec13"><div class="ttname"><a href="_t_c_p_8c.html#ace70c5eb1360822faadaab5d0431ec13">TCPPeek</a></div><div class="ttdeci">BYTE TCPPeek(TCP_SOCKET hTCP, WORD wStart)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01911">TCP.c:1911</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a33cee3ee04bc96dc8f94c6919cbffcf9"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a33cee3ee04bc96dc8f94c6919cbffcf9">TCB_STUB::sslRxHead</a></div><div class="ttdeci">PTR_BASE sslRxHead</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00147">TCP.h:147</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html"><div class="ttname"><a href="_t_c_p_i_p_8h.html">TCPIP.h</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a83f916c6c4f2c0db03647c37da11e838"><div class="ttname"><a href="_t_c_p_8c.html#a83f916c6c4f2c0db03647c37da11e838">TCPSSLPutRecordHeader</a></div><div class="ttdeci">void TCPSSLPutRecordHeader(TCP_SOCKET hTCP, BYTE *hdr, BOOL recDone)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05354">TCP.c:5354</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_aba628f222575a1aeed0f684edb39351b"><div class="ttname"><a href="_t_c_p_i_p_8h.html#aba628f222575a1aeed0f684edb39351b">TCP_SPI_RAM</a></div><div class="ttdeci">#define TCP_SPI_RAM</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00080">TCPIP.h:80</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_ae9bb25d3afecf3bfab0fbe3c22c2050f"><div class="ttname"><a href="_generic_type_defs_8h.html#ae9bb25d3afecf3bfab0fbe3c22c2050f">SHORT</a></div><div class="ttdeci">signed short int SHORT</div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00349">GenericTypeDefs.h:349</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a6e3cd6655fc5dd8120ba7b51085c5ae0"><div class="ttname"><a href="_s_s_l_8h.html#a6e3cd6655fc5dd8120ba7b51085c5ae0">SSLStartSession</a></div><div class="ttdeci">BYTE SSLStartSession(TCP_SOCKET hTCP, void *buffer, BYTE supDataType)</div></div>
<div class="ttc" id="_s_s_l_8h_html_a58f586f8d87cd2ae8268523c591c93dc"><div class="ttname"><a href="_s_s_l_8h.html#a58f586f8d87cd2ae8268523c591c93dc">SSLMACCalc</a></div><div class="ttdeci">void SSLMACCalc(BYTE *MACSecret, BYTE *result)</div></div>
<div class="ttc" id="_m_a_c_8h_html_a853f9bc96814d6d6ff8ef7a19f84d973"><div class="ttname"><a href="_m_a_c_8h.html#a853f9bc96814d6d6ff8ef7a19f84d973">MACGetFreeRxSize</a></div><div class="ttdeci">WORD MACGetFreeRxSize(void)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l00491">ENC28J60.c:491</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a503025d07797068adaf6e8032f6bda5e"><div class="ttname"><a href="_t_c_p_8c.html#a503025d07797068adaf6e8032f6bda5e">TCPClose</a></div><div class="ttdeci">void TCPClose(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00960">TCP.c:960</a></div></div>
<div class="ttc" id="_h_w_p___d_a210___b_r_d__16_p_m_p___a_r1020___v_g_av1_8h_html_a60e68f55ca3981fd4a8bfc3f0b6b444e"><div class="ttname"><a href="_h_w_p___d_a210___b_r_d__16_p_m_p___a_r1020___v_g_av1_8h.html#a60e68f55ca3981fd4a8bfc3f0b6b444e">bits</a></div><div class="ttdeci">void unsigned int bits</div><div class="ttdef"><b>Definition:</b> <a href="_h_w_p___d_a210___b_r_d__16_p_m_p___a_r1020___v_g_av1_8h_source.html#l02835">HWP_DA210_BRD_16PMP_AR1020_VGAv1.h:2835</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_adf2d6ada2d4e8c8c3420abe7a6c4eab0"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#adf2d6ada2d4e8c8c3420abe7a6c4eab0">TCB_STUB::sslTxHead</a></div><div class="ttdeci">PTR_BASE sslTxHead</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00145">TCP.h:145</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a97e8fa1695ed948d0a715a3b96bb6d8d"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a97e8fa1695ed948d0a715a3b96bb6d8d">TCB_STUB::bDelayedACKTimerEnabled</a></div><div class="ttdeci">unsigned char bDelayedACKTimerEnabled</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00132">TCP.h:132</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a17e1de1a82c0beee37397a59a7d8c812"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a17e1de1a82c0beee37397a59a7d8c812">TCP_HEADER::UrgentPointer</a></div><div class="ttdeci">WORD UrgentPointer</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00174">TCP.c:174</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a5822b7000f077dc1e2f88a31a6b89a39"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a5822b7000f077dc1e2f88a31a6b89a39">TCP_HEADER::Val</a></div><div class="ttdeci">unsigned char Val</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00154">TCP.c:154</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a2c590b42dac0ddfc5ec2e193261815c5"><div class="ttname"><a href="struct_t_c_b.html#a2c590b42dac0ddfc5ec2e193261815c5">TCB::vSocketPurpose</a></div><div class="ttdeci">BYTE vSocketPurpose</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00189">TCP.h:189</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a3fd3fae0d56fc45fc789bc2e255ad78a"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a3fd3fae0d56fc45fc789bc2e255ad78a">TCB_STUB::vMemoryMedium</a></div><div class="ttdeci">BYTE vMemoryMedium</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00152">TCP.h:152</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_ab75bc52ffa39337edf7b3880d1febbfc"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#ab75bc52ffa39337edf7b3880d1febbfc">TCB_STUB::txHead</a></div><div class="ttdeci">PTR_BASE txHead</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00114">TCP.h:114</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_ac84010ab6fad0a3b379eb2c9c668f9b7"><div class="ttname"><a href="_t_c_p_8c.html#ac84010ab6fad0a3b379eb2c9c668f9b7">TCPFindEx</a></div><div class="ttdeci">WORD TCPFindEx(TCP_SOCKET hTCP, BYTE cFind, WORD wStart, WORD wSearchLen, BOOL bTextCompare)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l02320">TCP.c:2320</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a576f183bc25360e18be55ca92f4b18bb"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a576f183bc25360e18be55ca92f4b18bb">TCP_GET_DNS_MODULE</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00074">TCP.h:74</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a4ec262e8432e722273b67cea923f72a6"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a4ec262e8432e722273b67cea923f72a6">TCP_HEADER::byte</a></div><div class="ttdeci">BYTE byte</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00169">TCP.c:169</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_ac42d764ddec4dd25aab3d65a9a415753"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#ac42d764ddec4dd25aab3d65a9a415753">TCB_STUB::delayedACKTime</a></div><div class="ttdeci">WORD delayedACKTime</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00122">TCP.h:122</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a4442711ab4c3d47ffc913476630330e2"><div class="ttname"><a href="_m_a_c_8h.html#a4442711ab4c3d47ffc913476630330e2">MACMemCopyAsync</a></div><div class="ttdeci">void MACMemCopyAsync(PTR_BASE destAddr, PTR_BASE sourceAddr, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l01027">ENC28J60.c:1027</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a99e571c03a1088175fdde4286cb4056a"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a99e571c03a1088175fdde4286cb4056a">TCB_STUB::txTail</a></div><div class="ttdeci">PTR_BASE txTail</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00115">TCP.h:115</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a1d5749e83dc48175394d862a245f9b9b">TCP_LISTEN</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00079">TCP.h:79</a></div></div>
<div class="ttc" id="_stack_tsk_8h_html_ac28a7d4076195ab8e3376f06055f8ee4"><div class="ttname"><a href="_stack_tsk_8h.html#ac28a7d4076195ab8e3376f06055f8ee4">NODE_INFO</a></div><div class="ttdeci">NODE_INFO</div><div class="ttdef"><b>Definition:</b> <a href="_stack_tsk_8h_source.html#l00089">StackTsk.h:89</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_ad99c356df1c988fee2f09394bc482e98"><div class="ttname"><a href="_t_c_p_i_p_8h.html#ad99c356df1c988fee2f09394bc482e98">TCP_PIC_RAM</a></div><div class="ttdeci">#define TCP_PIC_RAM</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00076">TCPIP.h:76</a></div></div>
<div class="ttc" id="_helpers_8h_html_a8f07ee728c4a31e32ebf3ed585086b6a"><div class="ttname"><a href="_helpers_8h.html#a8f07ee728c4a31e32ebf3ed585086b6a">swapl</a></div><div class="ttdeci">DWORD swapl(DWORD v)</div><div class="ttdef"><b>Definition:</b> <a href="_helpers_8c_source.html#l01119">Helpers.c:1119</a></div></div>
<div class="ttc" id="struct_s_o_c_k_e_t___i_n_f_o_html_aa1e86fd8c2b12224dd8ccaeb34555171"><div class="ttname"><a href="struct_s_o_c_k_e_t___i_n_f_o.html#aa1e86fd8c2b12224dd8ccaeb34555171">SOCKET_INFO::remote</a></div><div class="ttdeci">NODE_INFO remote</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00195">TCP.h:195</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a6a2c177c65bf1d1a9df118ba3c927088"><div class="ttname"><a href="_t_c_p_8c.html#a6a2c177c65bf1d1a9df118ba3c927088">TCPGet</a></div><div class="ttdeci">BOOL TCPGet(TCP_SOCKET hTCP, BYTE *byte)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01647">TCP.c:1647</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a1bf5ec3f0c3c0241d01cc1b5e7f094cd"><div class="ttname"><a href="struct_t_c_b.html#a1bf5ec3f0c3c0241d01cc1b5e7f094cd">TCB::niRemoteMACIP</a></div><div class="ttdeci">NODE_INFO niRemoteMACIP</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00171">TCP.h:171</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_acbdf56a7b422c7c574cd0d399ae9434a"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#acbdf56a7b422c7c574cd0d399ae9434a">TCP_HEADER::DestPort</a></div><div class="ttdeci">WORD DestPort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00147">TCP.c:147</a></div></div>
<div class="ttc" id="struct_s_o_c_k_e_t___i_n_f_o_html_aa316e3d5bcdbc999280ce3bb80ef116e"><div class="ttname"><a href="struct_s_o_c_k_e_t___i_n_f_o.html#aa316e3d5bcdbc999280ce3bb80ef116e">SOCKET_INFO::remotePort</a></div><div class="ttdeci">WORD_VAL remotePort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00196">TCP.h:196</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839"><div class="ttname"><a href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa82764c3079aea4e60c80e45befbb839">TRUE</a></div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00065">GenericTypeDefs.h:65</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a18cd650b4f424753ccb3c7a5d3e317c6"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a18cd650b4f424753ccb3c7a5d3e317c6">TCP_GATEWAY_SEND_ARP</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00076">TCP.h:76</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_a54d65c7fa62e62c9754371e42f5111b9"><div class="ttname"><a href="_generic_type_defs_8h.html#a54d65c7fa62e62c9754371e42f5111b9">BOOL</a></div><div class="ttdeci">enum _BOOL BOOL</div></div>
<div class="ttc" id="_t_c_p_8h_html_abe3757e564cff2f301e49564cbb5f878"><div class="ttname"><a href="_t_c_p_8h.html#abe3757e564cff2f301e49564cbb5f878">TCP_SOCKET</a></div><div class="ttdeci">BYTE TCP_SOCKET</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00061">TCP.h:61</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_aad63644420d87642a890d2f41abb7454"><div class="ttname"><a href="_m_a_c_8h.html#aad63644420d87642a890d2f41abb7454">MACSetReadPtr</a></div><div class="ttdeci">PTR_BASE MACSetReadPtr(PTR_BASE address)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l00860">ENC28J60.c:860</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a57bf620571057a239c31978ce012adfa"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a57bf620571057a239c31978ce012adfa">TCP_HEADER::DataOffset</a></div><div class="ttdeci">struct TCP_HEADER::@487 DataOffset</div></div>
<div class="ttc" id="_m_a_c_8h_html_a99937ac52db1a95f86ca59779640bcbe"><div class="ttname"><a href="_m_a_c_8h.html#a99937ac52db1a95f86ca59779640bcbe">MACIsTxReady</a></div><div class="ttdeci">BOOL MACIsTxReady(void)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l00420">ENC28J60.c:420</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a33d9392f2c2945d2abd90efcf0327a9a"><div class="ttname"><a href="_t_c_p_8c.html#a33d9392f2c2945d2abd90efcf0327a9a">WFGetTCBSize</a></div><div class="ttdeci">UINT16 WFGetTCBSize(void)</div><div class="ttdef"><b>Definition:</b> <a href="_w_f_mac_8c_source.html#l00581">WFMac.c:581</a></div></div>
<div class="ttc" id="_d_n_s_8c_html_a5ab8c2bf45b20b5f7aa3a4f083896cec"><div class="ttname"><a href="_d_n_s_8c.html#a5ab8c2bf45b20b5f7aa3a4f083896cec">Val</a></div><div class="ttdeci">BYTE Val</div><div class="ttdef"><b>Definition:</b> <a href="_d_n_s_8c_source.html#l00080">DNS.c:80</a></div></div>
<div class="ttc" id="struct_t_c_b_html_acd4766b3fc8c443d8aceb1920fc58677"><div class="ttname"><a href="struct_t_c_b.html#acd4766b3fc8c443d8aceb1920fc58677">TCB::bRXNoneACKed1</a></div><div class="ttdeci">unsigned char bRXNoneACKed1</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00180">TCP.h:180</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_abc0d9a5c1aa719e758931a78344b3e99"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#abc0d9a5c1aa719e758931a78344b3e99">TCB_STUB::bufferTxStart</a></div><div class="ttdeci">PTR_BASE bufferTxStart</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00111">TCP.h:111</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a8214942e78ddf27c40b767e5edc25d97"><div class="ttname"><a href="_t_c_p_8c.html#a8214942e78ddf27c40b767e5edc25d97">TCPAddSSLListener</a></div><div class="ttdeci">BOOL TCPAddSSLListener(TCP_SOCKET hTCP, WORD port)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l04951">TCP.c:4951</a></div></div>
<div class="ttc" id="struct_t_c_p___s_y_n___q_u_e_u_e_html_a0aa09af9f70a0f4959f9d8949c04df35"><div class="ttname"><a href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a0aa09af9f70a0f4959f9d8949c04df35">TCP_SYN_QUEUE::wTimestamp</a></div><div class="ttdeci">WORD wTimestamp</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00197">TCP.c:197</a></div></div>
<div class="ttc" id="struct_t_c_p___o_p_t_i_o_n_s_html_a4414eab3a6c9ce2fa592d8917a143515"><div class="ttname"><a href="struct_t_c_p___o_p_t_i_o_n_s.html#a4414eab3a6c9ce2fa592d8917a143515">TCP_OPTIONS::MaxSegSize</a></div><div class="ttdeci">WORD_VAL MaxSegSize</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00184">TCP.c:184</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a3ed294cd22f01bf2937a879fe3e73bfc"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a3ed294cd22f01bf2937a879fe3e73bfc">TCP_HEADER::bits</a></div><div class="ttdeci">struct TCP_HEADER::@488::@489 bits</div></div>
<div class="ttc" id="_generic_type_defs_8h_html_afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a"><div class="ttname"><a href="_generic_type_defs_8h.html#afbf708854fe02af8475a9ba02f3196cbaa1e095cc966dbecf6a0d8aad75348d1a">FALSE</a></div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00065">GenericTypeDefs.h:65</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a48cb8cf682effdf9221fef77ae582298"><div class="ttname"><a href="struct_t_c_b.html#a48cb8cf682effdf9221fef77ae582298">TCB::wFutureDataSize</a></div><div class="ttdeci">WORD wFutureDataSize</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00168">TCP.h:168</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a34c940d4eee891fd1a8ac0c77091d1cb"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a34c940d4eee891fd1a8ac0c77091d1cb">TCP_HEADER::Reserved3</a></div><div class="ttdeci">unsigned char Reserved3</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00153">TCP.c:153</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5bbf321fdef3abedd34fc24ddb21a91c">TCP_CLOSE_WAIT</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00087">TCP.h:87</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a423af91678aeffc96d8fb908c4bf834d"><div class="ttname"><a href="_t_c_p_8c.html#a423af91678aeffc96d8fb908c4bf834d">TCPSSLInPlaceMACEncrypt</a></div><div class="ttdeci">void TCPSSLInPlaceMACEncrypt(TCP_SOCKET hTCP, ARCFOUR_CTX *ctx, BYTE *MACSecret, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05245">TCP.c:5245</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_acfa284fa8026c4aace2728f7f15d6c13"><div class="ttname"><a href="_generic_type_defs_8h.html#acfa284fa8026c4aace2728f7f15d6c13">UINT16</a></div><div class="ttdeci">unsigned short int UINT16</div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00086">GenericTypeDefs.h:86</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_aac87e60b8ab50d868f9d26157167faf9"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#aac87e60b8ab50d868f9d26157167faf9">TCB_STUB::Flags</a></div><div class="ttdeci">struct TCB_STUB::@294 Flags</div></div>
<div class="ttc" id="struct_t_c_p___s_y_n___q_u_e_u_e_html"><div class="ttname"><a href="struct_t_c_p___s_y_n___q_u_e_u_e.html">TCP_SYN_QUEUE</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00191">TCP.c:191</a></div></div>
<div class="ttc" id="_helpers_8h_html_ab9a87e9fa459e39748e35e7b700077ed"><div class="ttname"><a href="_helpers_8h.html#ab9a87e9fa459e39748e35e7b700077ed">GenerateRandomDWORD</a></div><div class="ttdeci">DWORD GenerateRandomDWORD(void)</div><div class="ttdef"><b>Definition:</b> <a href="_helpers_8c_source.html#l00212">Helpers.c:212</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a35804e9713650251b6e4cb75909e2480"><div class="ttname"><a href="_t_c_p_8c.html#a35804e9713650251b6e4cb75909e2480">TCPGetArray</a></div><div class="ttdeci">WORD TCPGetArray(TCP_SOCKET hTCP, BYTE *buffer, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01701">TCP.c:1701</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_ad03097c0020aa6abe8446835dde60c9a"><div class="ttname"><a href="_t_c_p_8c.html#ad03097c0020aa6abe8446835dde60c9a">TCPSSLHandleIncoming</a></div><div class="ttdeci">void TCPSSLHandleIncoming(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05466">TCP.c:5466</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a64467e967affbc7f3bd04af24a62255f"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a64467e967affbc7f3bd04af24a62255f">TCB_STUB::bOneSegmentReceived</a></div><div class="ttdeci">unsigned char bOneSegmentReceived</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00133">TCP.h:133</a></div></div>
<div class="ttc" id="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h_html_a3fd3fae0d56fc45fc789bc2e255ad78a"><div class="ttname"><a href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a3fd3fae0d56fc45fc789bc2e255ad78a">vMemoryMedium</a></div><div class="ttdeci">BYTE vMemoryMedium</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h_source.html#l00278">TCPIP ENC624 dsPIC33E_SK.h:278</a></div></div>
<div class="ttc" id="_d_n_s_8h_html_a86421bea342691fd5a4451ba0e114ac1"><div class="ttname"><a href="_d_n_s_8h.html#a86421bea342691fd5a4451ba0e114ac1">DNSResolve</a></div><div class="ttdeci">void DNSResolve(BYTE *HostName, BYTE Type)</div><div class="ttdef"><b>Definition:</b> <a href="_d_n_s_8c_source.html#l00251">DNS.c:251</a></div></div>
<div class="ttc" id="struct_s_o_c_k_e_t___i_n_f_o_html"><div class="ttname"><a href="struct_s_o_c_k_e_t___i_n_f_o.html">SOCKET_INFO</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00193">TCP.h:193</a></div></div>
<div class="ttc" id="_a_r_p_8h_html_aa58da534afc0a0b8d9c87d7ec6a7c599"><div class="ttname"><a href="_a_r_p_8h.html#aa58da534afc0a0b8d9c87d7ec6a7c599">ARPResolve</a></div><div class="ttdeci">void ARPResolve(IP_ADDR *IPAddr)</div><div class="ttdef"><b>Definition:</b> <a href="_a_r_p_8c_source.html#l00592">ARP.c:592</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a420378f37017a1ddaee8c9f5a52b2077"><div class="ttname"><a href="_s_s_l_8h.html#a420378f37017a1ddaee8c9f5a52b2077">SSLTerminate</a></div><div class="ttdeci">void SSLTerminate(BYTE sslStubId)</div></div>
<div class="ttc" id="_t_c_p_8c_html_ac63bee3cb4236129fee37b05b66ab02a"><div class="ttname"><a href="_t_c_p_8c.html#ac63bee3cb4236129fee37b05b66ab02a">TCPStartSSLClientEx</a></div><div class="ttdeci">BOOL TCPStartSSLClientEx(TCP_SOCKET hTCP, BYTE *host, void *buffer, BYTE suppDataType)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l04828">TCP.c:4828</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a8d61cf0dd6dacc41f87a1ed05766365c"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a8d61cf0dd6dacc41f87a1ed05766365c">TCP_SYN_SENT</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00080">TCP.h:80</a></div></div>
<div class="ttc" id="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h_html_a2c590b42dac0ddfc5ec2e193261815c5"><div class="ttname"><a href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a2c590b42dac0ddfc5ec2e193261815c5">vSocketPurpose</a></div><div class="ttdeci">BYTE vSocketPurpose</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h_source.html#l00277">TCPIP ENC624 dsPIC33E_SK.h:277</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_aa6f006c76da3ced9d0d46f2d2537198a"><div class="ttname"><a href="_t_c_p_8c.html#aa6f006c76da3ced9d0d46f2d2537198a">TCPStartSSLClient</a></div><div class="ttdeci">BOOL TCPStartSSLClient(TCP_SOCKET hTCP, BYTE *host)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l04764">TCP.c:4764</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a6311e407a95b52b825d8f80d123eda7a"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a6311e407a95b52b825d8f80d123eda7a">TCB_STUB::bTimer2Enabled</a></div><div class="ttdeci">unsigned char bTimer2Enabled</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00131">TCP.h:131</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_ae4a588e677cd61e9d1d74d0001c41c42"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#ae4a588e677cd61e9d1d74d0001c41c42">TCB_STUB::bHalfFullFlush</a></div><div class="ttdeci">unsigned char bHalfFullFlush</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00134">TCP.h:134</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_a210df6a3fb94c11b62f4b9ee7e6e72a9"><div class="ttname"><a href="_t_c_p_i_p_8h.html#a210df6a3fb94c11b62f4b9ee7e6e72a9">TCP_ETH_RAM_BASE_ADDRESS</a></div><div class="ttdeci">#define TCP_ETH_RAM_BASE_ADDRESS</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00074">TCPIP.h:74</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_aee1387d217595a005d8b74e262d76db0"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#aee1387d217595a005d8b74e262d76db0">TCB_STUB::bufferRxStart</a></div><div class="ttdeci">PTR_BASE bufferRxStart</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00112">TCP.h:112</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_acf33433ffb49f799001e2c1ccd9494c6"><div class="ttname"><a href="_t_c_p_8c.html#acf33433ffb49f799001e2c1ccd9494c6">TCPGetRxFIFOFree</a></div><div class="ttdeci">WORD TCPGetRxFIFOFree(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01770">TCP.c:1770</a></div></div>
<div class="ttc" id="_t_c_p_i_p_01_e_n_c28_01_d_a210___b_r_d_8h_html_a841035370aaee6b505191c8c2a1da56c"><div class="ttname"><a href="_t_c_p_i_p_01_e_n_c28_01_d_a210___b_r_d_8h.html#a841035370aaee6b505191c8c2a1da56c">TCP_SPI_RAM_BASE_ADDRESS</a></div><div class="ttdeci">#define TCP_SPI_RAM_BASE_ADDRESS</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_01_e_n_c28_01_d_a210___b_r_d_8h_source.html#l00239">TCPIP ENC28 DA210_BRD.h:239</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a9967f98d64d8ef243bd27a487bac4ea9"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a9967f98d64d8ef243bd27a487bac4ea9">TCB_STUB::smState</a></div><div class="ttdeci">TCP_STATE smState</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00125">TCP.h:125</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a820476689281baed6296b78b672c15e5"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a820476689281baed6296b78b672c15e5">TCB_STUB::bServer</a></div><div class="ttdeci">unsigned char bServer</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00129">TCP.h:129</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a5b698e85611a8d3ace1499765a7d2cd7">TCP_FIN_WAIT_1</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00083">TCP.h:83</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a3a6ad6b8f47a63d155c55de2b8588759">TCP_LAST_ACK</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00088">TCP.h:88</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a364093914f3c43521ca04d9b0e5b6a3c"><div class="ttname"><a href="_t_c_p_8c.html#a364093914f3c43521ca04d9b0e5b6a3c">TCPTick</a></div><div class="ttdeci">void TCPTick(void)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l02353">TCP.c:2353</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a1cef416e587e77f9aeda9fbe53edf3ed"><div class="ttname"><a href="_s_s_l_8h.html#a1cef416e587e77f9aeda9fbe53edf3ed">SSLTxRecord</a></div><div class="ttdeci">void SSLTxRecord(TCP_SOCKET hTCP, BYTE sslStubID, BYTE txProtocol)</div></div>
<div class="ttc" id="struct_t_c_b_html_a3f09cd8c9167b802029195c759770966"><div class="ttname"><a href="struct_t_c_b.html#a3f09cd8c9167b802029195c759770966">TCB::dwRemoteHost</a></div><div class="ttdeci">DWORD dwRemoteHost</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00172">TCP.h:172</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a4148c5c9ceb5124ace40386f1cc1ac3caa6f3b90371b211cf68edb9e1b1aa4608"><div class="ttname"><a href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3caa6f3b90371b211cf68edb9e1b1aa4608">SSL_CLIENT_HELLO</a></div><div class="ttdef"><b>Definition:</b> <a href="_s_s_l_8h_source.html#l00091">SSL.h:91</a></div></div>
<div class="ttc" id="union_w_o_r_d___v_a_l_html"><div class="ttname"><a href="union_w_o_r_d___v_a_l.html">WORD_VAL</a></div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00370">GenericTypeDefs.h:370</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a78d22c72df366276a2ed1908e2337093"><div class="ttname"><a href="_t_c_p_8c.html#a78d22c72df366276a2ed1908e2337093">TCPPutROMArray</a></div><div class="ttdeci">WORD TCPPutROMArray(TCP_SOCKET hTCP, ROM BYTE *data, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01351">TCP.c:1351</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a807f78c2939992452223356ae72340cf"><div class="ttname"><a href="struct_t_c_b.html#a807f78c2939992452223356ae72340cf">TCB::retryInterval</a></div><div class="ttdeci">DWORD retryInterval</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00161">TCP.h:161</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a10e1123d9bd8d1d94a6b9e10c2e8176c"><div class="ttname"><a href="_t_c_p_8c.html#a10e1123d9bd8d1d94a6b9e10c2e8176c">TCPIsPutReady</a></div><div class="ttdeci">WORD TCPIsPutReady(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01088">TCP.c:1088</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_ad7a32728d33041b932eab132ddec9a6f"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#ad7a32728d33041b932eab132ddec9a6f">TCB_STUB::OverlappedTimers</a></div><div class="ttdeci">union TCB_STUB::@293 OverlappedTimers</div></div>
<div class="ttc" id="_t_c_p_8c_html_ae0f1ef659a3000449e90a10ffdb816e6"><div class="ttname"><a href="_t_c_p_8c.html#ae0f1ef659a3000449e90a10ffdb816e6">TCPAdjustFIFOSize</a></div><div class="ttdeci">BOOL TCPAdjustFIFOSize(TCP_SOCKET hTCP, WORD wMinRXSize, WORD wMinTXSize, BYTE vFlags)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l04349">TCP.c:4349</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a01c3ec541c50e1d0422f8b6e26e8a25b"><div class="ttname"><a href="_t_c_p_8c.html#a01c3ec541c50e1d0422f8b6e26e8a25b">TCPFlush</a></div><div class="ttdeci">void TCPFlush(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01046">TCP.c:1046</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_adec02cc1509ee936b96812db8c714fc7"><div class="ttname"><a href="_t_c_p_8c.html#adec02cc1509ee936b96812db8c714fc7">TCPSSLHandshakeComplete</a></div><div class="ttdeci">void TCPSSLHandshakeComplete(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05112">TCP.c:5112</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a3aab79449aba751f5d05914000b1839d"><div class="ttname"><a href="_t_c_p_8c.html#a3aab79449aba751f5d05914000b1839d">TCPDiscard</a></div><div class="ttdeci">void TCPDiscard(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l01576">TCP.c:1576</a></div></div>
<div class="ttc" id="struct_t_c_p___h_e_a_d_e_r_html_a85011e0b7801556de62f34a465135806"><div class="ttname"><a href="struct_t_c_p___h_e_a_d_e_r.html#a85011e0b7801556de62f34a465135806">TCP_HEADER::Checksum</a></div><div class="ttdeci">WORD Checksum</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00173">TCP.c:173</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a4148c5c9ceb5124ace40386f1cc1ac3ca1d5e4083969a5ab893f0405a6a51770d"><div class="ttname"><a href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3ca1d5e4083969a5ab893f0405a6a51770d">SSL_ALERT_CLOSE_NOTIFY</a></div><div class="ttdef"><b>Definition:</b> <a href="_s_s_l_8h_source.html#l00100">SSL.h:100</a></div></div>
<div class="ttc" id="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h_html_a8e5ea682fe826546a050c00665a5061a"><div class="ttname"><a href="_t_c_p_i_p_01_e_n_c624_01ds_p_i_c33_e___s_k_8h.html#a8e5ea682fe826546a050c00665a5061a">TCPSocketInitializer</a></div><div class="ttdeci">ROM struct @560 TCPSocketInitializer[]</div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47a933278d61163fd5e5ec2060a1384ef95">TCP_SYN_RECEIVED</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00081">TCP.h:81</a></div></div>
<div class="ttc" id="struct_a_r_c_f_o_u_r___c_t_x_html"><div class="ttname"><a href="struct_a_r_c_f_o_u_r___c_t_x.html">ARCFOUR_CTX</a></div><div class="ttdef"><b>Definition:</b> <a href="_a_r_c_f_o_u_r_8h_source.html#l00063">ARCFOUR.h:63</a></div></div>
<div class="ttc" id="_s_p_i_r_a_m_8h_html_a31bee30d447bb33488f856251ac4c51f"><div class="ttname"><a href="_s_p_i_r_a_m_8h.html#a31bee30d447bb33488f856251ac4c51f">SPIRAMGetArray</a></div><div class="ttdeci">#define SPIRAMGetArray(a, b, c)</div><div class="ttdef"><b>Definition:</b> <a href="_s_p_i_r_a_m_8h_source.html#l00088">SPIRAM.h:88</a></div></div>
<div class="ttc" id="struct_t_c_b_html_aa316e3d5bcdbc999280ce3bb80ef116e"><div class="ttname"><a href="struct_t_c_b.html#aa316e3d5bcdbc999280ce3bb80ef116e">TCB::remotePort</a></div><div class="ttdeci">WORD_VAL remotePort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00165">TCP.h:165</a></div></div>
<div class="ttc" id="_helpers_8h_html_aa96b3af9ccf2d7d2a4558708b90981cd"><div class="ttname"><a href="_helpers_8h.html#aa96b3af9ccf2d7d2a4558708b90981cd">LFSRRand</a></div><div class="ttdeci">WORD LFSRRand(void)</div><div class="ttdef"><b>Definition:</b> <a href="_helpers_8c_source.html#l00158">Helpers.c:158</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a87a779bb5e5f2c7ffc444f52d696efa2"><div class="ttname"><a href="_m_a_c_8h.html#a87a779bb5e5f2c7ffc444f52d696efa2">MACPutArray</a></div><div class="ttdeci">void MACPutArray(BYTE *val, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l01419">ENC28J60.c:1419</a></div></div>
<div class="ttc" id="struct___p_s_e_u_d_o___h_e_a_d_e_r_html_a3116a419f3c363294726255181ca77c7"><div class="ttname"><a href="struct___p_s_e_u_d_o___h_e_a_d_e_r.html#a3116a419f3c363294726255181ca77c7">_PSEUDO_HEADER::DestAddress</a></div><div class="ttdeci">IP_ADDR DestAddress</div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8h_source.html#l00083">IP.h:83</a></div></div>
<div class="ttc" id="struct_t_c_p___s_y_n___q_u_e_u_e_html_ad129842efc936a38e329384496850daf"><div class="ttname"><a href="struct_t_c_p___s_y_n___q_u_e_u_e.html#ad129842efc936a38e329384496850daf">TCP_SYN_QUEUE::wSourcePort</a></div><div class="ttdeci">WORD wSourcePort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00194">TCP.c:194</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a00a53181aee4d79828ae8e52c06a7787"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a00a53181aee4d79828ae8e52c06a7787">TCB_STUB::bTXASAPWithoutTimerReset</a></div><div class="ttdeci">unsigned char bTXASAPWithoutTimerReset</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00136">TCP.h:136</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a3bf31b0f800d38012b3d40e51af0ed80"><div class="ttname"><a href="struct_t_c_b.html#a3bf31b0f800d38012b3d40e51af0ed80">TCB::localSSLPort</a></div><div class="ttdeci">WORD_VAL localSSLPort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00186">TCP.h:186</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_adbf3a5a42e98b90ba8a87652e0b9099e"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#adbf3a5a42e98b90ba8a87652e0b9099e">TCB_STUB::closeWaitTime</a></div><div class="ttdeci">WORD closeWaitTime</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00123">TCP.h:123</a></div></div>
<div class="ttc" id="struct_t_c_b___s_t_u_b_html_a7a9b92a361730134e5545c4b08362dc9"><div class="ttname"><a href="struct_t_c_b___s_t_u_b.html#a7a9b92a361730134e5545c4b08362dc9">TCB_STUB::remoteHash</a></div><div class="ttdeci">WORD_VAL remoteHash</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00142">TCP.h:142</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a343884e48d9a59f81266a9e5cd1cb0b2"><div class="ttname"><a href="struct_t_c_b.html#a343884e48d9a59f81266a9e5cd1cb0b2">TCB::sHoleSize</a></div><div class="ttdeci">SHORT sHoleSize</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00174">TCP.h:174</a></div></div>
<div class="ttc" id="_i_p_8h_html_ad3bcc7a7c328bc6435c97646a25d21f0"><div class="ttname"><a href="_i_p_8h.html#ad3bcc7a7c328bc6435c97646a25d21f0">IPPutHeader</a></div><div class="ttdeci">WORD IPPutHeader(NODE_INFO *remote, BYTE protocol, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_i_p_8c_source.html#l00252">IP.c:252</a></div></div>
<div class="ttc" id="_s_s_l_8h_html_a5efb945b370a663ad5e0b882ff1c878f"><div class="ttname"><a href="_s_s_l_8h.html#a5efb945b370a663ad5e0b882ff1c878f">SSLRxRecord</a></div><div class="ttdeci">WORD SSLRxRecord(TCP_SOCKET hTCP, BYTE sslStubID)</div></div>
<div class="ttc" id="_s_s_l_8h_html_a4148c5c9ceb5124ace40386f1cc1ac3ca8a70b1ac06fee60fd90c439252ff229d"><div class="ttname"><a href="_s_s_l_8h.html#a4148c5c9ceb5124ace40386f1cc1ac3ca8a70b1ac06fee60fd90c439252ff229d">SSL_NO_MESSAGE</a></div><div class="ttdef"><b>Definition:</b> <a href="_s_s_l_8h_source.html#l00106">SSL.h:106</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_a2b0e863dadf920709ec53d9088ee7c91"><div class="ttname"><a href="_generic_type_defs_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a></div><div class="ttdeci">unsigned short int WORD</div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00343">GenericTypeDefs.h:343</a></div></div>
<div class="ttc" id="_a_r_c_f_o_u_r_8h_html_a396caa5732461f89a22534ca087e9002"><div class="ttname"><a href="_a_r_c_f_o_u_r_8h.html#a396caa5732461f89a22534ca087e9002">ARCFOURCrypt</a></div><div class="ttdeci">void ARCFOURCrypt(ARCFOUR_CTX *ctx, BYTE *data, WORD len)</div><div class="ttdef"><b>Definition:</b> <a href="_a_r_c_f_o_u_r_8c_source.html#l00152">ARCFOUR.c:152</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_aacb150778e6f5cf748b05b0e0568f30e"><div class="ttname"><a href="_t_c_p_8c.html#aacb150778e6f5cf748b05b0e0568f30e">TCPDisconnect</a></div><div class="ttdeci">void TCPDisconnect(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00829">TCP.c:829</a></div></div>
<div class="ttc" id="struct_t_c_p___s_y_n___q_u_e_u_e_html_a4a73e1502cba148db181af196cdf145a"><div class="ttname"><a href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a4a73e1502cba148db181af196cdf145a">TCP_SYN_QUEUE::wDestPort</a></div><div class="ttdeci">WORD wDestPort</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00196">TCP.c:196</a></div></div>
<div class="ttc" id="struct_t_c_p___s_y_n___q_u_e_u_e_html_a86fb1c2f41cbd3136de2afa6497925f2"><div class="ttname"><a href="struct_t_c_p___s_y_n___q_u_e_u_e.html#a86fb1c2f41cbd3136de2afa6497925f2">TCP_SYN_QUEUE::niSourceAddress</a></div><div class="ttdeci">NODE_INFO niSourceAddress</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l00193">TCP.c:193</a></div></div>
<div class="ttc" id="_t_c_p_8h_html_a9f513bc8ffaa5ca624acb2a33da18c47af36788cc35b87e60aad61c78a8af296e"><div class="ttname"><a href="_t_c_p_8h.html#a9f513bc8ffaa5ca624acb2a33da18c47af36788cc35b87e60aad61c78a8af296e">TCP_CLOSED_BUT_RESERVED</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00091">TCP.h:91</a></div></div>
<div class="ttc" id="_tick_8h_html_a8f71f847e48f802c831fb86c7fb8326a"><div class="ttname"><a href="_tick_8h.html#a8f71f847e48f802c831fb86c7fb8326a">TickGetDiv256</a></div><div class="ttdeci">DWORD TickGetDiv256(void)</div><div class="ttdef"><b>Definition:</b> <a href="_tick_8c_source.html#l00306">Tick.c:306</a></div></div>
<div class="ttc" id="_primitive_8h_html_a1c10ed14df5c73a75600b57743a24f38"><div class="ttname"><a href="_primitive_8h.html#a1c10ed14df5c73a75600b57743a24f38">__attribute__</a></div><div class="ttdeci">GFX_RESOURCE TYPE_MEMORY __attribute__((deprecated))</div><div class="ttdef"><b>Definition:</b> <a href="_primitive_8h_source.html#l00484">Primitive.h:484</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_ad342ac907eb044443153a22f964bf0af"><div class="ttname"><a href="_generic_type_defs_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a></div><div class="ttdeci">unsigned long DWORD</div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00344">GenericTypeDefs.h:344</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_ac286b416939941cfc8ae4212a92e16e4"><div class="ttname"><a href="_t_c_p_i_p_8h.html#ac286b416939941cfc8ae4212a92e16e4">TCP_PIC_RAM_SIZE</a></div><div class="ttdeci">#define TCP_PIC_RAM_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00208">TCPIP.h:208</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_a9be64cc028f6aef8bc603abb10073639"><div class="ttname"><a href="_t_c_p_8c.html#a9be64cc028f6aef8bc603abb10073639">TCPStartSSLServer</a></div><div class="ttdeci">BOOL TCPStartSSLServer(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l04886">TCP.c:4886</a></div></div>
<div class="ttc" id="_generic_type_defs_8h_html_a73a5fec9b19159a6647fbf000017b221"><div class="ttname"><a href="_generic_type_defs_8h.html#a73a5fec9b19159a6647fbf000017b221">LONG</a></div><div class="ttdeci">signed long LONG</div><div class="ttdef"><b>Definition:</b> <a href="_generic_type_defs_8h_source.html#l00350">GenericTypeDefs.h:350</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_abe7ba29a2e4d1993e906baa1c8eee785"><div class="ttname"><a href="_t_c_p_8c.html#abe7ba29a2e4d1993e906baa1c8eee785">TCPSSLIsHandshaking</a></div><div class="ttdeci">BOOL TCPSSLIsHandshaking(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05037">TCP.c:5037</a></div></div>
<div class="ttc" id="_t_c_p_i_p_8h_html_a14d76c6ef5cd97ad5de2b01c9cc7b3f4"><div class="ttname"><a href="_t_c_p_i_p_8h.html#a14d76c6ef5cd97ad5de2b01c9cc7b3f4">TCP_PIC_RAM_BASE_ADDRESS</a></div><div class="ttdeci">#define TCP_PIC_RAM_BASE_ADDRESS</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_i_p_8h_source.html#l00078">TCPIP.h:78</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a6f0a2614cde1253e6edcc78d1a069b79"><div class="ttname"><a href="_m_a_c_8h.html#a6f0a2614cde1253e6edcc78d1a069b79">MACDiscardRx</a></div><div class="ttdeci">void MACDiscardRx(void)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l00445">ENC28J60.c:445</a></div></div>
<div class="ttc" id="struct_t_c_b_html_a22ffb6306d775b5180f9d9691240df08"><div class="ttname"><a href="struct_t_c_b.html#a22ffb6306d775b5180f9d9691240df08">TCB::bRXNoneACKed2</a></div><div class="ttdeci">unsigned char bRXNoneACKed2</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8h_source.html#l00181">TCP.h:181</a></div></div>
<div class="ttc" id="_m_a_c_8h_html_a76abcd85736be75ac9dee35b573bb90d"><div class="ttname"><a href="_m_a_c_8h.html#a76abcd85736be75ac9dee35b573bb90d">MACSetWritePtr</a></div><div class="ttdeci">PTR_BASE MACSetWritePtr(PTR_BASE address)</div><div class="ttdef"><b>Definition:</b> <a href="_e_n_c28_j60_8c_source.html#l00830">ENC28J60.c:830</a></div></div>
<div class="ttc" id="_t_c_p_8c_html_af62b584e06310e5a763cd87ff3c5c7ae"><div class="ttname"><a href="_t_c_p_8c.html#af62b584e06310e5a763cd87ff3c5c7ae">TCPSSLGetPendingTxSize</a></div><div class="ttdeci">WORD TCPSSLGetPendingTxSize(TCP_SOCKET hTCP)</div><div class="ttdef"><b>Definition:</b> <a href="_t_c_p_8c_source.html#l05419">TCP.c:5419</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_bf0358f4e5621961cbeb32b415922792.html">School</a></li><li class="navelem"><a class="el" href="dir_a56df452fd7dbcffd543f2c29997c5b0.html">SeniorProject</a></li><li class="navelem"><a class="el" href="dir_cb3d5849c826c1a52ebe828f18b7b7c3.html">EthKitTCP</a></li><li class="navelem"><a class="el" href="dir_75a0e0ee32de9d5f6d78f757d89d8692.html">Microchip</a></li><li class="navelem"><a class="el" href="dir_231507324cfe867b6a06a7501b361335.html">TCPIP Stack</a></li><li class="navelem"><a class="el" href="_t_c_p_8c.html">TCP.c</a></li>
    <li class="footer">Generated on Thu May 7 2015 20:33:38 for EthKitTCP by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
